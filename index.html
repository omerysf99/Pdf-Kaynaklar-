<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoTube Pro - Persistent Storage</title>
    <style>
        :root { --primary: #ff0000; --bg: #f9f9f9; --card: #fff; --text: #0f0f0f; }
        body { font-family: 'Roboto', sans-serif; margin: 0; background: var(--bg); color: var(--text); }
        
        /* Header */
        header { 
            background: var(--card); padding: 10px 5%; display: flex; 
            justify-content: space-between; align-items: center; 
            position: sticky; top: 0; z-index: 1000; box-shadow: 0 1px 10px rgba(0,0,0,0.1); 
        }
        .logo { color: var(--primary); font-size: 22px; font-weight: 900; text-decoration: none; }
        
        /* Layout */
        .container { display: grid; grid-template-columns: 1fr 380px; gap: 20px; padding: 20px 5%; max-width: 1600px; margin: auto; }
        
        /* Video Player Area */
        .player-section video { width: 100%; border-radius: 12px; background: #000; aspect-ratio: 16/9; }
        .video-meta { padding: 15px 0; border-bottom: 1px solid #e5e5e5; }
        
        /* Upload Area */
        .upload-card { 
            background: var(--card); border: 2px dashed #ccc; border-radius: 12px; 
            padding: 30px; text-align: center; margin-bottom: 20px; transition: 0.3s;
        }
        .upload-card:hover { border-color: var(--primary); }
        .upload-input { display: none; }
        .upload-label { cursor: pointer; color: var(--primary); font-weight: bold; }

        /* Video Grid / List */
        .video-list { display: flex; flex-direction: column; gap: 15px; }
        .video-item { 
            display: flex; gap: 12px; cursor: pointer; background: var(--card); 
            padding: 8px; border-radius: 8px; transition: 0.2s;
        }
        .video-item:hover { background: #f0f0f0; }
        .video-item .thumb-container { position: relative; width: 160px; height: 90px; flex-shrink: 0; }
        .video-item img { width: 100%; height: 100%; border-radius: 6px; object-fit: cover; background: #eee; }
        .video-item .info h4 { margin: 0 0 5px 0; font-size: 14px; line-height: 1.2; }
        .video-item .info p { margin: 0; font-size: 12px; color: #606060; }

        /* Status Indicator */
        #status { font-size: 12px; color: green; margin-top: 5px; }

        @media (max-width: 1000px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<header>
    <a href="#" class="logo">VideoTube DB</a>
    <div style="font-size: 12px;">Admin ID: 8392479231 | <span id="db-status">DB Bağlanıyor...</span></div>
</header>

<div class="container">
    <main>
        <div class="upload-card">
            <h3 style="margin-top:0">Yeni Video Yükle</h3>
            <p>Videolar tarayıcı veritabanına (IndexedDB) kalıcı olarak kaydedilir.</p>
            <label class="upload-label" for="videoFile">VİDEO SEÇ</label>
            <input type="file" id="videoFile" class="upload-input" accept="video/*">
            <div id="status"></div>
        </div>

        <div class="player-section">
            <video id="mainPlayer" controls autoplay></video>
            <div class="video-meta">
                <h1 id="mainTitle">Video Seçin veya Yükleyin</h1>
                <p id="mainDesc">Açıklama: IndexedDB kalıcı depolama aktif.</p>
            </div>
        </div>
    </main>

    <aside>
        <h3 style="margin-top:0">Kütüphaneniz (Kalıcı)</h3>
        <div id="videoLibrary" class="video-list">
            </div>
    </aside>
</div>

<script>
    /** * MİMARİ: IndexedDB Yönetimi
     */
    const DB_NAME = 'VideoPlatformDB';
    const DB_VERSION = 1;
    let db;

    // 1. Veritabanını Başlat
    const request = indexedDB.open(DB_NAME, DB_VERSION);

    request.onupgradeneeded = (e) => {
        db = e.target.result;
        if (!db.objectStoreNames.contains('videos')) {
            const store = db.createObjectStore('videos', { keyPath: 'id' });
            store.createIndex('createdAt', 'createdAt', { unique: false });
        }
    };

    request.onsuccess = (e) => {
        db = e.target.result;
        document.getElementById('db-status').textContent = "DB Bağlı (Kalıcı)";
        loadVideosFromDB(); // Sayfa açılışında yükle
    };

    request.onerror = () => {
        alert("IndexedDB erişim hatası! Lütfen gizli sekmeyi kapatın veya izin verin.");
    };

    /**
     * 2. Video İşleme ve Kaydetme
     */
    const videoInput = document.getElementById('videoFile');
    const statusText = document.getElementById('status');

    videoInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        statusText.textContent = "İşleniyor: Thumbnail oluşturuluyor ve DB'ye yazılıyor...";
        
        try {
            const thumbnailBlob = await generateThumbnail(file);
            const videoData = {
                id: crypto.randomUUID(),
                title: file.name,
                description: "Kullanıcı tarafından yüklendi.",
                videoBlob: file, // Gerçek dosya verisi
                thumbnailBlob: thumbnailBlob,
                createdAt: Date.now(),
                type: file.size > 50000000 ? 'long' : 'shorts' // Basit mantık
            };

            const tx = db.transaction('videos', 'readwrite');
            const store = tx.objectStore('videos');
            await store.add(videoData);

            tx.oncomplete = () => {
                statusText.textContent = "✅ Başarıyla kaydedildi!";
                loadVideosFromDB(); // Listeyi güncelle
            };
        } catch (err) {
            console.error(err);
            statusText.textContent = "❌ Hata oluştu!";
        }
    });

    // Thumbnail Oluşturucu (Canvas)
    function generateThumbnail(file) {
        return new Promise((resolve) => {
            const video = document.createElement('video');
            const canvas = document.createElement('canvas');
            video.src = URL.createObjectURL(file);
            video.load();
            video.onloadeddata = () => {
                video.currentTime = 1; // 1. saniyeden kare al
            };
            video.onseeked = () => {
                canvas.width = 320;
                canvas.height = 180;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                canvas.toBlob((blob) => {
                    URL.revokeObjectURL(video.src);
                    resolve(blob);
                }, 'image/jpeg', 0.7);
            };
        });
    }

    /**
     * 3. Veriyi Çekme ve Render (Persistence)
     */
    let activeObjectURLs = [];

    async function loadVideosFromDB() {
        const library = document.getElementById('videoLibrary');
        library.innerHTML = ''; // Temizle

        // Bellek sızıntısını önlemek için eski URL'leri iptal et
        activeObjectURLs.forEach(url => URL.revokeObjectURL(url));
        activeObjectURLs = [];

        const tx = db.transaction('videos', 'readonly');
        const store = tx.objectStore('videos');
        const request = store.getAll();

        request.onsuccess = () => {
            const videos = request.result.sort((a,b) => b.createdAt - a.createdAt);
            
            videos.forEach(vid => {
                // Blob'lardan yeni oturum URL'leri türet
                const vUrl = URL.createObjectURL(vid.videoBlob);
                const tUrl = URL.createObjectURL(vid.thumbnailBlob);
                activeObjectURLs.push(vUrl, tUrl);

                const item = document.createElement('div');
                item.className = 'video-item';
                item.innerHTML = `
                    <div class="thumb-container">
                        <img src="${tUrl}" alt="thumb">
                    </div>
                    <div class="info">
                        <h4>${vid.title}</h4>
                        <p>${new Date(vid.createdAt).toLocaleDateString()}</p>
                    </div>
                `;
                item.onclick = () => playVideo(vUrl, vid.title);
                library.appendChild(item);
            });

            // Eğer video varsa ilkini oynatıcıya koy (Opsiyonel)
            if(videos.length > 0 && !document.getElementById('mainPlayer').src) {
                const first = videos[0];
                playVideo(URL.createObjectURL(first.videoBlob), first.title);
            }
        };
    }

    function playVideo(url, title) {
        const player = document.getElementById('mainPlayer');
        document.getElementById('mainTitle').textContent = title;
        player.src = url;
        player.play();
    }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SpyderCoin - Admin Pro</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://adexora.com/cdn/ads.js?id=1545"></script>

    <style>
        :root { --p-purple: #a855f7; --bg: #000; --card: #0f0f12; --text: #fff; --dim: #71717a; --green: #10b981; --red: #ef4444; --gold: #fbbf24; --border: #1a1a1f; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        #loader { position: fixed; inset: 0; background: #000; z-index: 15000; display: flex; align-items: center; justify-content: center; }
        main { flex: 1; overflow-y: auto; padding-bottom: 90px; }
        .view { display: none; padding: 15px; flex-direction: column; animation: fadeIn 0.2s ease; }
        .view.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 15px; margin-bottom: 12px; }
        .btn-main { width: 100%; padding: 14px; border-radius: 12px; border: none; background: var(--p-purple); color: #fff; font-weight: bold; cursor: pointer; }

        /* --- YENÄ° ADMÄ°N STÄ°LLERÄ° --- */
        .admin-stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: #15151a; padding: 15px; border-radius: 12px; border: 1px solid var(--border); text-align: center; }
        .stat-box small { color: var(--dim); font-size: 10px; text-transform: uppercase; }
        .stat-box div { font-size: 18px; font-weight: bold; color: var(--p-purple); }

        .user-list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #0f0f12; border-bottom: 1px solid #1a1a1f; cursor: pointer; transition: 0.2s; }
        .user-list-item:active { background: #1a1a1f; }
        .user-list-item b { font-size: 14px; }
        .user-list-item i { color: var(--dim); font-size: 12px; }

        /* MODAL (Detay Penceresi) */
        #user-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 20000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card); border: 1px solid var(--p-purple); width: 100%; max-width: 400px; border-radius: 20px; padding: 20px; position: relative; }
        .close-modal { position: absolute; top: 15px; right: 15px; font-size: 24px; color: var(--dim); }
        .detail-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #1a1a1f; font-size: 13px; }
        .detail-row span { color: var(--dim); }
        .detail-row b { color: #fff; }

        nav { position: fixed; bottom: 0; width: 100%; height: 75px; background: #050505; display: flex; border-top: 1px solid var(--border); z-index: 1000; }
        .n-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--dim); }
        .n-item.active { color: var(--p-purple); }
        .n-item i { font-size: 20px; font-style: normal; }
        .n-item span { font-size: 10px; }
    </style>
</head>
<body>

    <div id="loader"><b>YÃœKLENÄ°YOR...</b></div>

    <div id="user-modal">
        <div class="modal-content">
            <span class="close-modal" onclick="Admin.closeDetail()">Ã—</span>
            <h3 id="m-name" style="margin-bottom: 20px; color: var(--p-purple);">KullanÄ±cÄ± DetayÄ±</h3>
            <div id="m-details"></div>
            <button class="btn-main" style="margin-top: 20px; background: var(--red);" onclick="Admin.toggleBan()">BANLA / KALDIR</button>
        </div>
    </div>

    <main>
        <section id="v-play" class="view active"><div class="bal-txt" id="ui-bal">0</div><div class="spyder-btn" onclick="App.tap()"><span>ğŸ•·ï¸</span></div></section>
        
        <section id="v-admin" class="view">
            <h2 style="margin-bottom: 15px;">YÃ¶netim Paneli</h2>
            
            <div class="admin-stat-grid">
                <div class="stat-box"><small>Toplam Ãœye</small><div id="stat-total-users">0</div></div>
                <div class="stat-box"><small>Top. Reklam</small><div id="stat-total-ads">0</div></div>
            </div>

            <h4 style="margin: 10px 0; color: var(--gold);">ğŸ’° Bekleyen Talepler</h4>
            <div id="admin-requests" style="margin-bottom: 20px;"></div>

            <h4 style="margin: 10px 0;">ğŸ‘¥ Ãœye Listesi (Detay iÃ§in tÄ±kla)</h4>
            <div class="card" style="padding:0; overflow:hidden;" id="admin-user-list">
                </div>
        </section>
    </main>

    <nav id="main-nav">
        <div class="n-item active" onclick="nav('v-play', this)"><i>ğŸ®</i><span>Oyna</span></div>
        <div class="n-item" onclick="nav('v-admin', this); Admin.load();"><i>ğŸ”‘</i><span>Admin</span></div>
    </nav>

    <script>
        // Firebase & Temel DeÄŸiÅŸkenler (Ã–nceki kodlarla aynÄ±)
        const ADMIN_ID = "8392479231";
        const firebaseConfig = { apiKey: "AIzaSyC18uinYQT9vOC-nhxv3x1WIhO_we3CRMY", authDomain: "pdfkaynak-51615.firebaseapp.com", projectId: "pdfkaynak-51615", appId: "1:228512804576:web:a0bba02ca83b4fa7adea85" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const tg = window.Telegram.WebApp;

        let selectedUser = null; // DetayÄ±na bakÄ±lan kullanÄ±cÄ±

        const Admin = {
            load: async () => {
                const userSnap = await db.collection("users").get();
                let totalAds = 0;
                const listDiv = document.getElementById('admin-user-list');
                listDiv.innerHTML = "";

                userSnap.forEach(doc => {
                    const d = doc.data();
                    totalAds += (d.totalAds || 0);

                    // Liste Ã¶ÄŸesini oluÅŸtur (Sadece Ä°sim)
                    const item = document.createElement('div');
                    item.className = 'user-list-item';
                    item.innerHTML = `<b>${d.name || 'Bilinmiyor'}</b> <i>@${d.username || 'n/a'} ></i>`;
                    item.onclick = () => Admin.openDetail(doc.id, d);
                    listDiv.appendChild(item);
                });

                document.getElementById('stat-total-users').innerText = userSnap.size;
                document.getElementById('stat-total-ads').innerText = totalAds.toLocaleString();
                
                // Talepleri yÃ¼kle (Ã–nceki kodlardaki aynÄ± mantÄ±k)
                Admin.loadRequests();
            },

            loadRequests: async () => {
                const reqSnap = await db.collection("withdrawals").where("status","==","pending").get();
                const reqDiv = document.getElementById('admin-requests');
                reqDiv.innerHTML = reqSnap.empty ? '<small style="color:var(--dim)">Talep yok.</small>' : "";
                reqSnap.forEach(doc => {
                    const r = doc.data();
                    reqDiv.innerHTML += `<div class="card" style="font-size:12px;">${r.name}: <b>$${r.amount}</b><br><button onclick="Admin.complete('${doc.id}','${r.uid}')" style="background:var(--green); border:none; color:#fff; padding:4px 8px; border-radius:4px; margin-top:5px;">Ã–DENDÄ°</button></div>`;
                });
            },

            openDetail: (id, data) => {
                selectedUser = { id, ...data };
                document.getElementById('m-name').innerText = data.name;
                document.getElementById('m-details').innerHTML = `
                    <div class="detail-row"><span>KullanÄ±cÄ± AdÄ±:</span> <b>@${data.username}</b></div>
                    <div class="detail-row"><span>Spyder Bal:</span> <b>${(data.bal||0).toLocaleString()}</b></div>
                    <div class="detail-row"><span>USDT Bakiye:</span> <b style="color:var(--green)">$${(data.usdt||0).toFixed(2)}</b></div>
                    <div class="detail-row"><span>Ä°zlenen Reklam:</span> <b>${data.totalAds || 0}</b></div>
                    <div class="detail-row"><span>Tamamlanan GÃ¶rev:</span> <b>${(data.tasks||[]).length}</b></div>
                    <div class="detail-row"><span>ID:</span> <b>${id}</b></div>
                    <div class="detail-row"><span>Durum:</span> <b style="color:${data.isBanned ? 'var(--red)':'var(--green)'}">${data.isBanned ? 'BANLI':'AKTÄ°F'}</b></div>
                `;
                document.getElementById('user-modal').style.display = 'flex';
            },

            closeDetail: () => { document.getElementById('user-modal').style.display = 'none'; },

            toggleBan: async () => {
                if(!selectedUser) return;
                const newStatus = !selectedUser.isBanned;
                await db.collection("users").doc(selectedUser.id).update({ isBanned: newStatus });
                tg.showAlert(newStatus ? "KullanÄ±cÄ± BanlandÄ±" : "Ban KaldÄ±rÄ±ldÄ±");
                Admin.closeDetail();
                Admin.load();
            },

            complete: async (id, uid) => {
                await db.collection("withdrawals").doc(id).update({status:"completed"});
                await db.collection("users").doc(uid).update({ paymentNotif: true });
                Admin.load();
            }
        };

        // UI ve App fonksiyonlarÄ± Ã¶ncekiyle aynÄ± ÅŸekilde kalacak...
        const App = { init: async () => { /* ... */ } };
        // ... (DiÄŸer fonksiyonlar: nav, UI.refresh, Finance vs.)
        
        App.init();
    </script>
</body>
</html>

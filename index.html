// --- SLOT MATEMATÄ°ÄÄ° GÃœNCELLEMESÄ° ---
const slotConfig = [
    { emoji: "ğŸ’", prize: 0.12, chance: 1 },    // %1
    { emoji: "ğŸ‹", prize: 0.03, chance: 4 },    // %4
    { emoji: "ğŸ’", prize: 0.87, chance: 0.01 }, // %0.01
    { emoji: "7ï¸âƒ£", prize: 0.55, chance: 0.05 }, // %0.05
    { emoji: "ğŸ””", prize: 0.009, chance: 20 }   // %20
];

// Toplam olasÄ±lÄ±k dÄ±ÅŸÄ±ndaki kalan %74.94 "Kaybetme/KarÄ±ÅŸÄ±k" durumu iÃ§in otomatik yÃ¶netilir.

async function spinSlot() {
    if(userBal < 1) { showToast("Yetersiz Jeton!", "error"); return; }
    
    // 1 Jeton DÃ¼ÅŸ
    await db.collection("users").doc(String(user.id)).set({ 
        balance: firebase.firestore.FieldValue.increment(-1) 
    }, { merge: true });

    const reels = document.querySelectorAll('.reel');
    const interval = setInterval(() => {
        reels.forEach(r => r.innerText = slotConfig[Math.floor(Math.random() * slotConfig.length)].emoji);
    }, 100);

    setTimeout(async () => {
        clearInterval(interval);
        
        let finalEmojis = [];
        const rand = Math.random() * 100; // 0-100 arasÄ± sayÄ± Ã¼ret
        let cumulative = 0;
        let winSymbol = null;

        // KazanÃ§ kontrolÃ¼ (Senin olasÄ±lÄ±klarÄ±na gÃ¶re)
        for (let item of slotConfig) {
            cumulative += item.chance;
            if (rand < cumulative) {
                winSymbol = item;
                break;
            }
        }

        if (winSymbol) {
            // KAZANMA DURUMU: 3 top aynÄ± gelir
            finalEmojis = [winSymbol.emoji, winSymbol.emoji, winSymbol.emoji];
            reels.forEach((r, i) => r.innerText = finalEmojis[i]);
            
            showToast(`Tebrikler! ${winSymbol.emoji} geldi: $${winSymbol.prize}`, "success");
            await db.collection("users").doc(String(user.id)).set({ 
                usdt: firebase.firestore.FieldValue.increment(winSymbol.prize) 
            }, { merge: true });
        } else {
            // KAYBETME DURUMU (%74.94 ve diÄŸerleri): KarÄ±ÅŸÄ±k emojiler
            // En az biri farklÄ± olacak ÅŸekilde rastgele daÄŸÄ±t
            finalEmojis = [
                slotConfig[Math.floor(Math.random() * slotConfig.length)].emoji,
                slotConfig[Math.floor(Math.random() * slotConfig.length)].emoji,
                slotConfig[Math.floor(Math.random() * slotConfig.length)].emoji
            ];
            // EÄŸer ÅŸans eseri hepsi aynÄ± gelirse (kaybetme modundayken), birini zorla deÄŸiÅŸtir
            if(finalEmojis[0] === finalEmojis[1] && finalEmojis[1] === finalEmojis[2]) {
                finalEmojis[0] = finalEmojis[0] === "ğŸ’" ? "ğŸ””" : "ğŸ’";
            }
            reels.forEach((r, i) => r.innerText = finalEmojis[i]);
            showToast("ÅansÄ±nÄ± tekrar dene!", "error");
        }
    }, 1000);
}

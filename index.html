<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SpyderCoin - Admin Pro</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://adexora.com/cdn/ads.js?id=1545"></script>

    <style>
        :root { --main-yellow: #ffeb3b; --bg-purple: #1a002e; --card-purple: #2e004f; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: radial-gradient(circle, var(--card-purple) 0%, #000 100%);
            color: var(--main-yellow); font-family: 'Arial Black', sans-serif;
            margin: 0; height: 100vh; display: flex; flex-direction: column;
            align-items: center; overflow: hidden; touch-action: manipulation;
        }

        .header { margin-top: 5vh; flex-shrink: 0; text-align: center; }
        #balance { font-size: 10vw; text-shadow: 0 0 20px #9c27b0; }
        #user-info { font-size: 14px; color: #aaa; margin-top: 5px; }

        .tab-content { 
            display: none; width: 100%; height: 75vh; 
            flex-direction: column; align-items: center; justify-content: flex-start; 
            padding: 20px; overflow-y: auto;
        }
        .active-tab { display: flex; }

        #spider-emoji { 
            font-size: 120px; cursor: pointer; transition: transform 0.1s; 
            user-select: none; filter: drop-shadow(0 0 15px #9c27b0); margin: 20px 0;
        }
        #spider-emoji:active { transform: scale(0.8); }
        
        .energy-wrap { 
            width: 80%; max-width: 300px; height: 25px; background: #222; 
            border: 2px solid var(--main-yellow); border-radius: 20px; 
            position: relative; margin: 10px 0; overflow: hidden;
        }
        #energy-fill { height: 100%; width: 100%; background: var(--main-yellow); transition: width 0.1s; }
        #energy-text { position: absolute; width: 100%; text-align: center; top: 3px; color: #000; font-size: 14px; font-weight: bold; }

        .wallet-card { 
            background: var(--card-purple); padding: 20px; border: 3px solid var(--main-yellow); 
            border-radius: 20px; width: 100%; max-width: 400px; text-align: center; margin-bottom: 20px;
        }
        .wallet-card input { 
            width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; 
            border: none; font-size: 14px; text-align: center;
        }

        .ad-counter-box {
            background: rgba(0,0,0,0.4); padding: 10px; border-radius: 12px;
            margin: 10px 0; border: 1px dashed var(--main-yellow);
        }

        .btn { 
            background: var(--main-yellow); color: #1a002e; border: none; 
            padding: 12px; font-size: 14px; font-weight: bold; 
            border-radius: 12px; cursor: pointer; width: 100%;
        }

        .navbar { 
            position: fixed; bottom: 0; width: 100%; background: #111; 
            border-top: 2px solid var(--main-yellow); display: flex; 
            justify-content: space-around; padding: 10px 0; z-index: 1000;
        }
        .nav-item { cursor: pointer; color: #777; font-size: 10px; display: flex; flex-direction: column; align-items: center; }
        .nav-item.active { color: var(--main-yellow); }

        /* Admin List Style */
        .admin-item { background: #000; padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid var(--main-yellow); text-align: left; font-family: sans-serif; font-size: 12px;}
        .admin-item b { color: var(--main-yellow); }
    </style>
</head>
<body>

    <div class="header">
        <div id="balance">$0.00000</div>
        <div id="user-info">Y√ºkleniyor...</div>
    </div>

    <div id="tab-game" class="tab-content active-tab">
        <div class="energy-wrap">
            <div id="energy-fill"></div>
            <div id="energy-text">1000 / 1000</div>
        </div>
        <div id="spider-emoji" onclick="handleTap()">üï∑Ô∏è</div>
        <button class="btn" style="width: 80%;" onclick="refill()">ENERJƒ∞ DOLDUR (AD)</button>
    </div>

    <div id="tab-tasks" class="tab-content">
        <div class="wallet-card">
            <h3>Telegram Kanalƒ±</h3>
            <p style="color:#00ff00">+0.60 USDT</p>
            <button id="tg-btn" class="btn" style="background:#0088cc; color:white;" onclick="doTelegramTask()">KATIL VE KAZAN</button>
        </div>
    </div>

    <div id="tab-wallet" class="tab-content">
        <div class="wallet-card">
            <h2 style="margin:0">USDT √áEKƒ∞M</h2>
            <div class="ad-counter-box">
                <div style="font-size: 12px; color: #aaa;">Toplam ƒ∞zlenen Reklam</div>
                <div id="total-ads-display" style="font-size: 20px; color: var(--main-yellow);">0</div>
                <div style="font-size: 12px; color: #aaa; margin-top: 5px;">Gereken / Mevcut</div>
                <div id="ads-requirement-status" style="font-size: 15px; color: #00ff00;">0 / 0</div>
            </div>
            <input type="number" id="w-amount" placeholder="Miktar (USDT)" oninput="autoCalc(this.value)">
            <input type="text" id="w-address" placeholder="TRC20 C√ºzdan Adresi">
            <button class="btn" onclick="sendWithdraw()" style="margin-top:10px;">TALEBƒ∞ G√ñNDER</button>
        </div>
    </div>

    <div id="tab-admin" class="tab-content">
        <div class="wallet-card">
            <h2>üõ°Ô∏è Admin Panel</h2>
            <div class="ad-counter-box" style="display: flex; justify-content: space-around; font-size: 11px;">
                <div>Toplam Reklam<br><span id="admin-total-ads" style="color:var(--main-yellow); font-size:16px;">0</span></div>
                <div>Toplam USDT<br><span id="admin-total-usdt" style="color:#00ff00; font-size:16px;">$0.00</span></div>
            </div>
            
            <h3 style="font-size:14px; margin:15px 0 5px 0;">üí∞ Bekleyen Talepler</h3>
            <div id="withdrawal-list"></div>

            <h3 style="font-size:14px; margin:15px 0 5px 0;">üë• T√ºm √úyeler</h3>
            <div id="all-players-list"></div>
            
            <button class="btn" onclick="loadAdminStats()" style="margin-top:15px; background: #444; color: white;">VERƒ∞LERƒ∞ YENƒ∞LE</button>
        </div>
    </div>

    <nav class="navbar">
        <div class="nav-item active" onclick="switchTab('game', this)"><span>üï∑Ô∏è</span>Oyun</div>
        <div class="nav-item" onclick="switchTab('tasks', this)"><span>üìã</span>G√∂revler</div>
        <div class="nav-item" onclick="switchTab('wallet', this)"><span>üëõ</span>C√ºzdan</div>
        <div id="admin-nav" class="nav-item" style="display:none;" onclick="switchTab('admin', this)"><span>üõ°Ô∏è</span>Admin</div>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        const userData = tg.initDataUnsafe.user || { id: "test_user", first_name: "Test", username: "Guest" };
        const userId = userData.id.toString();
        const adminId = "8392479231";
        
        document.getElementById('user-info').innerText = "@" + (userData.username || "misafir");

        const firebaseConfig = {
            apiKey: "AIzaSyDfy6QdIZ0BthEHTmxkw-NAja3B9bFFd8U",
            authDomain: "spydercoin-94f7b.firebaseapp.com",
            projectId: "spydercoin-94f7b",
            storageBucket: "spydercoin-94f7b.firebasestorage.app",
            messagingSenderId: "218267568158",
            appId: "1:218267568158:web:832728845ba0f42202060f"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let money = 0, energy = 1000, adsWatched = 0, tgDone = false, clickCount = 0;

        if (userId === adminId) document.getElementById('admin-nav').style.display = 'flex';

        db.collection("players").doc(userId).onSnapshot(doc => {
            if(doc.exists){
                const d = doc.data();
                money = d.money || 0; energy = d.energy || 1000;
                adsWatched = d.adsWatched || 0; tgDone = d.tgDone || false;
                updateUI();
            } else { save(); }
        });

        function handleTap() {
            if(energy > 0) {
                money += 0.00001; energy--; clickCount++;
                if(clickCount >= 10) { clickCount = 0; adsWatched++; if(window.showAdexora) window.showAdexora().catch(e=>{}); }
                updateUI(); save();
            }
        }

        function refill() {
            window.open("https://adexora.my.id/dl/QFm5mnRYbJV", "_blank");
            energy = 1000; adsWatched++; save();
            if(window.showAdexora) window.showAdexora().catch(e=>{});
        }

        function doTelegramTask() {
            if(tgDone) return;
            tg.openTelegramLink("https://t.me/SpyderCommunity");
            setTimeout(() => { if(!tgDone){ money += 0.60; tgDone = true; save(); } }, 3000);
        }

        function autoCalc(val) {
            const statusBox = document.getElementById('ads-requirement-status');
            const amount = parseFloat(val);
            if (amount >= 0.1) {
                const needed = Math.ceil((amount / 0.5) * 750);
                statusBox.innerText = needed + " / " + adsWatched;
                statusBox.style.color = (adsWatched < needed) ? "#ff4444" : "#00ff00";
            } else { statusBox.innerText = "0 / " + adsWatched; }
        }

        function sendWithdraw() {
            const amt = parseFloat(document.getElementById('w-amount').value);
            const needed = Math.ceil((amt / 0.5) * 750);
            if (amt >= 0.5 && money >= amt && adsWatched >= needed) {
                adsWatched -= needed; money -= amt; save();
                db.collection("withdrawals").add({ 
                    userId, userName: userData.first_name, userAt: userData.username || "N/A",
                    amount: amt, address: document.getElementById('w-address').value, 
                    adsDeducted: needed, date: new Date() 
                }).then(() => tg.showAlert("Talep ƒ∞letildi!"));
            } else { tg.showAlert("≈ûartlar saƒülanamadƒ±!"); }
        }

        async function loadAdminStats() {
            if (userId !== adminId) return;
            const playersSnap = await db.collection("players").get();
            let tAds = 0, tUsdt = 0;
            const pList = document.getElementById('all-players-list');
            pList.innerHTML = "";

            playersSnap.forEach(doc => {
                const p = doc.data();
                tAds += (p.adsWatched || 0);
                tUsdt += (p.money || 0);
                pList.innerHTML += `<div class="admin-item">
                    üë§ <b>${p.first_name || 'Bilinmiyor'}</b> (@${p.username || 'yok'})<br>
                    üí∞ Bakiye: $${(p.money || 0).toFixed(4)} | üì∫ Reklam: ${p.adsWatched || 0}
                </div>`;
            });

            document.getElementById('admin-total-ads').innerText = tAds.toLocaleString();
            document.getElementById('admin-total-usdt').innerText = "$" + tUsdt.toFixed(2);

            const wSnap = await db.collection("withdrawals").orderBy("date", "desc").limit(10).get();
            const wList = document.getElementById('withdrawal-list');
            wList.innerHTML = wSnap.empty ? "Talep yok." : "";
            wSnap.forEach(doc => {
                const w = doc.data();
                wList.innerHTML += `<div class="admin-item" style="border-left-color: #00ff00">
                    <b>@${w.userAt}</b> - $${w.amount}<br>
                    <small>${w.address}</small>
                </div>`;
            });
        }

        function updateUI() {
            document.getElementById('balance').innerText = "$" + money.toFixed(5);
            document.getElementById('energy-fill').style.width = (energy/10) + "%";
            document.getElementById('energy-text').innerText = energy + " / 1000";
            document.getElementById('total-ads-display').innerText = adsWatched;
            autoCalc(document.getElementById('w-amount').value);
            if(tgDone) { document.getElementById('tg-btn').innerText = "TAMAMLANDI ‚úÖ"; document.getElementById('tg-btn').disabled = true; }
        }

        function save() { 
            db.collection("players").doc(userId).set({ 
                money, energy, adsWatched, tgDone, 
                first_name: userData.first_name, 
                username: userData.username || "yok"
            }, {merge:true}); 
        }

        function switchTab(id, el) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active-tab'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('tab-' + id).classList.add('active-tab');
            el.classList.add('active');
            if(id === 'admin') loadAdminStats();
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SpyderCoin - Firebase Realtime Rank</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        :root { --bg: #050505; --purple: #a855f7; --card: #151517; --text: #ffffff; --inactive: #71717a; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; padding: 0; height: 100vh; overflow: hidden; }

        .page { display: none; height: 100vh; flex-direction: column; align-items: center; padding: 20px; box-sizing: border-box; }
        .page.active { display: flex; }

        /* ğŸ•·ï¸ ANA EKRAN */
        .bal-text { font-size: 55px; font-weight: 900; margin-top: 30px; text-shadow: 0 0 20px var(--purple); }
        .tap-zone { position: relative; width: 280px; height: 280px; display: flex; justify-content: center; align-items: center; margin: 30px 0; touch-action: none; }
        .glow { position: absolute; width: 260px; height: 260px; border: 8px solid var(--purple); border-radius: 50%; box-shadow: 0 0 40px var(--purple); }
        #spider-main { width: 190px; z-index: 10; transition: transform 0.05s; }
        
        /* ğŸ† SIRALAMA */
        .rank-list { width: 100%; display: flex; flex-direction: column; gap: 8px; overflow-y: auto; padding-bottom: 100px; }
        .rank-item { background: var(--card); padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #222; }
        .rank-item.me { border: 1px solid var(--purple); background: rgba(168, 85, 247, 0.1); }

        /* ğŸ“± ALT MENÃœ */
        .nav-bar { position: fixed; bottom: 15px; width: 94%; left: 3%; background: rgba(21, 21, 23, 0.95); height: 70px; border-radius: 22px; display: grid; grid-template-columns: repeat(5, 1fr); border: 1px solid #2c2c2e; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; color: var(--inactive); gap: 4px; }
        .nav-item.active { color: var(--purple); font-weight: bold; }
    </style>
</head>
<body>

    <div id="p-play" class="page active">
        <div class="bal-text" id="ui-bal">YÃ¼kleniyor...</div>
        <div class="tap-zone" id="tap-target">
            <div class="glow"></div>
            <img src="https://api.mimic.ai/api/v1/files/image_7ba2e0.png" id="spider-main">
        </div>
        <div style="margin-top:auto; margin-bottom:110px; width:90%;">
            <div style="font-size:12px; margin-bottom:5px;">âš¡ Enerji: <span id="ui-nrg">100</span>/100</div>
            <div style="width:100%; height:8px; background:#111; border-radius:10px; overflow:hidden;">
                <div id="nrg-bar" style="width:100%; height:100%; background:var(--purple); transition:0.3s;"></div>
            </div>
        </div>
    </div>

    <div id="p-league" class="page">
        <h2 style="color:var(--purple)">SÄ±ralama</h2>
        <div class="rank-list" id="rank-container">
            <p style="text-align:center; color:#666;">YÃ¼kleniyor...</p>
        </div>
    </div>

    <div id="p-tasks" class="page"><h2>GÃ¶revler</h2></div>
    <div id="p-friends" class="page"><h2>Dostlar</h2></div>
    <div id="p-wallet" class="page"><h2>CÃ¼zdan</h2></div>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="nav('p-play', this)"><span>ğŸ® Oyna</span></div>
        <div class="nav-item" onclick="nav('p-tasks', this)"><span>ğŸ“‹ GÃ¶rev</span></div>
        <div class="nav-item" onclick="nav('p-friends', this)"><span>ğŸ‘¥ Dost</span></div>
        <div class="nav-item" onclick="nav('p-league', this)"><span>ğŸ† Lig</span></div>
        <div class="nav-item" onclick="nav('p-wallet', this)"><span>ğŸ’° CÃ¼zdan</span></div>
    </nav>

    <script>
        // FIREBASE AYARLARI (Buraya kendi config bilgilerini ekle kral)
        const firebaseConfig = {
            apiKey: "AIzaSy...",
            authDomain: "spyder-coin.firebaseapp.com",
            projectId: "spyder-coin",
            storageBucket: "spyder-coin.appspot.com",
            messagingSenderId: "...",
            appId: "..."
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const tg = window.Telegram.WebApp;
        const user = tg.initDataUnsafe?.user || { id: "test_8392479231", first_name: "Admin" };

        let bal = 0;
        let nrg = 100;

        // ğŸŸ¢ FIREBASE'DEN VERÄ° Ã‡EK VE OTOMATÄ°K KAYDET
        async function init() {
            tg.ready(); tg.expand();
            
            const userRef = db.collection('users').doc(String(user.id));
            const doc = await userRef.get();

            if (!doc.exists) {
                await userRef.set({ name: user.first_name, balance: 0, username: user.username || "" });
            } else {
                bal = doc.data().balance;
            }
            updateUI();
        }

        function updateUI() {
            document.getElementById('ui-bal').innerText = bal.toLocaleString();
            document.getElementById('ui-nrg').innerText = nrg;
            document.getElementById('nrg-bar').style.width = nrg + "%";
        }

        // ğŸ† GERÃ‡EK SIRALAMA MOTORU
        async function getRankings() {
            const container = document.getElementById('rank-container');
            container.innerHTML = "YÃ¼kleniyor...";

            // En yÃ¼ksek 20 kiÅŸiyi getir
            const snapshot = await db.collection('users').orderBy('balance', 'desc').limit(20).get();
            
            container.innerHTML = "";
            let rank = 1;
            snapshot.forEach(doc => {
                const data = doc.data();
                const isMe = doc.id === String(user.id);
                container.innerHTML += `
                    <div class="rank-item ${isMe ? 'me' : ''}">
                        <span>${rank}. ${data.name}</span>
                        <b>${data.balance.toLocaleString()}</b>
                    </div>
                `;
                rank++;
            });
        }

        function tap(e) {
            if (nrg <= 0) return;
            bal += 1; nrg--;
            updateUI();

            // Firebase gÃ¼ncelleme (Debounce ile yapÄ±lmasÄ± Ã¶nerilir ama ÅŸimdilik direkt)
            db.collection('users').doc(String(user.id)).update({ balance: bal });

            // GÃ¶rsel efekt
            document.getElementById('spider-main').style.transform = "scale(0.85)";
            setTimeout(() => document.getElementById('spider-main').style.transform = "scale(1)", 50);
        }

        function nav(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
            if(id === 'p-league') getRankings();
        }

        document.getElementById('tap-target').addEventListener('touchstart', (e) => { e.preventDefault(); tap(e); });
        init();
    </script>
</body>
</html>

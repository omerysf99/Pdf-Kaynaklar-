<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Spyder Network Ultimate - 2025 Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://adexora.com/cdn/ads.js?id=1545"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        /* --- GLOBAL THEME & RESET --- */
        :root {
            --p-purple: #a855f7;
            --p-glow: rgba(168, 85, 247, 0.4);
            --bg: #030303;
            --glass: rgba(15, 15, 20, 0.85);
            --glass-bright: rgba(255, 255, 255, 0.04);
            --border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-dim: #94a3b8;
            --green: #10b981;
            --red: #f43f5e;
            --gold: #fbbf24;
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg);
            background-image: radial-gradient(circle at 50% -20%, #2e1065, transparent), radial-gradient(circle at 0% 100%, #1e1b4b, transparent);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- PRELOADER --- */
        #preloader {
            position: fixed; inset: 0; background: var(--bg); z-index: 99999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spider-loader { width: 60px; height: 60px; border: 4px solid var(--border); border-top-color: var(--p-purple); border-radius: 50%; animation: spin 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- MAIN SCROLL AREA --- */
        main { flex: 1; overflow-y: auto; padding: 20px 20px calc(110px + var(--safe-bottom)) 20px; scroll-behavior: smooth; }
        .view { display: none; animation: slideIn 0.5s cubic-bezier(0.16, 1, 0.3, 1); flex-direction: column; }
        .view.active { display: flex; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- UI COMPONENTS --- */
        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 28px;
            padding: 22px;
            margin-bottom: 18px;
            position: relative;
            overflow: hidden;
        }
        .glass-card::before { content: ""; position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); }

        /* --- TYPOGRAPHY --- */
        h1 { font-size: 38px; font-weight: 800; letter-spacing: -1.5px; }
        h2 { font-size: 24px; font-weight: 700; margin-bottom: 15px; letter-spacing: -0.5px; }
        .dim { color: var(--text-dim); font-size: 13px; }

        /* --- GAME MECHANICS --- */
        .tap-zone {
            display: flex; justify-content: center; align-items: center;
            margin: 40px 0; position: relative;
        }
        .main-button {
            width: 240px; height: 240px; background: linear-gradient(135deg, #a855f7, #6b21a8);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 110px; box-shadow: 0 0 60px var(--p-glow); cursor: pointer;
            border: 10px solid rgba(255,255,255,0.1); transition: transform 0.1s;
            user-select: none;
        }
        .main-button:active { transform: scale(0.94); }

        /* --- PROGRESS BARS --- */
        .bar-container { height: 10px; background: rgba(255,255,255,0.05); border-radius: 20px; overflow: hidden; margin: 10px 0; }
        .bar-fill { height: 100%; background: var(--p-purple); width: 100%; transition: width 0.4s; box-shadow: 0 0 15px var(--p-glow); }

        /* --- BUTTONS & INPUTS --- */
        .btn-primary {
            width: 100%; padding: 18px; border-radius: 20px; border: none;
            background: var(--p-purple); color: #fff; font-weight: 800; font-size: 15px;
            box-shadow: 0 10px 25px var(--p-glow); cursor: pointer; transition: 0.3s;
        }
        .btn-primary:active { transform: translateY(2px); box-shadow: 0 5px 15px var(--p-glow); }
        .btn-primary:disabled { background: #222; box-shadow: none; color: #555; cursor: not-allowed; }

        input {
            width: 100%; padding: 16px; background: rgba(0,0,0,0.3); border: 1px solid var(--border);
            border-radius: 16px; color: #fff; text-align: center; font-size: 18px; font-weight: 600; outline: none; margin: 10px 0;
        }

        /* --- TASK LIST --- */
        .task-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px; border-radius: 20px; background: var(--glass-bright);
            border: 1px solid var(--border); margin-bottom: 12px;
        }
        .task-info b { display: block; font-size: 14px; }
        .task-info span { font-size: 12px; color: var(--p-purple); font-weight: 700; }

        /* --- ADMIN DASHBOARD --- */
        .admin-header { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px; }
        .admin-stat { padding: 15px; border-radius: 22px; background: var(--glass-bright); border: 1px solid var(--border); text-align: center; }
        .admin-stat small { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
        .admin-stat div { font-size: 20px; font-weight: 800; color: var(--p-purple); margin-top: 5px; }

        .tab-switcher { display: flex; background: rgba(255,255,255,0.05); padding: 6px; border-radius: 18px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 12px; border-radius: 14px; text-align: center; font-size: 12px; font-weight: 700; color: var(--text-dim); cursor: pointer; }
        .tab-btn.active { background: var(--p-purple); color: #fff; }

        .user-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer;
        }
        .user-row:last-child { border: none; }

        /* --- NAVIGATION --- */
        nav {
            position: fixed; bottom: 25px; left: 20px; right: 20px; height: 75px;
            background: rgba(10, 10, 15, 0.9); backdrop-filter: blur(25px);
            border: 1px solid var(--border); border-radius: 26px;
            display: flex; align-items: center; justify-content: space-around; z-index: 10000;
        }
        .nav-link { display: flex; flex-direction: column; align-items: center; color: var(--text-dim); transition: 0.3s; position: relative; }
        .nav-link.active { color: var(--p-purple); }
        .nav-link i { font-size: 22px; margin-bottom: 4px; font-style: normal; }
        .nav-link span { font-size: 10px; font-weight: 700; }
        .nav-link.active::after { content: ""; position: absolute; top: -15px; width: 30px; height: 4px; background: var(--p-purple); border-radius: 0 0 10px 10px; box-shadow: 0 5px 15px var(--p-glow); }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
            z-index: 100000; display: none; align-items: center; justify-content: center; padding: 25px;
        }
        .modal-body {
            background: #0d0d12; border: 1px solid var(--p-purple); width: 100%; max-width: 420px;
            border-radius: 35px; padding: 35px; animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes modalPop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .detail-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .detail-item span { color: var(--text-dim); font-size: 14px; }
        .detail-item b { color: #fff; font-size: 14px; }
    </style>
</head>
<body>

    <div id="preloader"><div class="spider-loader"></div></div>

    <div id="global-modal" class="modal-overlay">
        <div class="modal-body">
            <h2 id="mdl-title" style="text-align: center; margin-bottom: 25px;">Y√ºkleniyor...</h2>
            <div id="mdl-content"></div>
            <div id="mdl-actions" style="margin-top: 30px;"></div>
            <button class="btn-primary" style="margin-top: 15px; background: transparent; border: 1px solid var(--border); box-shadow: none;" onclick="UI.closeModal()">KAPAT</button>
        </div>
    </div>

    <main id="app-main">
        <section id="v-play" class="view active">
            <div style="text-align: center;">
                <p class="dim" style="letter-spacing: 4px; font-weight: 800;">SPYDER BALANCE</p>
                <h1 id="ui-bal" style="color: var(--p-purple); text-shadow: 0 0 20px var(--p-glow);">0</h1>
            </div>

            <div class="tap-zone">
                <div class="main-button" onclick="Game.tap(event)"><span>üï∑Ô∏è</span></div>
            </div>

            <div class="glass-card" style="margin-top: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span class="dim">ENERJƒ∞ SEVƒ∞YESƒ∞</span>
                    <b id="ui-nrg-text" style="font-size: 14px;">1000 / 1000</b>
                </div>
                <div class="bar-container"><div id="ui-nrg-bar" class="bar-fill"></div></div>
            </div>
        </section>

        <section id="v-tasks" class="view">
            <h2>G√∂rev Merkezi</h2>
            <p class="dim" style="margin-bottom: 20px;">Topluluƒüa katƒ±l ve devasa √∂d√ºlleri topla.</p>
            <div id="task-list-container">
                </div>
        </section>

        <section id="v-vault" class="view">
            <h2>Spyder Vault</h2>
            <div class="glass-card">
                <p class="dim">Elinizdeki Spyder'larƒ± ger√ßek USDT'ye d√∂n√º≈üt√ºr√ºn.</p>
                <div style="margin: 25px 0;">
                    <label class="dim" style="font-size: 11px; font-weight: 800;">D√ñN√ú≈ûT√úR√úLECEK Mƒ∞KTAR</label>
                    <input type="number" id="swap-input" value="100000" oninput="Finance.previewSwap()">
                </div>
                <div style="background: rgba(16, 185, 129, 0.1); border: 1px dashed var(--green); padding: 20px; border-radius: 20px; text-align: center;">
                    <span class="dim">ALACAƒûINIZ TUTAR</span>
                    <div style="font-size: 32px; font-weight: 800; color: var(--green);">$<span id="swap-output">1.00</span></div>
                </div>
                <button class="btn-primary" style="margin-top: 25px;" onclick="Finance.executeSwap()">ONAYLA VE D√ñN√ú≈ûT√úR</button>
            </div>
        </section>

        <section id="v-wallet" class="view">
            <h2>Finansal Durum</h2>
            <div class="glass-card" style="text-align: center; background: linear-gradient(180deg, rgba(168, 85, 247, 0.1), transparent);">
                <span class="dim">√áEKƒ∞LEBƒ∞Lƒ∞R BAKƒ∞YE</span>
                <h1 style="color: var(--green); margin: 10px 0;">$<span id="ui-usdt">0.00</span></h1>
            </div>

            <div class="glass-card">
                <h3>Para √áekme</h3>
                <input type="number" id="withdraw-amount" placeholder="Miktar (USDT)">
                <div style="display: flex; justify-content: space-between; font-size: 12px; margin: 10px 0;">
                    <span class="dim">Gerekli Reklam:</span>
                    <b id="ui-req-ads" style="color: var(--gold);">0 / 15</b>
                </div>
                <input type="text" id="withdraw-address" placeholder="BEP20 (BSC) Adresi">
                <button id="btn-withdraw-final" class="btn-primary" style="margin-top: 15px;" onclick="Finance.withdraw()">√áEKƒ∞M TALEBƒ∞ OLU≈ûTUR</button>
                <p class="dim" style="font-size: 10px; margin-top: 15px; text-align: center;">* Talepler 24 saat i√ßinde onaylanƒ±r.</p>
            </div>
        </section>

        <section id="v-admin" class="view">
            <h2>Komuta Merkezi</h2>
            <div class="admin-header">
                <div class="admin-stat"><small>√úyeler</small><div id="adm-total-users">0</div></div>
                <div class="admin-stat"><small>Reklamlar</small><div id="adm-total-ads">0</div></div>
            </div>

            <div class="tab-switcher">
                <div class="tab-btn active" id="tab-act" onclick="Admin.setTab('active')">AKTƒ∞F Lƒ∞STE</div>
                <div class="tab-btn" id="tab-arc" onclick="Admin.setTab('archive')">AR≈ûƒ∞V</div>
            </div>

            <div id="adm-withdraw-requests" style="margin-bottom: 20px;"></div>

            <h3 style="margin-bottom: 15px; font-size: 16px;">Kullanƒ±cƒ± Veritabanƒ±</h3>
            <div class="glass-card" style="padding: 0;">
                <div id="adm-user-list"></div>
            </div>
        </section>
    </main>

    <nav id="navbar">
        <div class="nav-link active" onclick="UI.navigate('v-play', this)"><i>üéÆ</i><span>Oyna</span></div>
        <div class="nav-link" onclick="UI.navigate('v-tasks', this)"><i>üì¢</i><span>G√∂rev</span></div>
        <div class="nav-link" onclick="UI.navigate('v-vault', this)"><i>üèõÔ∏è</i><span>Vault</span></div>
        <div class="nav-link" onclick="UI.navigate('v-wallet', this)"><i>üí∞</i><span>C√ºzdan</span></div>
    </nav>

    <script>
        /* --- CORE CONFIGURATION --- */
        const ADMIN_ID = "8392479231";
        const FB_CONFIG = {
            apiKey: "AIzaSyC18uinYQT9vOC-nhxv3x1WIhO_we3CRMY",
            authDomain: "pdfkaynak-51615.firebaseapp.com",
            projectId: "pdfkaynak-51615",
            appId: "1:228512804576:web:a0bba02ca83b4fa7adea85"
        };

        firebase.initializeApp(FB_CONFIG);
        const db = firebase.firestore();
        const tg = window.Telegram.WebApp;
        tg.expand();

        /* --- STATE MANAGEMENT --- */
        let state = {
            uid: "dev_user",
            u: {
                bal: 0, nrg: 1000, usdt: 0, ads: 0, totalAds: 0,
                tasks: [], isBanned: false, isArchived: false,
                paymentNotif: false, name: "Spyder User", username: "unknown"
            },
            adminTab: 'active',
            selectedAdminUser: null,
            lastSave: 0
        };

        /* --- INITIALIZER --- */
        const App = {
            init: async () => {
                state.uid = tg.initDataUnsafe?.user?.id?.toString() || "dev_user";
                state.u.name = tg.initDataUnsafe?.user?.first_name || "Spyder User";
                state.u.username = tg.initDataUnsafe?.user?.username || "unknown";

                try {
                    const doc = await db.collection("users").doc(state.uid).get();
                    if(doc.exists) {
                        state.u = { ...state.u, ...doc.data() };
                        if(state.u.paymentNotif) {
                            tg.showAlert("üåü √ñdemeniz tamamlandƒ±! C√ºzdanƒ±nƒ±zƒ± kontrol edin.");
                            await db.collection("users").doc(state.uid).update({ paymentNotif: false });
                        }
                    } else {
                        await App.save(true);
                    }

                    if(state.uid === ADMIN_ID) {
                        const admNav = document.createElement('div');
                        admNav.className = 'nav-link';
                        admNav.onclick = function() { UI.navigate('v-admin', this); Admin.init(); };
                        admNav.innerHTML = `<i>üîë</i><span>Admin</span>`;
                        document.getElementById('navbar').appendChild(admNav);
                    }

                    document.getElementById('preloader').style.display = 'none';
                    UI.refresh();
                    Tasks.render();
                    Game.startEnergyLoop();
                } catch (e) {
                    console.error("Critical Load Error", e);
                }
            },

            save: async (force = false) => {
                const now = Date.now();
                if(!force && now - state.lastSave < 10000) return;
                state.lastSave = now;
                await db.collection("users").doc(state.uid).set(state.u, { merge: true });
            }
        };

        /* --- GAME ENGINE --- */
        const Game = {
            tap: (e) => {
                if(state.u.isBanned) return tg.showAlert("Hesabƒ±nƒ±z kƒ±sƒ±tlanmƒ±≈ütƒ±r.");
                if(state.u.nrg <= 0) return tg.HapticFeedback.notificationOccurred('error');

                state.u.bal += 1;
                state.u.nrg -= 1;

                // Tap Animation
                UI.createPop(e);

                // Ad Logic (Every 40 taps)
                if(state.u.bal % 40 === 0) Game.triggerAd();

                UI.refresh();
            },

            triggerAd: () => {
                if(window.showAdexora) {
                    window.showAdexora().then(() => {
                        state.u.ads++;
                        state.u.totalAds++;
                        App.save(true);
                        UI.refresh();
                    });
                }
            },

            startEnergyLoop: () => {
                setInterval(() => {
                    if(state.u.nrg < 1000) {
                        state.u.nrg = Math.min(1000, state.u.nrg + 4);
                        UI.refresh();
                    }
                }, 3000);
            }
        };

        /* --- FINANCE & VAULT --- */
        const Finance = {
            previewSwap: () => {
                const val = document.getElementById('swap-input').value || 0;
                document.getElementById('swap-output').innerText = (val * 0.00001).toFixed(2);
            },

            executeSwap: async () => {
                const amt = parseInt(document.getElementById('swap-input').value);
                if(state.u.bal < amt) return tg.showAlert("Yetersiz Spyder bakiyesi!");

                state.u.bal -= amt;
                state.u.usdt += (amt * 0.00001);
                
                await App.save(true);
                UI.refresh();
                tg.showAlert("Ba≈üarƒ±yla d√∂n√º≈üt√ºr√ºld√º! C√ºzdanƒ±nƒ±zƒ± kontrol edin.");
            },

            withdraw: async () => {
                const amt = parseFloat(document.getElementById('withdraw-amount').value);
                const adr = document.getElementById('withdraw-address').value;
                const reqAds = Math.max(15, Math.ceil(amt / 0.01) * 15);

                if(state.u.usdt < amt) return tg.showAlert("Bakiye yetersiz.");
                if(state.u.ads < reqAds) return tg.showAlert(`Bu miktar i√ßin en az ${reqAds} reklam izlemelisiniz.`);
                if(adr.length < 10) return tg.showAlert("Ge√ßerli bir c√ºzdan adresi girin.");

                await db.collection("withdrawals").add({
                    uid: state.uid,
                    name: state.u.name,
                    amount: amt,
                    address: adr,
                    status: "pending",
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                state.u.usdt -= amt;
                state.u.ads = 0; // Reset ads for next cycle
                await App.save(true);
                UI.refresh();
                tg.showPopup({ title: "Ba≈üarƒ±lƒ±", message: "Talebiniz alƒ±ndƒ±. ƒ∞ncelendikten sonra g√∂nderilecektir.", buttons: [{type: "ok"}] });
            }
        };

        /* --- TASKS SYSTEM --- */
        const Tasks = {
            list: [
                { id: 1, title: "Telegram Kanallarƒ±na Katƒ±l", reward: 25000, link: "https://t.me/SpyderNetwork" },
                { id: 2, title: "X (Twitter) Takip Et", reward: 15000, link: "https://x.com/spydercoin" },
                { id: 3, title: "YouTube Abone Ol", reward: 20000, link: "https://youtube.com/@spydercoin" }
            ],

            render: () => {
                const cont = document.getElementById('task-list-container');
                cont.innerHTML = "";
                Tasks.list.forEach(t => {
                    const isDone = state.u.tasks.includes(t.id);
                    cont.innerHTML += `
                        <div class="task-item">
                            <div class="task-info">
                                <b>${t.title}</b>
                                <span>+${t.reward.toLocaleString()} SPYDER</span>
                            </div>
                            <button class="btn-primary" style="width:auto; padding:8px 18px; font-size:12px;" 
                                ${isDone ? 'disabled' : ''} onclick="Tasks.complete(${t.id}, ${t.reward}, '${t.link}')">
                                ${isDone ? 'TAMAMLANDI' : 'YAP'}
                            </button>
                        </div>`;
                });
            },

            complete: (id, reward, link) => {
                tg.openLink(link);
                setTimeout(async () => {
                    if(!state.u.tasks.includes(id)) {
                        state.u.tasks.push(id);
                        state.u.bal += reward;
                        await App.save(true);
                        UI.refresh();
                        Tasks.render();
                        tg.showAlert("G√∂rev √∂d√ºl√º hesabƒ±nƒ±za eklendi!");
                    }
                }, 5000);
            }
        };

        /* --- ADMIN ENGINE --- */
        const Admin = {
            init: async () => {
                const isArc = (state.adminTab === 'archive');
                const snap = await db.collection("users").where("isArchived", "==", isArc).get();
                
                const list = document.getElementById('adm-user-list');
                list.innerHTML = "";
                let totalAds = 0;

                snap.forEach(doc => {
                    const d = doc.data();
                    totalAds += (d.totalAds || 0);
                    const row = document.createElement('div');
                    row.className = 'user-row';
                    row.innerHTML = `
                        <div style="display:flex; flex-direction:column;">
                            <b>${d.name}</b>
                            <small class="dim">@${d.username}</small>
                        </div>
                        <div style="text-align:right">
                            <div style="color:var(--p-purple); font-weight:800;">${(d.bal||0).toLocaleString()}</div>
                            <small class="dim">$${(d.usdt||0).toFixed(2)}</small>
                        </div>`;
                    row.onclick = () => Admin.showDetail(doc.id, d);
                    list.appendChild(row);
                });

                document.getElementById('adm-total-users').innerText = snap.size;
                document.getElementById('adm-total-ads').innerText = totalAds.toLocaleString();
                Admin.loadWithdrawRequests();
            },

            setTab: (t) => {
                state.adminTab = t;
                document.getElementById('tab-act').className = (t === 'active' ? 'tab-btn active' : 'tab-btn');
                document.getElementById('tab-arc').className = (t === 'archive' ? 'tab-btn active' : 'tab-btn');
                Admin.init();
            },

            loadWithdrawRequests: async () => {
                const snap = await db.collection("withdrawals").where("status", "==", "pending").get();
                const div = document.getElementById('adm-withdraw-requests');
                div.innerHTML = snap.empty ? "" : `<h3 style="margin: 15px 0; color:var(--gold); font-size:16px;">üíé Bekleyen Talepler</h3>`;
                
                snap.forEach(doc => {
                    const r = doc.data();
                    div.innerHTML += `
                        <div class="glass-card" style="border-color: var(--gold);">
                            <div style="font-size:13px; margin-bottom:10px;">
                                <b>${r.name}</b>: <span style="color:var(--green)">$${r.amount}</span><br>
                                <small class="dim">${r.address}</small>
                            </div>
                            <button class="btn-primary" style="padding:10px; font-size:12px; background:var(--green);" onclick="Admin.processPay('${doc.id}', '${r.uid}')">√ñDENDƒ∞ OLARAK ƒ∞≈ûARETLE</button>
                        </div>`;
                });
            },

            showDetail: (id, d) => {
                state.selectedAdminUser = { id, ...d };
                document.getElementById('mdl-title').innerText = d.name;
                document.getElementById('mdl-content').innerHTML = `
                    <div class="detail-item"><span>Kullanƒ±cƒ± Adƒ±</span><b>@${d.username}</b></div>
                    <div class="detail-item"><span>Bakiye (S)</span><b>${(d.bal||0).toLocaleString()}</b></div>
                    <div class="detail-item"><span>Bakiye ($)</span><b>$${(d.usdt||0).toFixed(2)}</b></div>
                    <div class="detail-item"><span>Toplam Reklam</span><b>${d.totalAds || 0}</b></div>
                    <div class="detail-item"><span>Durum</span><b style="color:${d.isBanned ? 'var(--red)':'var(--green)'}">${d.isBanned ? 'BANLI':'AKTƒ∞F'}</b></div>
                `;
                document.getElementById('mdl-actions').innerHTML = `
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <button class="btn-primary" style="background:var(--gold);" onclick="Admin.toggleStatus('archive')">${d.isArchived ? 'AKTƒ∞FE AL' : 'AR≈ûƒ∞VLE'}</button>
                        <button class="btn-primary" style="background:var(--red);" onclick="Admin.toggleStatus('ban')">${d.isBanned ? 'BANI A√á' : 'BANLA'}</button>
                    </div>
                `;
                document.getElementById('global-modal').style.display = 'flex';
            },

            toggleStatus: async (type) => {
                const u = state.selectedAdminUser;
                const update = {};
                if(type === 'archive') update.isArchived = !u.isArchived;
                if(type === 'ban') update.isBanned = !u.isBanned;

                await db.collection("users").doc(u.id).update(update);
                tg.showAlert("ƒ∞≈ülem Ba≈üarƒ±lƒ±");
                UI.closeModal();
                Admin.init();
            },

            processPay: async (docId, userId) => {
                await db.collection("withdrawals").doc(docId).update({ status: "completed" });
                await db.collection("users").doc(userId).update({ paymentNotif: true });
                tg.showAlert("Kullanƒ±cƒ±ya bildirim g√∂nderildi ve √∂deme onaylandƒ±.");
                Admin.init();
            }
        };

        /* --- UI CONTROLLER --- */
        const UI = {
            navigate: (viewId, el) => {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
                document.getElementById(viewId).classList.add('active');
                el.classList.add('active');
                tg.HapticFeedback.impactOccurred('light');
            },

            refresh: () => {
                document.getElementById('ui-bal').innerText = Math.floor(state.u.bal).toLocaleString();
                document.getElementById('ui-nrg-text').innerText = `${state.u.nrg} / 1000`;
                document.getElementById('ui-nrg-bar').style.width = (state.u.nrg / 10) + "%";
                document.getElementById('ui-usdt').innerText = state.u.usdt.toFixed(2);
                
                const wAmt = parseFloat(document.getElementById('withdraw-amount').value) || 0;
                const reqAds = Math.max(15, Math.ceil(wAmt / 0.01) * 15);
                document.getElementById('ui-req-ads').innerText = `${state.u.ads} / ${reqAds}`;
                document.getElementById('btn-withdraw-final').disabled = (state.u.ads < reqAds || state.u.usdt < wAmt || wAmt <= 0);
            },

            createPop: (e) => {
                const x = e.clientX || (e.touches ? e.touches[0].clientX : 0);
                const y = e.clientY || (e.touches ? e.touches[0].clientY : 0);
                const p = document.createElement('div');
                p.innerText = "+1";
                p.style.cssText = `position:fixed; left:${x}px; top:${y}px; color:var(--p-purple); font-weight:800; pointer-events:none; z-index:9999; animation: floatUp 0.6s ease-out forwards;`;
                document.body.appendChild(p);
                setTimeout(() => p.remove(), 600);
            },

            closeModal: () => document.getElementById('global-modal').style.display = 'none'
        };

        const style = document.createElement('style');
        style.innerHTML = `@keyframes floatUp { to { transform: translateY(-80px); opacity: 0; } }`;
        document.head.appendChild(style);

        /* --- START --- */
        App.init();

    </script>
</body>
</html>

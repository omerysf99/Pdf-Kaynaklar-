<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NexTube | Pro Persistence V6</title>
    <style>
        :root {
            --nt-black: #0f0f0f;
            --nt-white: #ffffff;
            --nt-red: #ff0000;
            --nt-gray-1: #272727;
            --nt-gray-2: #3f3f3f;
            --nt-gray-3: #aaaaaa;
            --nt-blue: #3ea6ff;
            --nt-radius-md: 12px;
            --nt-header-h: 56px;
            --nt-sidebar-w: 240px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--nt-black); color: var(--nt-white); font-family: "Roboto", sans-serif; overflow: hidden; height: 100vh; }

        /* --- AUTH LAYER --- */
        #authContainer {
            position: fixed; inset: 0; z-index: 10000;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(20px);
            display: flex; align-items: center; justify-content: center;
        }
        .auth-card { background: #1e1e1e; padding: 40px; border-radius: 20px; width: 400px; text-align: center; border: 1px solid var(--nt-gray-1); }
        .auth-logo { font-size: 28px; font-weight: 900; margin-bottom: 20px; font-style: italic; }
        .auth-logo span { color: var(--nt-red); }
        .auth-input { width: 100%; background: #121212; border: 1px solid var(--nt-gray-2); padding: 12px; border-radius: 8px; color: white; margin-bottom: 15px; }
        .auth-btn { width: 100%; background: white; color: black; border: none; padding: 14px; border-radius: 30px; font-weight: 800; cursor: pointer; }

        /* --- LAYOUT --- */
        header { position: fixed; top: 0; width: 100%; height: var(--nt-header-h); background: var(--nt-black); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; z-index: 1000; border-bottom: 1px solid var(--nt-gray-1); }
        nav.sidebar { position: fixed; left: 0; top: var(--nt-header-h); bottom: 0; width: var(--nt-sidebar-w); padding: 12px; background: var(--nt-black); border-right: 1px solid var(--nt-gray-1); }
        #mainStage { margin-top: var(--nt-header-h); margin-left: var(--nt-sidebar-w); height: calc(100vh - var(--nt-header-h)); overflow-y: auto; background: var(--nt-black); }
        
        .nav-item { display: flex; align-items: center; gap: 20px; padding: 10px 16px; border-radius: 8px; cursor: pointer; color: var(--nt-white); text-decoration: none; font-size: 14px; }
        .nav-item:hover { background: var(--nt-gray-1); }
        .nav-item.active { background: var(--nt-gray-2); font-weight: 700; }

        /* --- CONTENT --- */
        .view { display: none; padding: 24px; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
        .v-card { cursor: pointer; }
        .v-thumb { aspect-ratio: 16/9; background: #1a1a1a; border-radius: 12px; overflow: hidden; position: relative; margin-bottom: 10px; border: 1px solid var(--nt-gray-1); }
        .v-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .v-meta { display: flex; gap: 12px; }
        .v-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--nt-gray-2); flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-weight: 800; }

        /* --- UPLOAD PANEL --- */
        #uploadOverlay { position: fixed; inset: 0; z-index: 2000; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; }
        .upload-card { background: var(--nt-gray-1); width: 900px; max-height: 850px; border-radius: 16px; display: flex; flex-direction: column; overflow: hidden; border: 1px solid var(--nt-gray-2); }
        .up-body { padding: 30px; display: grid; grid-template-columns: 1.5fr 1fr; gap: 25px; overflow-y: auto; }
        .drop-zone { grid-column: 1/-1; border: 2px dashed var(--nt-gray-3); padding: 50px; text-align: center; border-radius: 12px; cursor: pointer; }
        .up-input { width: 100%; background: transparent; border: 1px solid var(--nt-gray-3); padding: 12px; color: white; border-radius: 4px; margin-bottom: 15px; }
        .up-preview { width: 100%; aspect-ratio: 16/9; background: black; border-radius: 8px; overflow: hidden; position: relative; }
        .progress-cont { height: 4px; background: #333; margin-top: 15px; border-radius: 2px; overflow: hidden; display: none; }
        .progress-bar { height: 100%; width: 0%; background: var(--nt-blue); transition: 0.3s; }

        /* --- SHORTS --- */
        #shortsWrapper { height: 100%; display: flex; justify-content: center; background: #000; }
        .shorts-container { width: 400px; height: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; }
        .short-item { height: 100%; scroll-snap-align: start; position: relative; display: flex; align-items: center; }
        .short-video { width: 100%; height: 100%; object-fit: cover; }

        /* --- WATCH --- */
        .watch-layout { display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
        .main-player { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; }

        .hidden { display: none !important; }
        .locked { pointer-events: none; opacity: 0.7; }
        #toast { position: fixed; bottom: 20px; left: 20px; background: white; color: black; padding: 12px 24px; border-radius: 8px; font-weight: 800; z-index: 11000; display: none; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100px); } to { transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="toast">Bildirim</div>

    <div id="authContainer">
        <div class="auth-card">
            <div class="auth-logo">Nex<span>Tube</span></div>
            <p style="color:var(--nt-gray-3); margin-bottom: 25px; font-size: 14px;">Mimaride Kesintisiz Video Deneyimi</p>
            <input type="text" id="authName" class="auth-input" placeholder="Kullanıcı Adı">
            <input type="email" id="authEmail" class="auth-input" placeholder="E-Posta">
            <button class="auth-btn" onclick="Engine.Auth.login()">SİSTEME GİRİŞ YAP</button>
            <p style="margin-top: 15px; font-size: 10px; color: #555;">ID: 8392479231 • IndexedDB Aktif</p>
        </div>
    </div>

    <header>
        <div style="display:flex; align-items:center; gap:20px;">
            <div class="auth-logo" style="margin:0; font-size: 20px; cursor:pointer;" onclick="Engine.UI.view('home')">Nex<span>Tube</span></div>
        </div>
        <div style="display:flex; gap:15px; align-items:center;">
            <button class="auth-btn" style="width:auto; padding:8px 20px; font-size:13px;" onclick="Engine.Upload.open()">VİDEO YÜKLE</button>
            <div class="v-avatar" id="userIcon">?</div>
        </div>
    </header>

    <nav class="sidebar">
        <div class="nav-item active" onclick="Engine.UI.view('home')">Ana Sayfa</div>
        <div class="nav-item" onclick="Engine.UI.view('shorts')">Shorts</div>
        <div style="height:1px; background:var(--nt-gray-1); margin:15px 0;"></div>
        <div class="nav-item">Kitaplık</div>
    </nav>

    <div id="mainStage">
        <div id="view-home" class="view active">
            <h2 style="margin-bottom:20px;">Önerilenler</h2>
            <div class="video-grid" id="homeFeed"></div>
        </div>

        <div id="view-shorts" class="view" style="padding:0;">
            <div id="shortsWrapper">
                <div class="shorts-container" id="shortsFeed"></div>
            </div>
        </div>

        <div id="view-watch" class="view">
            <div class="watch-layout">
                <div>
                    <video id="watchPlayer" class="main-player" controls autoplay></video>
                    <h1 id="watchTitle" style="margin: 15px 0;">Video Başlığı</h1>
                    <p id="watchDesc" style="color:var(--nt-gray-3);"></p>
                </div>
                <div id="sideFeed"></div>
            </div>
        </div>
    </div>

    <div id="uploadOverlay">
        <div class="upload-card">
            <div style="padding:15px 25px; border-bottom:1px solid var(--nt-gray-2); display:flex; justify-content:space-between;">
                <h3>Hızlı Video Yayınla</h3>
                <button onclick="Engine.Upload.close()" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;">&times;</button>
            </div>
            <div class="up-body">
                <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileIn').click()">
                    <p>Videonuzu Buraya Sürükleyin veya Dosya Seçin</p>
                    <input type="file" id="fileIn" accept="video/*" hidden onchange="Engine.Upload.handleFile(this)">
                </div>
                <div id="upFields" class="hidden">
                    <label style="font-size:12px; color:var(--nt-gray-3);">VİDEO BAŞLIĞI</label>
                    <input type="text" id="upTitle" class="up-input" placeholder="Başlık ekleyin">
                    <label style="font-size:12px; color:var(--nt-gray-3);">AÇIKLAMA</label>
                    <textarea id="upDesc" class="up-input" style="height:100px; resize:none;"></textarea>
                </div>
                <div id="upPreviewArea" class="hidden">
                    <div class="up-preview">
                        <video id="upVidElement" muted style="width:100%; height:100%;"></video>
                    </div>
                    <div id="upBadge" style="margin-top:10px; font-size:11px; font-weight:900; background:var(--nt-blue); display:inline-block; padding:3px 8px; border-radius:4px;">ANALİZ EDİLİYOR...</div>
                    <div class="progress-cont" id="upProg">
                        <div class="progress-bar" id="upBar"></div>
                    </div>
                    <div id="upStatus" style="font-size:12px; color:var(--nt-blue); margin-top:10px;"></div>
                </div>
            </div>
            <div style="padding:15px 25px; border-top:1px solid var(--nt-gray-2); text-align:right;">
                <button class="auth-btn" style="width:auto; padding:10px 40px;" id="publishBtn" onclick="Engine.Upload.start()">YAYINLA</button>
            </div>
        </div>
    </div>

    <canvas id="thumbCanvas" style="display:none;"></canvas>

    <script>
        /**
         * NEXTUBE PERSISTENCE ENGINE
         * Architected to survive refreshes via IndexedDB
         */
        const Engine = {
            db: null,
            state: { user: null, videos: [] },

            async init() {
                await this.DB.open();
                this.Auth.check();
                await this.Storage.sync();
            },

            DB: {
                open() {
                    return new Promise((resolve) => {
                        const request = indexedDB.open("VideoPlatformDB", 1);
                        request.onupgradeneeded = (e) => {
                            const db = e.target.result;
                            if(!db.objectStoreNames.contains("videos")) {
                                db.createObjectStore("videos", { keyPath: "id" });
                            }
                        };
                        request.onsuccess = (e) => {
                            Engine.db = e.target.result;
                            resolve();
                        };
                    });
                },
                async save(videoData) {
                    return new Promise((resolve) => {
                        const tx = Engine.db.transaction("videos", "readwrite");
                        tx.objectStore("videos").put(videoData);
                        tx.oncomplete = () => resolve();
                    });
                },
                async getAll() {
                    return new Promise((resolve) => {
                        const tx = Engine.db.transaction("videos", "readonly");
                        const request = tx.objectStore("videos").getAll();
                        request.onsuccess = () => resolve(request.result);
                    });
                }
            },

            Storage: {
                async sync() {
                    const rawVideos = await Engine.DB.getAll();
                    // Her video için geçici Blob URL'lerini yeniden oluştur
                    Engine.state.videos = rawVideos.map(v => {
                        return {
                            ...v,
                            videoUrl: URL.createObjectURL(v.videoBlob),
                            thumbUrl: URL.createObjectURL(v.thumbBlob)
                        };
                    });
                    Engine.UI.renderFeeds();
                }
            },

            Auth: {
                login() {
                    const name = document.getElementById('authName').value;
                    const email = document.getElementById('authEmail').value;
                    if(name && email) {
                        Engine.state.user = { name, email };
                        localStorage.setItem('nt_user', JSON.stringify(Engine.state.user));
                        this.check();
                    }
                },
                check() {
                    const saved = localStorage.getItem('nt_user');
                    if(saved) {
                        Engine.state.user = JSON.parse(saved);
                        document.getElementById('authContainer').classList.add('hidden');
                        document.getElementById('userIcon').innerText = Engine.state.user.name[0].toUpperCase();
                    }
                }
            },

            Upload: {
                activeFile: null,
                activeType: 'long',

                open() { document.getElementById('uploadOverlay').style.display = 'flex'; },
                close() { if(!Engine.isUploading) document.getElementById('uploadOverlay').style.display = 'none'; },

                handleFile(input) {
                    const file = input.files[0];
                    if(!file) return;
                    this.activeFile = file;

                    const url = URL.createObjectURL(file);
                    const vidEl = document.getElementById('upVidElement');
                    vidEl.src = url;

                    document.getElementById('dropZone').classList.add('hidden');
                    document.getElementById('upFields').classList.remove('hidden');
                    document.getElementById('upPreviewArea').classList.remove('hidden');
                    document.getElementById('upTitle').value = file.name.split('.')[0];

                    vidEl.onloadedmetadata = () => {
                        const badge = document.getElementById('upBadge');
                        if(vidEl.duration < 60) {
                            this.activeType = 'shorts';
                            badge.innerText = "SHORTS OLARAK KAYDEDİLECEK";
                            badge.style.background = "var(--nt-red)";
                        } else {
                            this.activeType = 'long';
                            badge.innerText = "UZUN VİDEO OLARAK KAYDEDİLECEK";
                            badge.style.background = "var(--nt-blue)";
                        }
                    };
                },

                async start() {
                    const title = document.getElementById('upTitle').value;
                    if(!title || !this.activeFile) return;

                    Engine.isUploading = true;
                    document.querySelector('.upload-card').classList.add('locked');
                    document.getElementById('upProg').style.display = 'block';

                    // 1. Thumbnail Oluştur (Persistence için Kritik)
                    const thumbBlob = await this.generateThumbnail();

                    // 2. Sahte Upload Progress
                    let p = 0;
                    const bar = document.getElementById('upBar');
                    const status = document.getElementById('upStatus');

                    const interval = setInterval(async () => {
                        p += 15;
                        if(p >= 100) {
                            p = 100;
                            clearInterval(interval);
                            
                            // 3. IndexedDB'ye Gerçek Blob Kaydı
                            const videoId = 'vid_' + Date.now();
                            const videoRecord = {
                                id: videoId,
                                title: title,
                                description: document.getElementById('upDesc').value,
                                type: this.activeType,
                                videoBlob: this.activeFile, // Gerçek dosya verisi
                                thumbBlob: thumbBlob,       // Üretilen thumbnail
                                author: Engine.state.user.name,
                                createdAt: new Date().toISOString()
                            };

                            await Engine.DB.save(videoRecord);
                            Engine.isUploading = false;
                            Engine.UI.toast("Video Kalıcı Olarak Kaydedildi!");
                            location.reload(); // IndexedDB'den temiz okuma testi için reload
                        }
                        bar.style.width = p + '%';
                        status.innerText = `İşleniyor: %${p}`;
                    }, 400);
                },

                generateThumbnail() {
                    return new Promise((resolve) => {
                        const video = document.getElementById('upVidElement');
                        const canvas = document.getElementById('thumbCanvas');
                        canvas.width = 640;
                        canvas.height = 360;
                        const ctx = canvas.getContext('2d');
                        video.currentTime = 1; // 1. saniyeden kare al
                        video.onseeked = () => {
                            ctx.drawImage(video, 0, 0, 640, 360);
                            canvas.toBlob((blob) => resolve(blob), 'image/jpeg', 0.8);
                        };
                    });
                }
            },

            UI: {
                view(v) {
                    document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
                    document.getElementById('view-' + v).classList.add('active');
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                    
                    if(v === 'shorts') Engine.UI.playShorts();
                    else Engine.UI.stopShorts();
                },

                toast(msg) {
                    const t = document.getElementById('toast');
                    t.innerText = msg;
                    t.style.display = 'block';
                    setTimeout(() => t.style.display = 'none', 3000);
                },

                renderFeeds() {
                    const home = document.getElementById('homeFeed');
                    const shorts = document.getElementById('shortsFeed');
                    
                    const longVideos = Engine.state.videos.filter(v => v.type === 'long');
                    const shortVideos = Engine.state.videos.filter(v => v.type === 'shorts');

                    home.innerHTML = longVideos.map(v => `
                        <div class="v-card" onclick="Engine.UI.watch('${v.id}')">
                            <div class="v-thumb"><img src="${v.thumbUrl}"></div>
                            <div class="v-meta">
                                <div class="v-avatar">${v.author[0]}</div>
                                <div>
                                    <h4 style="font-size:14px; margin-bottom:4px;">${v.title}</h4>
                                    <p style="font-size:12px; color:var(--nt-gray-3);">${v.author}</p>
                                </div>
                            </div>
                        </div>
                    `).join('');

                    shorts.innerHTML = shortVideos.map(v => `
                        <div class="short-item">
                            <video class="short-video" src="${v.videoUrl}" loop muted playsinline></video>
                            <div style="position:absolute; bottom:20px; left:20px; text-shadow:0 2px 4px rgba(0,0,0,0.8);">
                                <h3 style="font-weight:900;">${v.title}</h3>
                                <p>@${v.author}</p>
                            </div>
                        </div>
                    `).join('');
                },

                watch(id) {
                    const v = Engine.state.videos.find(x => x.id === id);
                    this.view('watch');
                    const p = document.getElementById('watchPlayer');
                    p.src = v.videoUrl;
                    document.getElementById('watchTitle').innerText = v.title;
                    document.getElementById('watchDesc').innerText = v.description;
                },

                playShorts() {
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(e => {
                            const vid = e.target.querySelector('video');
                            if(e.isIntersecting) vid.play();
                            else { vid.pause(); vid.currentTime = 0; }
                        });
                    }, { threshold: 0.7 });
                    document.querySelectorAll('.short-item').forEach(el => observer.observe(el));
                },

                stopShorts() {
                    document.querySelectorAll('.short-video').forEach(v => v.pause());
                }
            }
        };

        // Engine Boot
        window.addEventListener('DOMContentLoaded', () => Engine.init());
    </script>
</body>
</html>

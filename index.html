<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpyderCoin - MultiUser</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://adexora.com/cdn/ads.js?id=1545"></script>

    <style>
        body {
            background: radial-gradient(circle, #2e004f 0%, #000 100%);
            color: #ffeb3b; font-family: 'Arial Black', sans-serif;
            margin: 0; height: 100vh; display: flex; flex-direction: column;
            align-items: center; text-align: center; overflow: hidden;
        }
        .header { margin-top: 30px; }
        #balance { font-size: 45px; text-shadow: 0 0 20px #9c27b0; }
        .tab-content { display: none; width: 100%; height: 75vh; flex-direction: column; align-items: center; justify-content: center; }
        .active-tab { display: flex; }
        #spider { font-size: 160px; cursor: pointer; transition: transform 0.1s; user-select: none; }
        #spider:active { transform: scale(0.9); }
        .energy-wrap { width: 280px; height: 25px; background: #222; border: 3px solid #ffeb3b; border-radius: 20px; position: relative; margin: 15px 0; }
        #energy-fill { height: 100%; width: 100%; background: #ffeb3b; border-radius: 15px; }
        #energy-text { position: absolute; width: 100%; top: 3px; left: 0; color: #000; font-size: 14px; font-weight: bold; }
        .navbar { position: fixed; bottom: 0; width: 100%; background: #1a002e; border-top: 3px solid #ffeb3b; display: flex; justify-content: space-around; padding: 12px 0; }
        .nav-item { cursor: pointer; color: #d1c4e9; font-size: 12px; display: flex; flex-direction: center; align-items: center; flex-direction: column; }
        .nav-item.active { color: #ffeb3b; }
        .wallet-card { background: #2e004f; padding: 25px; border: 4px solid #ffeb3b; border-radius: 25px; width: 85%; max-width: 340px; }
        .wallet-card input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: none; font-size: 16px; text-align: center; box-sizing: border-box; }
        #calc-info { background: #1a002e; color: #00ff00; padding: 10px; border-radius: 10px; font-size: 13px; margin: 10px 0; display: none; }
        .btn { background: #ffeb3b; color: #2e004f; border: none; padding: 15px 25px; font-size: 16px; font-weight: bold; border-radius: 15px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="header">
        <div id="balance">$0.00000</div>
        <div id="user-name" style="font-size: 12px; color: #aaa;">Y√ºkleniyor...</div>
    </div>

    <div id="tab-game" class="tab-content active-tab">
        <div class="energy-wrap">
            <div id="energy-fill"></div>
            <div id="energy-text">1000 / 1000</div>
        </div>
        <div id="spider">üï∑Ô∏è</div>
        <button class="btn" onclick="refill()">ENERJƒ∞ DOLDUR (AD)</button>
    </div>

    <div id="tab-tasks" class="tab-content">
        <div style="background: rgba(46, 0, 79, 0.8); padding: 20px; border-radius: 20px; border: 2px solid #ffeb3b; width: 85%;">
            <h3>Telegram Kanalƒ±</h3>
            <div style="color:#00ff00; font-size:20px; margin:10px 0;">+0.60 USDT</div>
            <button id="tg-btn" class="btn" style="background:#0088cc; color:white; width:100%" onclick="doTelegramTask()">KATIL</button>
        </div>
    </div>

    <div id="tab-wallet" class="tab-content">
        <div class="wallet-card">
            <h2 style="margin:0">USDT √áEKƒ∞M</h2>
            <input type="number" id="w-amount" placeholder="Miktar (USDT)" oninput="autoCalc(this.value)">
            <div id="calc-info">Zorunlu Reklam: 0</div>
            <input type="text" id="w-address" placeholder="TRC20 Adresi">
            <button class="btn" style="width:100%; margin-top:10px;" onclick="sendWithdraw()">TALEBƒ∞ G√ñNDER</button>
        </div>
    </div>

    <div class="navbar">
        <div class="nav-item active" onclick="switchTab('game', this)"><span>üï∑Ô∏è</span>Oyun</div>
        <div class="nav-item" onclick="switchTab('tasks', this)"><span>üìã</span>G√∂revler</div>
        <div class="nav-item" onclick="switchTab('wallet', this)"><span>üëõ</span>C√ºzdan</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // TELEGRAM'DAN KULLANICI ID'Sƒ∞Nƒ∞ AL (√ñNEMLƒ∞!)
        const userId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id.toString() : "test_user";
        document.getElementById('user-name').innerText = tg.initDataUnsafe.user ? "@" + tg.initDataUnsafe.user.username : "Misafir";

        const firebaseConfig = {
            apiKey: "AIzaSyDfy6QdIZ0BthEHTmxkw-NAja3B9bFFd8U",
            authDomain: "spydercoin-94f7b.firebaseapp.com",
            projectId: "spydercoin-94f7b",
            storageBucket: "spydercoin-94f7b.firebasestorage.app",
            messagingSenderId: "218267568158",
            appId: "1:218267568158:web:832728845ba0f42202060f"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let money = 0, energy = 1000, adsWatched = 0, tgDone = false;

        // HER KULLANICIYI KENDƒ∞ ID'Sƒ∞ ƒ∞LE TAKƒ∞P ET
        db.collection("players").doc(userId).onSnapshot(doc => {
            if(doc.exists){
                const d = doc.data();
                money = d.money || 0;
                energy = d.energy || 1000;
                adsWatched = d.adsWatched || 0;
                tgDone = d.tgDone || false;
                updateUI();
            } else {
                save(); // Yeni kullanƒ±cƒ± olu≈ütur
            }
        });

        document.getElementById('spider').onclick = () => {
            if(energy > 0) { money += 0.00001; energy--; updateUI(); save(); }
        };

        function refill() {
            window.open("https://adexora.my.id/dl/QFm5mnRYbJV", "_blank");
            energy = 1000; adsWatched++; save();
            if(window.showAdexora) window.showAdexora().catch(e=>{});
        }

        function doTelegramTask() {
            if(tgDone) return;
            tg.openTelegramLink("https://t.me/SpyderCommunity");
            setTimeout(() => {
                if(!tgDone) { money += 0.60; tgDone = true; save(); tg.showAlert("0.60$ Eklendi!"); }
            }, 3000);
        }

        function autoCalc(val) {
            const info = document.getElementById('calc-info');
            if(val > 0) {
                info.innerText = "Zorunlu Reklam Sayƒ±sƒ±: " + Math.ceil((val / 0.50) * 750);
                info.style.display = "block";
            } else { info.style.display = "none"; }
        }

        function sendWithdraw() {
            const amt = parseFloat(document.getElementById('w-amount').value);
            const addr = document.getElementById('w-address').value;
            const needed = (amt / 0.50) * 750;
            if(amt < 0.50 || money < amt || adsWatched < needed) return alert("≈ûartlar saƒülanmadƒ±!");
            db.collection("withdrawals").add({ userId, amount:amt, address:addr, date:new Date() })
            .then(() => alert("Talep iletildi!"));
        }

        function updateUI() {
            document.getElementById('balance').innerText = "$" + money.toFixed(5);
            document.getElementById('energy-text').innerText = energy + " / 1000";
            document.getElementById('energy-fill').style.width = (energy/10) + "%";
            if(tgDone) { document.getElementById('tg-btn').innerText = "TAMAMLANDI ‚úÖ"; document.getElementById('tg-btn').disabled = true; }
        }

        function save() {
            db.collection("players").doc(userId).set({ money, energy, adsWatched, tgDone }, {merge:true});
        }

        function switchTab(tabId, el) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active-tab'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active-tab');
            el.classList.add('active');
        }
    </script>
</body>
</html>

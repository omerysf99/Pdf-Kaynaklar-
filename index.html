<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro-Tube | Professional Video Architecture</title>
    <style>
        :root {
            --yt-black: #0f0f0f;
            --yt-red: #ff0000;
            --yt-white: #ffffff;
            --yt-gray: #aaaaaa;
            --yt-dark-gray: #272727;
            --yt-border: rgba(255, 255, 255, 0.1);
            --sidebar-width: 240px;
            --header-height: 56px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none;
        }
        body {
            background-color: var(--yt-black);
            color: var(--yt-white);
            font-family: "Roboto", Arial, sans-serif;
            overflow: hidden;
            height: 100vh;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #717171;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #888;
        }
        header {
            height: var(--header-height);
            background-color: var(--yt-black);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .menu-btn {
            padding: 8px;
            cursor: pointer;
            border-radius: 50%;
        }
        .menu-btn:hover {
            background-color: var(--yt-dark-gray);
        }
        .logo-container {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }
        .logo-icon {
            color: var(--yt-red);
            font-size: 24px;
        }
        .logo-text {
            font-weight: bold;
            font-size: 18px;
            letter-spacing: -1px;
        }
        .header-center {
            display: flex;
            align-items: center;
            flex: 0 1 720px;
        }
        .search-container {
            display: flex;
            width: 100%;
            background-color: #121212;
            border: 1px solid #303030;
            border-radius: 40px 0 0 40px;
            padding: 0 4px 0 16px;
            margin-left: 32px;
        }
        .search-input {
            width: 100%;
            background: transparent;
            border: none;
            color: white;
            height: 40px;
            font-size: 16px;
        }
        .search-btn {
            background-color: #222222;
            border: 1px solid #303030;
            border-left: none;
            border-radius: 0 40px 40px 0;
            padding: 0 20px;
            cursor: pointer;
            height: 40px;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .icon-btn {
            padding: 8px;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .icon-btn:hover {
            background-color: var(--yt-dark-gray);
        }
        nav.sidebar {
            width: var(--sidebar-width);
            height: calc(100vh - var(--header-height));
            position: fixed;
            top: var(--header-height);
            left: 0;
            background-color: var(--yt-black);
            padding: 12px;
            overflow-y: auto;
            z-index: 999;
        }
        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 24px;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
        }
        .sidebar-item:hover {
            background-color: var(--yt-dark-gray);
        }
        .sidebar-item.active {
            background-color: var(--yt-dark-gray);
        }
        .sidebar-item span {
            font-size: 14px;
        }
        .sidebar-divider {
            height: 1px;
            background-color: var(--yt-border);
            margin: 12px 0;
        }
        .main-content {
            margin-left: var(--sidebar-width);
            margin-top: var(--header-height);
            height: calc(100vh - var(--header-height));
            overflow-y: auto;
            padding: 24px;
        }
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            row-gap: 32px;
        }
        .video-card {
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .thumbnail-container {
            width: 100%;
            aspect-ratio: 16/9;
            background-color: #333;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        .thumbnail-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .duration-badge {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background-color: rgba(0,0,0,0.8);
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .video-info {
            display: flex;
            gap: 12px;
        }
        .channel-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #555;
            flex-shrink: 0;
        }
        .video-details h3 {
            font-size: 16px;
            line-height: 22px;
            margin-bottom: 4px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .video-meta {
            font-size: 14px;
            color: var(--yt-gray);
            line-height: 18px;
        }
        .shorts-section {
            padding: 24px 0;
            border-top: 4px solid var(--yt-dark-gray);
            border-bottom: 4px solid var(--yt-dark-gray);
            margin: 24px 0;
        }
        .shorts-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }
        .shorts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }
        .short-card {
            aspect-ratio: 9/16;
            background-color: #222;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }
        .short-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .short-info {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 16px 12px;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
        }
        .short-title {
            font-size: 14px;
            font-weight: 600;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        #shorts-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .shorts-wrapper {
            width: 100%;
            height: 100%;
            max-width: 450px;
            position: relative;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
        }
        .short-player-container {
            width: 100%;
            height: 100%;
            scroll-snap-align: start;
            position: relative;
            background: #111;
        }
        .short-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .short-controls-overlay {
            position: absolute;
            bottom: 20px;
            right: 12px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }
        .control-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .control-btn {
            width: 48px;
            height: 48px;
            background-color: rgba(255,255,255,0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .control-btn:hover {
            background-color: rgba(255,255,255,0.2);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }
        .upload-modal {
            background-color: #282828;
            width: 90%;
            max-width: 960px;
            height: 80vh;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--yt-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }
        .upload-circle {
            width: 136px;
            height: 136px;
            background-color: #1f1f1f;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .upload-btn {
            background-color: var(--yt-white);
            color: black;
            padding: 10px 24px;
            border-radius: 18px;
            font-weight: 500;
            cursor: pointer;
            border: none;
        }
        .input-group {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .input-field {
            background: transparent;
            border: 1px solid #606060;
            border-radius: 4px;
            padding: 12px;
            color: white;
            font-size: 16px;
        }
        .input-field:focus {
            border-color: #3ea6ff;
        }
        .progress-container {
            width: 100%;
            height: 4px;
            background-color: #444;
            border-radius: 2px;
            margin: 20px 0;
            display: none;
        }
        .progress-bar {
            height: 100%;
            background-color: #3ea6ff;
            width: 0%;
            transition: width 0.1s;
        }
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background-color: #ffffff;
            color: #000;
            padding: 12px 24px;
            border-radius: 4px;
            font-weight: 500;
            transform: translateY(150%);
            transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            z-index: 5000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .toast.show {
            transform: translateY(0);
        }
        #player-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--yt-black);
            z-index: 1500;
            display: none;
            overflow-y: auto;
            padding-top: var(--header-height);
        }
        .player-content {
            max-width: 1280px;
            margin: 0 auto;
            padding: 24px;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 24px;
        }
        .main-player-area video {
            width: 100%;
            aspect-ratio: 16/9;
            background-color: #000;
            border-radius: 12px;
        }
        .player-info {
            margin-top: 16px;
        }
        .player-info h2 {
            font-size: 20px;
            margin-bottom: 12px;
        }
        .player-actions {
            display: flex;
            gap: 12px;
            margin: 16px 0;
        }
        .action-btn {
            background-color: rgba(255,255,255,0.1);
            padding: 8px 16px;
            border-radius: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
        }
        .action-btn:hover {
            background-color: rgba(255,255,255,0.2);
        }
        .player-description {
            background-color: var(--yt-dark-gray);
            padding: 12px;
            border-radius: 12px;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .comment-section {
            margin-top: 24px;
        }
        .comment-input-area {
            display: flex;
            gap: 16px;
            margin: 24px 0;
        }
        .comment-item {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <div class="menu-btn" onclick="toggleSidebar()">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M21 6H3V5h18v1zm0 5H3v1h18v-1zm0 6H3v1h18v-1z"></path></svg>
            </div>
            <div class="logo-container" onclick="navigate('home')">
                <span class="logo-icon">▶</span>
                <span class="logo-text">ProTube</span>
            </div>
        </div>
        <div class="header-center">
            <div class="search-container">
                <input type="text" class="search-input" placeholder="Ara">
            </div>
            <button class="search-btn">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="white"><path d="M20.87 20.17l-5.59-5.59C16.35 13.35 17 11.75 17 10c0-3.87-3.13-7-7-7s-7 3.13-7 7 3.13 7 7 7c1.75 0 3.35-.65 4.58-1.71l5.59 5.59.7-.71zM10 16c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z"></path></svg>
            </button>
        </div>
        <div class="header-right">
            <div class="icon-btn" onclick="openUploadModal()" title="Video Yükle">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M14 13h-3v3H9v-3H6v-2h3V8h2v3h3v2zm3-7H3v12h14v-6.39l4 3.83V7.56l-4 3.83V6m1-1v14L13 14v5H2V5h11v5l5-5z"></path></svg>
            </div>
            <div class="icon-btn">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M10 20h4c0 1.1-.9 2-2 2s-2-.9-2-2zm10-2.65V19H4v-1.65l2-1.88v-5.15C6 7.4 7.56 5.1 10 4.34v-.38c0-1.1.9-2 2-2s2 .9 2 2v.38c2.44.76 4 3.05 4 5.98v5.15l2 1.88zM19 17.77l-2-1.88v-5.47c0-2.47-1.19-4.36-3.13-5.1-1.26-.48-2.49-.48-3.75 0-1.94.75-3.12 2.63-3.12 5.1v5.47l-2 1.88V18h14v-.23z"></path></svg>
            </div>
            <div class="channel-icon" style="background-color: #3ea6ff; display: flex; align-items: center; justify-content: center; font-weight: bold;">U</div>
        </div>
    </header>

    <nav class="sidebar" id="sidebar">
        <div class="sidebar-item active" onclick="navigate('home')">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M4 10V21h6v-6h4v6h6V10l-8-7z"></path></svg>
            <span>Ana Sayfa</span>
        </div>
        <div class="sidebar-item" onclick="navigate('shorts')">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M17.7 7L12 3.8 6.3 7 12 10.2zM3 10.8v6.4l5.7 3.2V14l-5.7-3.2zm12.3 9.6l5.7-3.2v-6.4l-5.7 3.2v6.4z"></path></svg>
            <span>Shorts</span>
        </div>
        <div class="sidebar-item">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M10 18v-6l5 3-5 3zm7-15H7v1h10V3zm3 3H4v1h16V6zm2 3H2v12h20V9zM3 10h18v10H3V10z"></path></svg>
            <span>Abonelikler</span>
        </div>
        <div class="sidebar-divider"></div>
        <div class="sidebar-item">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M4 6h16v1h-16v-1zm0 5h16v1h-16v-1zm0 5h16v1h-16v-1z"></path></svg>
            <span>Kitaplık</span>
        </div>
        <div class="sidebar-item">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M14.97 16.95 10 13.87V7h2v5.76l4.03 2.49-1.06 1.7zM22 12c0 5.52-4.48 10-10 10S2 17.52 2 12 6.48 2 12 2s10 4.48 10 10zm-1 0c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9 9-4.04 9-9z"></path></svg>
            <span>Geçmiş</span>
        </div>
    </nav>

    <main class="main-content" id="home-view">
        <div class="video-grid" id="main-video-grid">
            </div>

        <section class="shorts-section">
            <div class="shorts-header">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="red"><path d="M17.77 10.32l-1.2-.5L18 8.82a3.74 3.74 0 00-2.45-5.75 3.74 3.74 0 00-2.69.95l-9.3 5.37a3.74 3.74 0 00-.03 6.48l1.2.5L3.5 17.37a3.74 3.74 0 005.14 4.8 3.74 3.74 0 002.69-.95l9.3-5.37a3.74 3.74 0 00.03-6.48-.01.01 0 00-.89-.05zM10 14.65v-5.3L14.5 12 10 14.65z"></path></svg>
                <h3>Shorts</h3>
            </div>
            <div class="shorts-grid" id="home-shorts-grid">
                </div>
        </section>

        <div class="video-grid" id="secondary-video-grid"></div>
    </main>

    <div id="shorts-overlay">
        <div class="icon-btn" style="position: absolute; top: 20px; left: 20px; z-index: 2500;" onclick="closeShorts()">
            <svg viewBox="0 0 24 24" width="32" height="32" fill="white"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
        </div>
        <div class="shorts-wrapper" id="shorts-scroller">
            </div>
    </div>

    <div id="player-overlay">
        <div class="player-content">
            <div class="main-player-area">
                <video id="main-video-element" controls autoplay></video>
                <div class="player-info">
                    <h2 id="player-title">Video Başlığı</h2>
                    <div class="player-actions">
                        <div class="action-btn" onclick="handleLike()">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z"></path></svg>
                            <span id="player-likes">0</span>
                        </div>
                        <div class="action-btn" onclick="handleShare()">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M11.73 6.36 11 5.38 2.03 16h11.7c-.52-1.33-.73-2.73-.73-4.13 0-1.92.56-3.79 1.73-5.51zM21 16c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"></path></svg>
                            <span>Paylaş</span>
                        </div>
                    </div>
                    <div class="player-description" id="player-desc">Açıklama alanı...</div>
                </div>
                <div class="comment-section">
                    <h3 id="comment-count">0 Yorum</h3>
                    <div class="comment-input-area">
                        <div class="channel-icon"></div>
                        <input type="text" id="comment-input" style="flex:1; background:transparent; border:none; border-bottom:1px solid #333; color:white; padding:8px;" placeholder="Yorum ekleyin...">
                        <button class="upload-btn" onclick="addComment()">Yorum Yap</button>
                    </div>
                    <div id="comments-list"></div>
                </div>
            </div>
            <div class="sidebar-suggestions" id="suggestion-list">
                </div>
        </div>
        <div class="icon-btn" style="position: fixed; top: 12px; right: 24px;" onclick="closePlayer()">
            <svg viewBox="0 0 24 24" width="32" height="32" fill="white"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
        </div>
    </div>

    <div class="modal-overlay" id="upload-modal">
        <div class="upload-modal">
            <div class="modal-header">
                <h3>Video Yükle</h3>
                <div class="icon-btn" onclick="closeUploadModal()">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
                </div>
            </div>
            <div class="modal-body" id="modal-initial">
                <div class="upload-circle">
                    <svg viewBox="0 0 24 24" width="60" height="60" fill="#909090"><path d="M17 13h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"></path></svg>
                </div>
                <p>Yayınlamak için video dosyalarını sürükleyip bırakın</p>
                <input type="file" id="video-file-input" hidden accept="video/*">
                <button class="upload-btn" onclick="document.getElementById('video-file-input').click()">DOSYA SEÇ</button>
            </div>
            <div class="modal-body hidden" id="modal-details">
                <div class="input-group">
                    <label>Başlık (zorunlu)</label>
                    <input type="text" id="video-title" class="input-field" placeholder="Videonuzu anlatan bir başlık ekleyin">
                </div>
                <div class="input-group">
                    <label>Açıklama</label>
                    <textarea id="video-desc" class="input-field" style="height: 120px; resize: none;" placeholder="İzleyicilere videonuz hakkında bilgi verin"></textarea>
                </div>
                <div class="progress-container" id="upload-progress-container">
                    <div class="progress-bar" id="upload-progress-bar"></div>
                </div>
                <p id="upload-status" style="font-size: 14px; color: #3ea6ff;"></p>
                <button class="upload-btn" id="finish-upload-btn" style="align-self: flex-end;">YAYINLA</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">Toast mesajı</div>
    <canvas id="hidden-canvas" class="hidden"></canvas>

    <script>
        /**
         * INDEXEDDB ARCHITECTURE
         * Amacı: Sayfa yenilendiğinde Blob verilerinin kalıcılığını sağlamak.
         */
        const DB_NAME = "ProTube_Persistent_Storage";
        const DB_VERSION = 1;
        let db;

        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    if (!database.objectStoreNames.contains("videos")) {
                        database.createObjectStore("videos", { keyPath: "id" });
                    }
                };
                request.onsuccess = (e) => {
                    db = e.target.result;
                    resolve(db);
                };
                request.onerror = (e) => reject("DB Init Error");
            });
        };

        const saveVideoToDB = (videoData) => {
            const transaction = db.transaction(["videos"], "readwrite");
            const store = transaction.objectStore("videos");
            return new Promise((resolve) => {
                const req = store.put(videoData);
                req.onsuccess = () => resolve();
            });
        };

        const getAllVideosFromDB = () => {
            const transaction = db.transaction(["videos"], "readonly");
            const store = transaction.objectStore("videos");
            return new Promise((resolve) => {
                const req = store.getAll();
                req.onsuccess = () => resolve(req.result);
            });
        };

        const updateVideoStats = (id, stats) => {
            const transaction = db.transaction(["videos"], "readwrite");
            const store = transaction.objectStore("videos");
            store.get(id).onsuccess = (e) => {
                const data = e.target.result;
                data.stats = stats;
                store.put(data);
            };
        };

        /**
         * GLOBAL STATE & CORE LOGIC
         */
        let currentVideos = [];
        let activePlayerId = null;
        let objectUrls = new Set();

        const showToast = (msg) => {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        };

        const createSecureUrl = (blob) => {
            const url = URL.createObjectURL(blob);
            objectUrls.add(url);
            return url;
        };

        const clearObjectUrls = () => {
            objectUrls.forEach(url => URL.revokeObjectURL(url));
            objectUrls.clear();
        };

        /**
         * MEDIA PROCESSING (THUMBNAIL & DURATION)
         */
        const processMedia = (file) => {
            return new Promise((resolve) => {
                const video = document.createElement('video');
                video.preload = 'metadata';
                video.src = URL.createObjectURL(file);
                
                video.onloadedmetadata = () => {
                    const duration = video.duration;
                    const type = duration <= 60 ? 'shorts' : 'long';
                    
                    // Thumbnail generate at 1st second
                    video.currentTime = Math.min(1, duration);
                    video.onseeked = () => {
                        const canvas = document.getElementById('hidden-canvas');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        
                        canvas.toBlob((thumbBlob) => {
                            URL.revokeObjectURL(video.src);
                            resolve({ duration, type, thumbBlob });
                        }, 'image/jpeg', 0.8);
                    };
                };
            });
        };

        /**
         * UI RENDERERS
         */
        const renderLibrary = async () => {
            const videos = await getAllVideosFromDB();
            currentVideos = videos;
            
            const grid = document.getElementById('main-video-grid');
            const homeShorts = document.getElementById('home-shorts-grid');
            const secondaryGrid = document.getElementById('secondary-video-grid');
            const shortsScroller = document.getElementById('shorts-scroller');

            grid.innerHTML = '';
            homeShorts.innerHTML = '';
            secondaryGrid.innerHTML = '';
            shortsScroller.innerHTML = '';

            // Render Long Videos
            const longVideos = videos.filter(v => v.type === 'long').sort((a,b) => b.createdAt - a.createdAt);
            longVideos.forEach((v, index) => {
                const tUrl = createSecureUrl(v.thumbnailBlob);
                const card = `
                    <div class="video-card" onclick="openPlayer('${v.id}')">
                        <div class="thumbnail-container">
                            <img src="${tUrl}">
                            <div class="duration-badge">${formatTime(v.duration)}</div>
                        </div>
                        <div class="video-info">
                            <div class="channel-icon" style="background:#${Math.floor(Math.random()*16777215).toString(16)}"></div>
                            <div class="video-details">
                                <h3>${v.title}</h3>
                                <div class="video-meta">User Name • ${v.stats.views} görüntüleme</div>
                            </div>
                        </div>
                    </div>
                `;
                if(index < 8) grid.innerHTML += card;
                else secondaryGrid.innerHTML += card;
            });

            // Render Shorts
            const shorts = videos.filter(v => v.type === 'shorts').sort((a,b) => b.createdAt - a.createdAt);
            shorts.forEach(s => {
                const tUrl = createSecureUrl(s.thumbnailBlob);
                // Home Grid
                homeShorts.innerHTML += `
                    <div class="short-card" onclick="openShorts('${s.id}')">
                        <img src="${tUrl}">
                        <div class="short-info">
                            <div class="short-title">${s.title}</div>
                            <div class="video-meta">${s.stats.views} görüntüleme</div>
                        </div>
                    </div>
                `;
                // Vertical Scroller
                const sUrl = createSecureUrl(s.videoBlob);
                const shortElement = document.createElement('div');
                shortElement.className = 'short-player-container';
                shortElement.id = `short-item-${s.id}`;
                shortElement.innerHTML = `
                    <video class="short-video" src="${sUrl}" loop></video>
                    <div class="short-controls-overlay">
                        <div class="control-item">
                            <div class="control-btn" onclick="interaction('like', '${s.id}')">
                                <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z"></path></svg>
                            </div>
                            <span id="short-likes-${s.id}">${s.stats.likes}</span>
                        </div>
                        <div class="control-item">
                            <div class="control-btn" onclick="showToast('Yorumlar yakında!')">
                                <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"></path></svg>
                            </div>
                            <span>${s.stats.comments.length}</span>
                        </div>
                    </div>
                    <div class="short-info">
                        <h3 style="margin-bottom:8px">@UserHandle</h3>
                        <p>${s.title}</p>
                    </div>
                `;
                shortsScroller.appendChild(shortElement);
            });
        };

        /**
         * MODAL & UPLOAD LOGIC
         */
        const openUploadModal = () => document.getElementById('upload-modal').style.display = 'flex';
        const closeUploadModal = () => {
            document.getElementById('upload-modal').style.display = 'none';
            document.getElementById('modal-initial').classList.remove('hidden');
            document.getElementById('modal-details').classList.add('hidden');
            document.getElementById('upload-progress-container').style.display = 'none';
        };

        document.getElementById('video-file-input').onchange = async (e) => {
            const file = e.target.files[0];
            if(!file) return;

            document.getElementById('modal-initial').classList.add('hidden');
            document.getElementById('modal-details').classList.remove('hidden');
            document.getElementById('video-title').value = file.name.split('.')[0];

            const finishBtn = document.getElementById('finish-upload-btn');
            finishBtn.onclick = async () => {
                const title = document.getElementById('video-title').value;
                const desc = document.getElementById('video-desc').value;
                if(!title) return alert("Başlık zorunludur!");

                finishBtn.disabled = true;
                const progressContainer = document.getElementById('upload-progress-container');
                const progressBar = document.getElementById('upload-progress-bar');
                const status = document.getElementById('upload-status');
                
                progressContainer.style.display = 'block';
                
                // Simulate 10s Fake Upload as per instruction
                for(let i=0; i<=100; i++){
                    progressBar.style.width = i + '%';
                    status.innerText = `%${i} yükleniyor...`;
                    await new Promise(r => setTimeout(r, 100));
                }

                status.innerText = "İşleniyor...";
                const mediaInfo = await processMedia(file);

                const newVideo = {
                    id: 'vid_' + Date.now(),
                    title: title,
                    description: desc,
                    videoBlob: file,
                    thumbnailBlob: mediaInfo.thumbBlob,
                    duration: mediaInfo.duration,
                    type: mediaInfo.type,
                    createdAt: Date.now(),
                    stats: {
                        likes: 0,
                        views: 0,
                        comments: []
                    }
                };

                await saveVideoToDB(newVideo);
                showToast("Video başarıyla yayınlandı!");
                closeUploadModal();
                renderLibrary();
            };
        };

        /**
         * PLAYER & NAVIGATION
         */
        const openPlayer = (id) => {
            const video = currentVideos.find(v => v.id === id);
            if(!video) return;

            activePlayerId = id;
            const overlay = document.getElementById('player-overlay');
            const vElement = document.getElementById('main-video-element');
            
            overlay.style.display = 'block';
            document.body.style.overflow = 'hidden';

            vElement.src = createSecureUrl(video.videoBlob);
            document.getElementById('player-title').innerText = video.title;
            document.getElementById('player-desc').innerText = video.description || "Açıklama bulunmuyor.";
            document.getElementById('player-likes').innerText = video.stats.likes;
            document.getElementById('comment-count').innerText = `${video.stats.comments.length} Yorum`;
            
            // View count logic
            video.stats.views++;
            updateVideoStats(id, video.stats);
            renderComments(video.stats.comments);
            renderSuggestions(id);
        };

        const closePlayer = () => {
            document.getElementById('player-overlay').style.display = 'none';
            document.getElementById('main-video-element').pause();
            document.getElementById('main-video-element').src = "";
            document.body.style.overflow = 'auto';
            activePlayerId = null;
        };

        const openShorts = (id) => {
            document.getElementById('shorts-overlay').style.display = 'flex';
            const target = document.getElementById(`short-item-${id}`);
            if(target) {
                target.scrollIntoView();
                const v = target.querySelector('video');
                if(v) v.play();
            }
        };

        const closeShorts = () => {
            document.getElementById('shorts-overlay').style.display = 'none';
            const videos = document.querySelectorAll('.short-video');
            videos.forEach(v => v.pause());
        };

        /**
         * INTERACTIONS
         */
        const handleLike = () => {
            const video = currentVideos.find(v => v.id === activePlayerId);
            video.stats.likes++;
            document.getElementById('player-likes').innerText = video.stats.likes;
            updateVideoStats(activePlayerId, video.stats);
            showToast("Beğenildi!");
        };

        const interaction = (type, id) => {
            const video = currentVideos.find(v => v.id === id);
            if(type === 'like') {
                video.stats.likes++;
                const el = document.getElementById(`short-likes-${id}`);
                if(el) el.innerText = video.stats.likes;
                updateVideoStats(id, video.stats);
                showToast("Beğenildi!");
            }
        };

        const handleShare = () => {
            navigator.clipboard.writeText(window.location.href);
            showToast("Link kopyalandı!");
        };

        const addComment = () => {
            const input = document.getElementById('comment-input');
            const text = input.value.trim();
            if(!text) return;

            const video = currentVideos.find(v => v.id === activePlayerId);
            const newComment = {
                id: Date.now(),
                user: 'Misafir Kullanıcı',
                text: text,
                date: 'Şimdi'
            };

            video.stats.comments.unshift(newComment);
            updateVideoStats(activePlayerId, video.stats);
            input.value = '';
            renderComments(video.stats.comments);
            document.getElementById('comment-count').innerText = `${video.stats.comments.length} Yorum`;
            showToast("Yorum eklendi!");
        };

        const renderComments = (comments) => {
            const list = document.getElementById('comments-list');
            list.innerHTML = comments.map(c => `
                <div class="comment-item">
                    <div class="channel-icon" style="background:#888"></div>
                    <div>
                        <div style="font-size:13px; font-weight:bold; margin-bottom:4px">${c.user} <span style="font-weight:normal; color:#aaa; margin-left:8px">${c.date}</span></div>
                        <div style="font-size:14px">${c.text}</div>
                    </div>
                </div>
            `).join('');
        };

        const renderSuggestions = (currentId) => {
            const sugList = document.getElementById('suggestion-list');
            const others = currentVideos.filter(v => v.id !== currentId && v.type === 'long');
            sugList.innerHTML = others.map(v => `
                <div class="video-card" style="flex-direction:row; gap:8px; margin-bottom:12px;" onclick="closePlayer(); openPlayer('${v.id}')">
                    <div class="thumbnail-container" style="width:160px; height:90px; flex-shrink:0;">
                        <img src="${URL.createObjectURL(v.thumbnailBlob)}">
                    </div>
                    <div>
                        <h4 style="font-size:14px; line-height:1.2; margin-bottom:4px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;">${v.title}</h4>
                        <div style="font-size:12px; color:#aaa">User Name</div>
                        <div style="font-size:12px; color:#aaa">${v.stats.views} görüntüleme</div>
                    </div>
                </div>
            `).join('');
        };

        /**
         * UTILS
         */
        const formatTime = (seconds) => {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return h > 0 
                ? `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`
                : `${m}:${s.toString().padStart(2,'0')}`;
        };

        const toggleSidebar = () => {
            const side = document.getElementById('sidebar');
            const main = document.querySelector('.main-content');
            if(side.style.width === '0px') {
                side.style.width = '240px';
                main.style.marginLeft = '240px';
            } else {
                side.style.width = '0px';
                main.style.marginLeft = '0px';
            }
        };

        const navigate = (view) => {
            if(view === 'shorts') {
                const firstShort = currentVideos.find(v => v.type === 'shorts');
                if(firstShort) openShorts(firstShort.id);
                else showToast("Henüz Shorts yüklenmemiş!");
            } else {
                closePlayer();
                closeShorts();
            }
        };

        /**
         * INITIALIZATION & PERSISTENCE LOAD
         */
        window.onload = async () => {
            await initDB();
            renderLibrary();

            // Shorts scroll listener for auto-play
            const scroller = document.getElementById('shorts-scroller');
            scroller.onscroll = () => {
                const containers = document.querySelectorAll('.short-player-container');
                containers.forEach(container => {
                    const rect = container.getBoundingClientRect();
                    const v = container.querySelector('video');
                    if(rect.top >= 0 && rect.top < window.innerHeight / 2) {
                        if(v.paused) v.play();
                    } else {
                        v.pause();
                    }
                });
            };
        };

        // UI Logic for Sidebar Active State
        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
            });
        });

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PDF KAYNAK - ADMIN PRO</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js?56"></script>
    <script src='//libtl.com/sdk.js' data-zone='10384475' data-sdk='show_10384475'></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root { --bg: #F8FAFC; --white: #FFFFFF; --primary: #6366F1; --text-main: #0F172A; --text-sub: #64748B; --border: #E2E8F0; --coin: #F59E0B; --danger: #ef4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        .view { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 120px; display: none; }
        .view.active { display: block; }
        
        /* UI Elements */
        .header { padding: 20px; padding-top: 50px; background: var(--bg); display: flex; justify-content: space-between; align-items: center; }
        .btn { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 16px; font-weight: 700; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .inp, .sel { width: 100%; padding: 14px; border-radius: 16px; border: 2px solid var(--border); background: #fff; margin-bottom: 15px; outline: none; font-size: 14px; }
        
        /* Cards */
        .pdf-card { background: var(--white); padding: 15px; border-radius: 20px; border: 1px solid var(--border); text-align: center; }
        .cat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .cat-card { background: white; padding: 18px 10px; border-radius: 20px; border: 1px solid var(--border); text-align: center; cursor: pointer; }
        
        /* Navigation */
        .nav-container { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; z-index: 1000; }
        .nav { background: white; border-radius: 24px; display: flex; justify-content: space-around; padding: 12px; border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .nav-item { font-size: 22px; color: #CBD5E1; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 14px; }
        .nav-item.active { color: var(--primary); background: #EEF2FF; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-box { background: var(--white); width: 85%; max-width: 350px; border-radius: 24px; padding: 25px; text-align: center; }

        #toast-container { position: fixed; top: 60px; left: 0; width: 100%; z-index: 9999; display: flex; flex-direction: column; align-items: center; pointer-events: none; }
        .toast { background: #1E293B; color: white; padding: 10px 20px; border-radius: 50px; margin-bottom: 10px; font-size: 13px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div class="header">
        <div>
            <div style="font-size:11px; color:var(--text-sub);">Hoş Geldin,</div>
            <div style="font-weight:700;" id="u-name">Misafir</div>
        </div>
        <div style="font-weight:800; color:var(--coin); background:white; padding:6px 14px; border-radius:14px; border:1px solid var(--border);">
            <i class="fa-solid fa-coins"></i> <span class="global-bal">0</span>
        </div>
    </div>

    <div id="v-home" class="view active">
        <div style="background: linear-gradient(135deg, #6366F1, #A855F7); color: white; border-radius: 24px; padding: 24px; margin-bottom: 25px;">
            <h3 style="font-size:20px;">Yeni Kaynaklar</h3>
            <p style="font-size: 12px; opacity: 0.9;">Hemen branş seç ve çalışmaya başla.</p>
        </div>
        <h4 style="margin-bottom:10px;">Öne Çıkanlar</h4>
        <div id="home-featured" style="display: grid; grid-template-columns: 1fr 1fr; gap:12px;"></div>
    </div>

    <div id="v-pdfs" class="view">
        <div id="cat-selection">
            <h2 style="margin-bottom:15px;">Branşlar</h2>
            <div class="cat-grid" id="main-cat-grid"></div>
        </div>
        <div id="pdf-listing" style="display:none;">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                <button class="btn" style="width:40px; height:40px; padding:0; background:#EEF2FF; color:var(--primary);" onclick="backToCats()"><i class="fa-solid fa-arrow-left"></i></button>
                <h3 id="selected-cat-title">Liste</h3>
            </div>
            <div id="pdf-list" style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;"></div>
        </div>
    </div>

    <div id="v-earn" class="view">
        <h2 style="margin-bottom:15px; color:var(--coin);">Jeton Kazan</h2>
        <button class="btn" id="btn-watch-ad" style="height:150px; flex-direction:column; border:2px dashed var(--primary); background:#EEF2FF; color:var(--primary);" onclick="watchAdAndEarn()">
            <i class="fa-solid fa-play-circle" style="font-size:40px; margin-bottom:10px;"></i>
            <span id="ad-text">Reklam İzle +1 Jeton</span>
        </button>
    </div>

    <div id="v-admin" class="view">
        <h2 style="margin-bottom:20px;"><i class="fa-solid fa-user-shield"></i> Admin Paneli</h2>
        
        <div style="background: white; padding: 20px; border-radius: 20px; border: 1px solid var(--border);">
            <label style="font-size: 12px; font-weight: 700; color: var(--text-sub);">PDF Adı</label>
            <input class="inp" id="adm-name" placeholder="Örn: Limit Türev Fasikül">
            
            <label style="font-size: 12px; font-weight: 700; color: var(--text-sub);">PDF Link (Google Drive/Mega vb.)</label>
            <input class="inp" id="adm-link" placeholder="https://...">
            
            <label style="font-size: 12px; font-weight: 700; color: var(--text-sub);">Branş Seç</label>
            <select class="sel" id="adm-cat"></select>
            
            <label style="font-size: 12px; font-weight: 700; color: var(--text-sub);">Fiyat (Jeton)</label>
            <input class="inp" type="number" id="adm-cost" value="5">
            
            <button class="btn" onclick="adminAddPdf()" id="btn-add-pdf">PDF'i Sisteme Yükle</button>
        </div>

        <div style="margin-top: 30px;">
            <h4>Yüklü PDF'ler</h4>
            <div id="admin-pdf-list" style="margin-top: 10px;"></div>
        </div>
    </div>

    <div id="m-unlock" class="modal-overlay">
        <div class="modal-box">
            <h3 id="unlock-title">Kitabı Aç</h3>
            <p id="unlock-msg" style="margin:15px 0; color:var(--text-sub); font-size: 14px;"></p>
            <button class="btn" id="btn-unlock-confirm" style="background:var(--coin);">Onayla ve Aç</button>
            <button class="btn" style="margin-top:10px; background:#f1f5f9; color:#475569;" onclick="closeM()">İptal</button>
        </div>
    </div>

    <div class="nav-container">
        <div class="nav">
            <div class="nav-item active" onclick="go('home',0)"><i class="fa-solid fa-house"></i></div>
            <div class="nav-item" onclick="go('pdfs',1)"><i class="fa-solid fa-book"></i></div>
            <div class="nav-item" onclick="go('earn',2)"><i class="fa-solid fa-video"></i></div>
            <div class="nav-item" onclick="go('admin',3)"><i class="fa-solid fa-lock"></i></div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyC18uinYQT9vOC-nhxv3x1WIhO_we3CRMY",
            authDomain: "pdfkaynak-51615.firebaseapp.com",
            projectId: "pdfkaynak-51615",
            storageBucket: "pdfkaynak-51615.firebasestorage.app",
            messagingSenderId: "228512804576",
            appId: "1:228512804576:web:a0bba02ca83b4fa7adea85"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const tg = window.Telegram.WebApp;
        
        let user = tg.initDataUnsafe.user || { id: "12345", first_name: "Test" };
        let balance = 0, pdfs = [], currentCat = '';
        const ADMIN_ID = "6348421832"; // Kendi Telegram ID'ni buraya yaz!

        const CATS = ["Matematik", "Geometri", "Fizik", "Kimya", "Biyoloji", "Türkçe", "Edebiyat", "Tarih", "Coğrafya", "Denemeler"];

        window.onload = () => {
            document.getElementById('u-name').innerText = user.first_name;
            
            // Veri Dinleme
            db.collection("users").doc(String(user.id)).onSnapshot(doc => {
                if(doc.exists) {
                    balance = doc.data().balance || 0;
                    document.querySelectorAll('.global-bal').forEach(el => el.innerText = balance);
                } else {
                    db.collection("users").doc(String(user.id)).set({name: user.first_name, balance: 0});
                }
            });

            db.collection("pdfs").onSnapshot(snap => {
                pdfs = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                renderHome();
                renderAdminList();
            });

            // Kategorileri Doldur
            const grid = document.getElementById('main-cat-grid');
            const sel = document.getElementById('adm-cat');
            CATS.forEach(c => {
                grid.innerHTML += `<div class="cat-card" onclick="openCat('${c}')"><span>${c}</span></div>`;
                sel.innerHTML += `<option value="${c}">${c}</option>`;
            });
        };

        // --- ADMIN İŞLEMLERİ ---
        async function adminAddPdf() {
            if(String(user.id) !== ADMIN_ID) {
                showToast("Bu yetki sadece kurucuya aittir!", "error");
                return;
            }

            const name = document.getElementById('adm-name').value;
            const link = document.getElementById('adm-link').value;
            const cat = document.getElementById('adm-cat').value;
            const cost = parseInt(document.getElementById('adm-cost').value);

            if(!name || !link) { showToast("Boş alan bırakmayın!", "error"); return; }

            const btn = document.getElementById('btn-add-pdf');
            btn.disabled = true;

            try {
                await db.collection("pdfs").add({ name, link, cat, cost, createdAt: Date.now() });
                showToast("PDF başarıyla eklendi!");
                document.getElementById('adm-name').value = '';
                document.getElementById('adm-link').value = '';
            } catch (e) {
                showToast("Yükleme hatası!", "error");
            } finally {
                btn.disabled = false;
            }
        }

        function renderAdminList() {
            const list = document.getElementById('admin-pdf-list');
            list.innerHTML = pdfs.map(p => `
                <div style="background:white; padding:10px; border-radius:12px; margin-bottom:5px; display:flex; justify-content:space-between; align-items:center; font-size:12px; border:1px solid var(--border);">
                    <span>${p.name} (${p.cat})</span>
                    <button onclick="adminDeletePdf('${p.id}')" style="background:none; border:none; color:var(--danger);"><i class="fa-solid fa-trash"></i></button>
                </div>
            `).join('');
        }

        async function adminDeletePdf(id) {
            if(!confirm("Bu PDF'i silmek istediğine emin misin?")) return;
            await db.collection("pdfs").doc(id).delete();
            showToast("Silindi.");
        }

        // --- UYGULAMA MANTIĞI ---
        function openCat(c) {
            currentCat = c;
            document.getElementById('cat-selection').style.display='none';
            document.getElementById('pdf-listing').style.display='block';
            document.getElementById('selected-cat-title').innerText = c;
            renderPdfs();
        }

        function backToCats() {
            document.getElementById('cat-selection').style.display='block';
            document.getElementById('pdf-listing').style.display='none';
        }

        function renderPdfs() {
            const list = document.getElementById('pdf-list');
            list.innerHTML = pdfs.filter(p => p.cat === currentCat).map(p => `
                <div class="pdf-card" onclick="tryUnlock('${p.id}')">
                    <i class="fa-solid fa-file-pdf" style="font-size:30px; color:var(--primary);"></i>
                    <div style="font-size:12px; font-weight:700; margin:10px 0;">${p.name}</div>
                    <div style="color:var(--coin); font-size:11px; font-weight:800;">${p.cost} Jeton</div>
                </div>
            `).join('');
        }

        function renderHome() {
            document.getElementById('home-featured').innerHTML = pdfs.slice(0, 4).map(p => `
                <div class="pdf-card" onclick="tryUnlock('${p.id}')">
                    <div style="font-size:12px; font-weight:700;">${p.name}</div>
                    <div style="color:var(--primary); font-size:10px; margin-top:5px;">${p.cat}</div>
                </div>
            `).join('');
        }

        async function watchAdAndEarn() {
            const btn = document.getElementById('btn-watch-ad');
            if(typeof show_10384475 !== 'function') return;
            
            btn.disabled = true;
            try {
                await show_10384475();
                await db.collection("users").doc(String(user.id)).update({
                    balance: firebase.firestore.FieldValue.increment(1)
                });
                showToast("+1 Jeton eklendi!");
            } catch(e) { showToast("Reklam tamamlanmadı.", "error"); }
            finally { btn.disabled = false; }
        }

        function tryUnlock(id) {
            const p = pdfs.find(x => x.id === id);
            document.getElementById('unlock-msg').innerText = `${p.name} açmak için ${p.cost} jeton kesilecek.`;
            document.getElementById('btn-unlock-confirm').onclick = async () => {
                if(balance >= p.cost) {
                    await db.collection("users").doc(String(user.id)).update({
                        balance: firebase.firestore.FieldValue.increment(-p.cost)
                    });
                    copyLink(p.link);
                    showToast("Başarılı! Link kopyalandı.");
                    closeM();
                } else {
                    showToast("Yetersiz jeton!", "error");
                    go('earn', 2);
                    closeM();
                }
            };
            openModal('m-unlock');
        }

        // --- HELPER ---
        function go(v, i) {
            document.querySelectorAll('.view').forEach(x => x.classList.remove('active'));
            document.getElementById('v-'+v).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.nav-item')[i].classList.add('active');
        }
        function copyLink(l) { 
            const i = document.createElement('input'); i.value = l; 
            document.body.appendChild(i); i.select(); 
            document.execCommand('copy'); i.remove(); 
        }
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeM() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display='none'); }
        function showToast(m, type="success") {
            const t = document.createElement('div'); t.className = 'toast';
            if(type==="error") t.style.background = "#ef4444";
            t.innerText = m; document.getElementById('toast-container').appendChild(t);
            setTimeout(() => t.remove(), 2500);
        }
    </script>
</body>
</html>

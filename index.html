<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamX Production v6.0 | Base64 Persistence Engine</title>
    <style>
        :root {
            --bg: #0f0f0f; --side: #0f0f0f; --accent: #3ea6ff; --red: #ff0000;
            --text: #f1f1f1; --dim: #aaaaaa; --brd: rgba(255, 255, 255, 0.1);
            --glow: 0 0 15px rgba(62, 166, 255, 0.3); --trans: all 0.3s ease;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; }
        body.locked #app { filter: blur(20px); pointer-events: none; }

        /* AUTH */
        #gate { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .auth-card { background: #1e1e1e; padding: 40px; border-radius: 24px; width: 400px; text-align: center; border: 1px solid var(--brd); }
        input { width: 100%; padding: 12px; margin: 10px 0; background: #000; border: 1px solid #333; color: #fff; border-radius: 10px; outline: none; }
        .btn { cursor: pointer; border: none; transition: var(--trans); font-weight: 700; border-radius: 10px; }
        .btn-p { background: var(--accent); color: #000; width: 100%; padding: 14px; }

        /* LAYOUT */
        #app { display: grid; grid-template-columns: 240px 1fr; grid-template-rows: 60px 1fr; height: 100vh; }
        header { grid-column: 1/-1; border-bottom: 1px solid var(--brd); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 100; }
        aside { border-right: 1px solid var(--brd); padding: 10px; overflow-y: auto; }
        main { padding: 25px; overflow-y: auto; position: relative; scroll-behavior: smooth; }

        .nav-link { display: flex; align-items: center; gap: 15px; padding: 12px; border-radius: 10px; cursor: pointer; color: var(--text); text-decoration: none; font-size: 14px; }
        .nav-link:hover { background: rgba(255,255,255,0.05); }
        .nav-link.active { background: rgba(62,166,255,0.1); color: var(--accent); font-weight: 600; box-shadow: var(--glow); }

        /* GRID */
        .v-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .v-card { cursor: pointer; }
        .v-thumb { width: 100%; aspect-ratio: 16/9; background: #111; border-radius: 12px; overflow: hidden; position: relative; }
        .v-thumb img { width: 100%; height: 100%; object-fit: cover; }

        /* WATCH & SHORTS */
        #view-watch { display: none; grid-template-columns: 1fr 350px; gap: 25px; }
        .player-container { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 16px; overflow: hidden; }
        #view-shorts { display: none; height: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; }
        .short-frame { height: 100%; display: flex; justify-content: center; scroll-snap-align: start; padding: 10px 0; }
        .short-wrap { height: 100%; aspect-ratio: 9/16; background: #000; border-radius: 15px; overflow: hidden; position: relative; }

        /* UPLOAD MODAL */
        #up-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000; display: none; align-items: center; justify-content: center; }
        .up-box { background: #222; width: 800px; border-radius: 20px; overflow: hidden; display: flex; flex-direction: column; }
        .drop-zone { height: 300px; border: 2px dashed #444; margin: 20px; border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .up-form { display: none; padding: 20px; grid-template-columns: 1fr 250px; gap: 20px; }
        .progress-box { padding: 20px; display: none; }
        .bar-bg { height: 6px; background: #111; border-radius: 3px; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; background: var(--accent); transition: 0.2s; }

        /* MINI PLAYER */
        #mini { position: fixed; bottom: 20px; right: 20px; width: 300px; aspect-ratio: 16/9; background: #000; border-radius: 12px; display: none; z-index: 4000; border: 2px solid #333; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); cursor: move; }
        #mini:hover .mini-ctrl { opacity: 1; }
        .mini-ctrl { position: absolute; inset: 0; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; gap: 15px; opacity: 0; transition: 0.2s; }

        /* TOAST */
        #t-area { position: fixed; bottom: 20px; left: 20px; z-index: 10000; }
        .toast { background: #fff; color: #000; padding: 12px 24px; border-radius: 8px; font-weight: 700; margin-top: 10px; animation: tIn 0.3s ease-out; }
        @keyframes tIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="locked">

    <div id="gate">
        <div class="auth-card">
            <h1 style="margin-bottom:10px;">Stream<span style="color:var(--red)">X</span></h1>
            <p style="color:var(--dim); font-size:12px; margin-bottom:20px;">8392479231 | Root Access</p>
            <input type="text" id="un" placeholder="Kullanƒ±cƒ± Adƒ±">
            <input type="email" id="em" placeholder="E-posta">
            <button onclick="sx.auth()" class="btn btn-p">Platforma Giri≈ü Yap</button>
        </div>
    </div>

    <div id="app">
        <header>
            <div style="display:flex; align-items:center; gap:15px;">
                <span style="font-size:24px; cursor:pointer;">‚ò∞</span>
                <h2 style="cursor:pointer;" onclick="sx.nav('home')">Stream<span style="color:var(--red)">X</span></h2>
            </div>
            <div style="display:flex; align-items:center; gap:20px;">
                <button onclick="sx.openUp()" class="btn" style="padding:8px 16px; background:var(--accent); border-radius:20px;">+ Y√ºkle</button>
                <div id="pfp" style="width:36px; height:36px; border-radius:50%; background:#444; display:flex; align-items:center; justify-content:center; font-weight:bold;">?</div>
            </div>
        </header>

        <aside>
            <div class="nav-link active" onclick="sx.nav('home', this)"><i>üè†</i> Ana Sayfa</div>
            <div class="nav-link" onclick="sx.nav('shorts', this)"><i>üé¨</i> Shorts</div>
            <div class="nav-link" onclick="sx.nav('liked', this)"><i>‚ù§Ô∏è</i> Beƒüenilenler</div>
            <div class="nav-link" onclick="sx.nav('history', this)"><i>üïí</i> Ge√ßmi≈ü</div>
            <div style="margin-top:20px; padding:10px; font-size:12px; color:var(--dim);">Limit: 50MB (LocalStorage)</div>
        </aside>

        <main id="main">
            <div id="view-home" class="v-grid"></div>

            <div id="view-watch">
                <div class="w-left">
                    <div class="player-container">
                        <video id="p-main" controls autoplay style="width:100%; height:100%;"></video>
                    </div>
                    <div style="margin-top:20px;">
                        <h1 id="w-t">Video Ba≈ülƒ±ƒüƒ±</h1>
                        <div style="display:flex; justify-content:space-between; margin-top:15px; border-bottom:1px solid #333; padding-bottom:15px;">
                            <div style="display:flex; align-items:center; gap:12px;">
                                <div id="w-ava" style="width:40px; height:40px; border-radius:50%;"></div>
                                <b id="w-auth">Kanal</b>
                            </div>
                            <button onclick="sx.like()" class="btn" style="background:#222; padding:10px 20px; color:#fff; border-radius:20px;">üëç Beƒüen</button>
                        </div>
                    </div>
                </div>
                <div class="w-right">
                    <h4 style="margin-bottom:15px;">√ñnerilenler</h4>
                    <div id="rel-list"></div>
                </div>
            </div>

            <div id="view-shorts"></div>

            <div id="view-list" style="display:none">
                <h1 id="l-title" style="margin-bottom:20px;">Liste</h1>
                <div class="v-grid" id="l-grid"></div>
            </div>
        </main>
    </div>

    <div id="up-modal">
        <div class="up-box">
            <div style="padding:20px; border-bottom:1px solid #333; display:flex; justify-content:space-between;">
                <h3>Video Yayƒ±nla (Base64 Kayƒ±t)</h3>
                <span style="cursor:pointer;" onclick="sx.closeUp()">‚úï</span>
            </div>

            <div id="up-init" class="drop-zone" onclick="document.getElementById('f-in').click()">
                <div style="font-size:50px;">üì§</div>
                <p>Dosyayƒ± se√ßmek i√ßin tƒ±klayƒ±n</p>
                <input type="file" id="f-in" hidden accept="video/*">
            </div>

            <div id="up-loading" class="progress-box">
                <p id="up-st" style="margin-bottom:10px; font-weight:600;">Hazƒ±rlanƒ±yor... %0</p>
                <div class="bar-bg"><div id="up-bar" class="bar-fill"></div></div>
            </div>

            <div id="up-form" class="up-form">
                <div>
                    <input type="text" id="up-title" placeholder="Ba≈ülƒ±k (Zorunlu)">
                    <textarea id="up-desc" placeholder="A√ßƒ±klama" style="width:100%; height:100px; background:#000; border:1px solid #333; color:#fff; padding:10px; border-radius:10px; resize:none;"></textarea>
                </div>
                <div>
                    <div id="up-prev" style="width:100%; aspect-ratio:16/9; background:#000; border-radius:10px; overflow:hidden;"></div>
                    <button onclick="sx.publish()" class="btn btn-p" style="margin-top:15px;">YAYINLA</button>
                </div>
            </div>
        </div>
    </div>

    <div id="mini">
        <video id="p-mini" autoplay muted loop style="width:100%; height:100%; object-fit:cover;"></video>
        <div class="mini-ctrl">
            <button onclick="sx.restore()" style="padding:8px; border-radius:50%; border:none; cursor:pointer;">üî≥</button>
            <button onclick="sx.closeMini()" style="padding:8px; border-radius:50%; border:none; cursor:pointer;">‚úï</button>
        </div>
    </div>

    <div id="t-area"></div>

    <script>
        /**
         * STREAMX PERSISTENCE CORE v6.0
         * Admin: 8392479231
         */

        const sx = {
            db: {
                v: JSON.parse(localStorage.getItem('sx_v6_vids') || '[]'),
                u: JSON.parse(localStorage.getItem('sx_v6_user') || 'null'),
                h: JSON.parse(localStorage.getItem('sx_v6_hist') || '[]'),
                l: JSON.parse(localStorage.getItem('sx_v6_like') || '[]')
            },

            state: { view: 'home', active: null, upData: null },

            init() {
                if(this.db.u) this.unlock();
                this.renderGrid();
                this.setupUpload();
                this.setupDrag();
            },

            auth() {
                const un = document.getElementById('un').value;
                if(!un) return;
                this.db.u = { name: un, pfp: '#' + Math.floor(Math.random()*16777215).toString(16) };
                localStorage.setItem('sx_v6_user', JSON.stringify(this.db.u));
                this.unlock();
            },

            unlock() {
                document.body.classList.remove('locked');
                document.getElementById('gate').style.display = 'none';
                document.getElementById('pfp').innerText = this.db.u.name[0].toUpperCase();
                document.getElementById('pfp').style.background = this.db.u.pfp;
            },

            // PERSISTENT NAVIGATION
            nav(target, el) {
                if(el) {
                    document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
                    el.classList.add('active');
                }

                // Mini Player Logic
                const mainVid = document.getElementById('p-main');
                if(this.state.view === 'watch' && target !== 'watch' && !mainVid.paused) {
                    if(target === 'shorts') this.closeMini();
                    else this.openMini(mainVid.src);
                }

                this.state.view = target;
                ['view-home', 'view-watch', 'view-shorts', 'view-list'].forEach(v => document.getElementById(v).style.display = 'none');

                if(target === 'home') {
                    document.getElementById('view-home').style.display = 'grid';
                    this.renderGrid();
                } else if(target === 'shorts') {
                    document.getElementById('view-shorts').style.display = 'block';
                    this.renderShorts();
                    this.closeMini();
                } else if(target === 'watch') {
                    document.getElementById('view-watch').style.display = 'grid';
                    this.closeMini();
                } else {
                    document.getElementById('view-list').style.display = 'block';
                    this.renderList(target);
                }
            },

            // BASE64 UPLOAD ENGINE (THE SOLUTION)
            setupUpload() {
                const fi = document.getElementById('f-in');
                fi.onchange = async (e) => {
                    const file = e.target.files[0];
                    if(!file) return;

                    // Boyut kontrol√º (LocalStorage limiti i√ßin)
                    if(file.size > 40 * 1024 * 1024) {
                        return alert("Video √ßok b√ºy√ºk! L√ºtfen 40MB altƒ± bir dosya se√ßin.");
                    }

                    document.getElementById('up-init').style.display = 'none';
                    document.getElementById('up-loading').style.display = 'block';

                    // 1. Base64 Video Conversion
                    const videoBase64 = await this.toBase64(file);
                    
                    // 2. Temp Object URL for Preview & Meta (Only for this session)
                    const tempUrl = URL.createObjectURL(file);
                    
                    // 3. Metadata & Thumbnail
                    const thumb = await this.genThumb(tempUrl);
                    const dur = await this.getDur(tempUrl);

                    this.state.upData = { videoBase64, thumb, dur };

                    // Fake Progress
                    for(let i=0; i<=100; i++) {
                        await new Promise(r => setTimeout(r, 20));
                        document.getElementById('up-bar').style.width = i + '%';
                        document.getElementById('up-st').innerText = `ƒ∞≈üleniyor... %${i}`;
                    }

                    document.getElementById('up-loading').style.display = 'none';
                    document.getElementById('up-form').style.display = 'grid';
                    document.getElementById('up-prev').innerHTML = `<img src="${thumb}" style="width:100%; height:100%; object-fit:cover;">`;
                };
            },

            toBase64(file) {
                return new Promise((res, rej) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => res(reader.result);
                    reader.onerror = e => rej(e);
                });
            },

            async genThumb(url) {
                return new Promise(res => {
                    const v = document.createElement('video');
                    v.src = url; v.currentTime = 1; v.muted = true;
                    v.onseeked = () => {
                        const c = document.createElement('canvas');
                        c.width = 640; c.height = 360;
                        c.getContext('2d').drawImage(v, 0, 0, 640, 360);
                        res(c.toDataURL('image/jpeg', 0.7)); // Komprese edilmi≈ü thumbnail
                    };
                });
            },

            getDur(url) {
                return new Promise(res => {
                    const v = document.createElement('video');
                    v.src = url;
                    v.onloadedmetadata = () => res(v.duration);
                });
            },

            publish() {
                const t = document.getElementById('up-title').value;
                if(!t) return alert("Ba≈ülƒ±k ≈üart!");

                const d = this.state.upData;
                const newVid = {
                    id: Date.now(),
                    title: t,
                    src: d.videoBase64, // KALICI VERƒ∞
                    thumb: d.thumb,    // KALICI VERƒ∞
                    dur: d.dur,
                    type: d.dur <= 60 ? 'short' : 'long',
                    author: this.db.u.name,
                    authorPfp: this.db.u.pfp,
                    views: 0,
                    likes: 0
                };

                try {
                    this.db.v.unshift(newVid);
                    localStorage.setItem('sx_v6_vids', JSON.stringify(this.db.v));
                    this.toast("Video ba≈üarƒ±yla kaydedildi!");
                    location.reload(); // State temizliƒüi ve taze ba≈ülangƒ±√ß
                } catch(e) {
                    alert("Hafƒ±za dolu! L√ºtfen bazƒ± videolarƒ± silin veya daha k√º√ß√ºk bir video y√ºkleyin.");
                    this.db.v.shift();
                }
            },

            // RENDERING
            renderGrid() {
                const container = document.getElementById('view-home');
                container.innerHTML = '';
                this.db.v.forEach(vid => {
                    container.innerHTML += `
                        <div class="v-card" onclick="sx.watch(${vid.id})">
                            <div class="v-thumb">
                                <img src="${vid.thumb}">
                                <span style="position:absolute; bottom:5px; right:5px; background:rgba(0,0,0,0.8); padding:2px 5px; font-size:12px; border-radius:4px;">${Math.floor(vid.dur)} sn</span>
                            </div>
                            <div style="display:flex; gap:10px; margin-top:10px;">
                                <div style="width:32px; height:32px; border-radius:50%; background:${vid.authorPfp}"></div>
                                <div>
                                    <b style="font-size:14px; display:block;">${vid.title}</b>
                                    <small style="color:var(--dim)">${vid.author} ‚Ä¢ ${vid.views} izlenme</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
            },

            renderShorts() {
                const c = document.getElementById('view-shorts');
                c.innerHTML = '';
                const shorts = this.db.v.filter(v => v.type === 'short');
                shorts.forEach(s => {
                    c.innerHTML += `
                        <div class="short-frame">
                            <div class="short-wrap">
                                <video src="${s.src}" loop autoplay muted style="width:100%; height:100%; object-fit:cover;"></video>
                                <div style="position:absolute; bottom:20px; left:15px;">
                                    <b>@${s.author}</b>
                                    <p>${s.title}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
            },

            watch(id) {
                const vid = this.db.v.find(x => x.id == id);
                this.state.active = vid;
                this.nav('watch');

                const p = document.getElementById('p-main');
                p.src = vid.src; // Base64'ten oynatƒ±r
                p.play();

                document.getElementById('w-t').innerText = vid.title;
                document.getElementById('w-auth').innerText = vid.author;
                document.getElementById('w-ava').style.background = vid.authorPfp;

                vid.views++;
                if(!this.db.h.includes(id)) this.db.h.unshift(id);
                localStorage.setItem('sx_v6_vids', JSON.stringify(this.db.v));
                localStorage.setItem('sx_v6_hist', JSON.stringify(this.db.h));
            },

            // MINI PLAYER
            openMini(src) {
                const m = document.getElementById('mini');
                const v = document.getElementById('p-mini');
                v.src = src;
                m.style.display = 'block';
            },
            closeMini() { document.getElementById('mini').style.display = 'none'; document.getElementById('p-mini').pause(); },
            restore() { if(this.state.active) this.nav('watch'); },

            // UTILS
            toast(m) {
                const t = document.createElement('div');
                t.className = 'toast'; t.innerText = m;
                document.getElementById('t-area').appendChild(t);
                setTimeout(() => t.remove(), 3000);
            },
            openUp() { document.getElementById('up-modal').style.display = 'flex'; },
            closeUp() { document.getElementById('up-modal').style.display = 'none'; },
            setupDrag() {
                const m = document.getElementById('mini');
                let d = false, ox, oy;
                m.onmousedown = (e) => { d = true; ox = e.clientX - m.offsetLeft; oy = e.clientY - m.offsetTop; };
                window.onmousemove = (e) => { if(d) { m.style.left = (e.clientX - ox) + 'px'; m.style.top = (e.clientY - oy) + 'px'; m.style.bottom = 'auto'; m.style.right = 'auto'; } };
                window.onmouseup = () => d = false;
            }
        };

        sx.init();
    </script>
</body>
</html>

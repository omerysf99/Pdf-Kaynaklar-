<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PDF KAYNAK PRO - ADMIN</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js?56"></script>
    <script src='//libtl.com/sdk.js' data-zone='10384475' data-sdk='show_10384475'></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root { 
            --bg: #F8FAFC; --white: #FFFFFF; --primary: #6366F1; 
            --text-main: #0F172A; --text-sub: #64748B; --border: #E2E8F0; 
            --coin: #F59E0B; --danger: #EF4444; --success: #22C55E;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background-color: var(--bg); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* Kaydƒ±rma ve G√∂r√ºn√ºm */
        .view { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 120px; display: none; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* √úst Men√º */
        .header { padding: 20px; padding-top: 50px; display: flex; justify-content: space-between; align-items: center; background: var(--bg); }
        .user-box { display: flex; align-items: center; gap: 10px; }
        .coin-badge { font-weight: 800; color: var(--coin); background: white; padding: 8px 16px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* Kartlar */
        .card { background: white; border-radius: 24px; padding: 20px; border: 1px solid var(--border); margin-bottom: 20px; }
        .pdf-card { background: white; padding: 15px; border-radius: 20px; border: 1px solid var(--border); text-align: center; transition: 0.2s; cursor: pointer; }
        .pdf-card:active { transform: scale(0.95); }
        
        /* Grid Sistemleri */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        /* Bran≈ülar */
        .cat-card { background: white; padding: 20px 10px; border-radius: 20px; border: 1px solid var(--border); text-align: center; font-weight: 700; color: var(--text-main); }

        /* Form Elemanlarƒ± */
        .inp, .sel { width: 100%; padding: 15px; border-radius: 16px; border: 2px solid var(--border); background: #fff; margin-bottom: 15px; outline: none; font-size: 14px; transition: 0.2s; }
        .inp:focus { border-color: var(--primary); }
        
        .btn { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 16px; font-weight: 700; width: 100%; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-outline { background: #EEF2FF; color: var(--primary); border: 1px solid var(--primary); }
        .btn:disabled { opacity: 0.5; }

        /* Alt Navigasyon */
        .nav-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; z-index: 1000; }
        .nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 28px; display: flex; justify-content: space-around; padding: 12px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .nav-item { font-size: 20px; color: #CBD5E1; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 16px; transition: 0.3s; }
        .nav-item.active { color: var(--primary); background: #EEF2FF; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: white; width: 85%; max-width: 350px; border-radius: 28px; padding: 30px; text-align: center; }

        /* Toast Bildirim */
        #toast-container { position: fixed; top: 60px; left: 0; width: 100%; z-index: 9999; display: flex; flex-direction: column; align-items: center; pointer-events: none; }
        .toast { background: #1E293B; color: white; padding: 12px 24px; border-radius: 50px; margin-bottom: 10px; font-size: 13px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div class="header">
        <div class="user-box">
            <div style="width:40px; height:40px; background:#EEF2FF; border-radius:12px; display:flex; align-items:center; justify-content:center; color:var(--primary);">
                <i class="fa-solid fa-user"></i>
            </div>
            <div>
                <div style="font-size:10px; color:var(--text-sub); text-transform: uppercase; letter-spacing: 1px;">√ñƒürenci</div>
                <div style="font-weight:800;" id="u-name">...</div>
            </div>
        </div>
        <div class="coin-badge">
            <i class="fa-solid fa-coins"></i> <span class="global-bal">0</span>
        </div>
    </div>

    <div id="v-home" class="view active">
        <div class="card" style="background: linear-gradient(135deg, #6366F1, #8B5CF6); color: white; border: none;">
            <h2 style="margin-bottom: 10px;">Ho≈ü Geldin!</h2>
            <p style="font-size: 13px; opacity: 0.9; line-height: 1.5;">G√ºnl√ºk denemeler ve bran≈ü fasik√ºlleri eklendi. Jetonun biterse reklam izleyerek hemen kazanabilirsin.</p>
        </div>
        <h4 style="margin-bottom:15px; display: flex; justify-content: space-between;">Pop√ºler Kaynaklar <span>üî•</span></h4>
        <div id="home-featured" class="grid-2"></div>
    </div>

    <div id="v-pdfs" class="view">
        <div id="cat-selection">
            <h2 style="margin-bottom:20px;">Bran≈ü Se√ßimi</h2>
            <div class="grid-2" id="main-cat-grid"></div>
        </div>
        <div id="pdf-listing" style="display:none;">
            <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;">
                <button class="btn" style="width:45px; height:45px; padding:0; border-radius:14px; background:white; color:var(--text-main); border:1px solid var(--border);" onclick="backToCats()">
                    <i class="fa-solid fa-chevron-left"></i>
                </button>
                <h3 id="selected-cat-title">Dosyalar</h3>
            </div>
            <div id="pdf-list" class="grid-2"></div>
        </div>
    </div>

    <div id="v-earn" class="view">
        <h2 style="margin-bottom:20px;">√úcretsiz Jeton</h2>
        <div class="card" style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 14px; color: var(--text-sub); margin-bottom: 10px;">Mevcut Jetonun</div>
            <div style="font-size: 56px; font-weight: 800; color: var(--coin);" class="global-bal">0</div>
        </div>
        <button class="btn btn-outline" id="btn-watch-ad" style="height:140px; flex-direction:column; gap:15px;" onclick="watchAdAndEarn()">
            <i class="fa-solid fa-clapperboard" style="font-size:32px;"></i>
            <span id="ad-text" style="font-size:16px;">Reklam ƒ∞zle (+1 Jeton)</span>
        </button>
    </div>

    <div id="v-admin" class="view">
        <h2 style="margin-bottom:20px;"><i class="fa-solid fa-shield-halved"></i> Y√∂netim Paneli</h2>
        <div class="card">
            <input class="inp" id="adm-name" placeholder="Dosya Adƒ± (√ñrn: TYT Kimya)">
            <input class="inp" id="adm-link" placeholder="ƒ∞ndirme Linki">
            <select class="sel" id="adm-cat"></select>
            <input class="inp" type="number" id="adm-cost" value="5" placeholder="Fiyat (Jeton)">
            <button class="btn" onclick="adminAddPdf()" id="btn-add-pdf">
                <i class="fa-solid fa-plus"></i> PDF Ekle
            </button>
        </div>
        <h4 style="margin-bottom:10px;">Sistemdeki Dosyalar</h4>
        <div id="admin-pdf-list"></div>
    </div>

    <div id="m-unlock" class="modal-overlay">
        <div class="modal-box">
            <div style="width:60px; height:60px; background:#FFF7ED; color:var(--coin); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px; font-size:24px;">
                <i class="fa-solid fa-lock-open"></i>
            </div>
            <h3>Dosyayƒ± A√ß</h3>
            <p id="unlock-msg" style="margin:15px 0; color:var(--text-sub); font-size: 14px; line-height: 1.4;"></p>
            <button class="btn" id="btn-unlock-confirm">Jetonu Kullan ve A√ß</button>
            <button class="btn" style="margin-top:10px; background:transparent; color:var(--text-sub);" onclick="closeM()">Vazge√ß</button>
        </div>
    </div>

    <div class="nav-container">
        <div class="nav">
            <div class="nav-item active" onclick="go('home',0)"><i class="fa-solid fa-house"></i></div>
            <div class="nav-item" onclick="go('pdfs',1)"><i class="fa-solid fa-book-bookmark"></i></div>
            <div class="nav-item" onclick="go('earn',2)"><i class="fa-solid fa-bolt"></i></div>
            <div id="admin-nav-btn" class="nav-item" onclick="go('admin',3)" style="display:none;"><i class="fa-solid fa-gears"></i></div>
        </div>
    </div>

    <script>
        // 1. AYARLAR VE TANIMLAR
        const firebaseConfig = {
            apiKey: "AIzaSyC18uinYQT9vOC-nhxv3x1WIhO_we3CRMY",
            authDomain: "pdfkaynak-51615.firebaseapp.com",
            projectId: "pdfkaynak-51615",
            storageBucket: "pdfkaynak-51615.firebasestorage.app",
            messagingSenderId: "228512804576",
            appId: "1:228512804576:web:a0bba02ca83b4fa7adea85"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        const ADMIN_ID = "8392479231"; 
        let user = tg.initDataUnsafe.user || { id: "00000", first_name: "Ziyaret√ßi" };
        let balance = 0, pdfs = [], currentCat = '';
        const CATS = ["Matematik", "Geometri", "Fizik", "Kimya", "Biyoloji", "T√ºrk√ße", "Edebiyat", "Tarih", "Coƒürafya", "Felsefe", "Din K√ºlt√ºr√º", "ƒ∞ngilizce", "Denemeler"];

        // 2. BA≈ûLANGI√á
        window.onload = () => {
            document.getElementById('u-name').innerText = user.first_name;

            // Admin Yetki Kontrol√º
            if (String(user.id) === ADMIN_ID) {
                document.getElementById('admin-nav-btn').style.display = 'flex';
            } else {
                const adm = document.getElementById('v-admin');
                if(adm) adm.remove();
            }

            // Firebase Veri Takibi
            db.collection("users").doc(String(user.id)).onSnapshot(doc => {
                if(doc.exists) {
                    balance = doc.data().balance || 0;
                    document.querySelectorAll('.global-bal').forEach(el => el.innerText = balance);
                } else {
                    db.collection("users").doc(String(user.id)).set({name: user.first_name, balance: 0, createdAt: Date.now()});
                }
            });

            db.collection("pdfs").onSnapshot(snap => {
                pdfs = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                renderHome();
                if (String(user.id) === ADMIN_ID) renderAdminList();
            });

            // Bran≈ü Listesini Olu≈ütur
            const grid = document.getElementById('main-cat-grid');
            const sel = document.getElementById('adm-cat');
            CATS.forEach(c => {
                grid.innerHTML += `<div class="cat-card" onclick="openCat('${c}')">${c}</div>`;
                if (sel) sel.innerHTML += `<option value="${c}">${c}</option>`;
            });
        };

        // 3. ADMIN PANELƒ∞ FONKSƒ∞YONLARI
        async function adminAddPdf() {
            if(String(user.id) !== ADMIN_ID) return;
            const name = document.getElementById('adm-name').value;
            const link = document.getElementById('adm-link').value;
            const cat = document.getElementById('adm-cat').value;
            const cost = parseInt(document.getElementById('adm-cost').value);

            if(!name || !link) { showToast("L√ºtfen t√ºm alanlarƒ± doldur!", "error"); return; }
            
            const btn = document.getElementById('btn-add-pdf');
            btn.disabled = true;
            
            try {
                await db.collection("pdfs").add({ name, link, cat, cost, createdAt: Date.now() });
                showToast("PDF Ba≈üarƒ±yla Eklendi ‚úÖ");
                document.getElementById('adm-name').value = '';
                document.getElementById('adm-link').value = '';
            } catch(e) { 
                showToast("Hata olu≈ütu!", "error"); 
            } finally {
                btn.disabled = false;
            }
        }

        function renderAdminList() {
            const list = document.getElementById('admin-pdf-list');
            list.innerHTML = pdfs.map(p => `
                <div style="background:white; padding:12px; border-radius:14px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; border:1px solid var(--border);">
                    <div>
                        <div style="font-size:13px; font-weight:700;">${p.name}</div>
                        <div style="font-size:10px; color:var(--text-sub);">${p.cat} - ${p.cost} Jeton</div>
                    </div>
                    <button onclick="adminDeletePdf('${p.id}')" style="color:var(--danger); border:none; background:#FEF2F2; width:35px; height:35px; border-radius:10px; cursor:pointer;">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
            `).join('');
        }

        async function adminDeletePdf(id) {
            if(confirm("Bu dosyayƒ± kalƒ±cƒ± olarak silmek istiyor musun?")) {
                await db.collection("pdfs").doc(id).delete();
                showToast("Dosya Silindi.");
            }
        }

        // 4. KULLANICI FONKSƒ∞YONLARI
        function renderHome() {
            const container = document.getElementById('home-featured');
            container.innerHTML = pdfs.slice(-4).reverse().map(p => `
                <div class="pdf-card" onclick="tryUnlock('${p.id}')">
                    <div style="font-size:13px; font-weight:700; margin-bottom:5px; height:32px; overflow:hidden;">${p.name}</div>
                    <div style="color:var(--primary); font-size:10px; font-weight:800; background:#EEF2FF; padding:4px; border-radius:6px; display:inline-block;">${p.cat}</div>
                </div>
            `).join('');
        }

        function openCat(c) {
            currentCat = c;
            document.getElementById('cat-selection').style.display='none';
            document.getElementById('pdf-listing').style.display='block';
            document.getElementById('selected-cat-title').innerText = c;
            renderPdfs();
        }

        function backToCats() {
            document.getElementById('cat-selection').style.display='block';
            document.getElementById('pdf-listing').style.display='none';
        }

        function renderPdfs() {
            const list = document.getElementById('pdf-list');
            const filtered = pdfs.filter(p => p.cat === currentCat);
            if(filtered.length === 0) {
                list.innerHTML = `<div style="grid-column: span 2; padding:40px; text-align:center; color:var(--text-sub); font-size:13px;">Bu bran≈üta hen√ºz dosya yok.</div>`;
                return;
            }
            list.innerHTML = filtered.map(p => `
                <div class="pdf-card" onclick="tryUnlock('${p.id}')">
                    <i class="fa-solid fa-file-pdf" style="font-size:28px; color:#EF4444; margin-bottom:10px;"></i>
                    <div style="font-size:12px; font-weight:700; margin-bottom:10px; height:30px; overflow:hidden;">${p.name}</div>
                    <div style="color:var(--coin); font-size:12px; font-weight:800; border-top:1px solid #f8f8f8; pt-5">${p.cost} Jeton</div>
                </div>
            `).join('');
        }

        async function watchAdAndEarn() {
            const btn = document.getElementById('btn-watch-ad');
            if(typeof show_10384475 !== 'function') {
                showToast("Reklam y√ºklenemiyor, l√ºtfen bekleyin.", "error");
                return;
            }
            btn.disabled = true;
            try {
                await show_10384475();
                await db.collection("users").doc(String(user.id)).update({
                    balance: firebase.firestore.FieldValue.increment(1)
                });
                showToast("Harika! +1 Jeton Hesabƒ±na Eklendi ü™ô");
            } catch(e) { 
                showToast("Reklam tamamlanmadƒ±.", "error"); 
            } finally { 
                btn.disabled = false; 
            }
        }

        function tryUnlock(id) {
            const p = pdfs.find(x => x.id === id);
            document.getElementById('unlock-msg').innerText = `"${p.name}" dosyasƒ±nƒ± a√ßmak i√ßin bakiyenden ${p.cost} jeton d√º≈ü√ºlecektir. Onaylƒ±yor musun?`;
            document.getElementById('btn-unlock-confirm').onclick = async () => {
                if(balance >= p.cost) {
                    await db.collection("users").doc(String(user.id)).update({
                        balance: firebase.firestore.FieldValue.increment(-p.cost)
                    });
                    copyToClipboard(p.link);
                    showToast("Dosya Eri≈üimi Saƒülandƒ±! Link kopyalandƒ± üìã");
                    closeM();
                } else {
                    showToast("Yetersiz Jeton! Reklam izleyebilirsin.", "error");
                    go('earn', 2);
                    closeM();
                }
            };
            openModal('m-unlock');
        }

        // 5. YARDIMCI ARA√áLAR
        function go(v, i) {
            document.querySelectorAll('.view').forEach(x => x.classList.remove('active'));
            document.getElementById('v-'+v).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.nav-item')[i].classList.add('active');
        }

        function copyToClipboard(text) {
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeM() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display='none'); }
        
        function showToast(m, type="success") {
            const t = document.createElement('div');
            t.className = 'toast';
            if(type === "error") t.style.background = "#EF4444";
            t.innerText = m;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 2500);
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SpyderCoin - Web Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        :root { --bg: #1a1a1a; --card-bg: #2c2c2c; --purple: #a855f7; --text: #ffffff; --inactive-text: #888; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* Ba≈ülƒ±k */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; color: var(--text); }
        .header-title { font-weight: 600; font-size: 18px; }

        /* Ana ƒ∞√ßerik */
        .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px 20px; overflow-y: auto; flex-grow: 1; padding-bottom: 100px; /* Nav bar i√ßin bo≈üluk */ }
        .card { background: var(--card-bg); border-radius: 12px; padding: 18px; display: flex; flex-direction: column; position: relative; }

        /* Sol √úst Kart - Ana Tƒ±klama Alanƒ± */
        #p-play { grid-column: 1 / span 1; grid-row: 1 / span 2; } /* G√∂rsele g√∂re d√ºzenlendi */
        .balance-display { font-size: 48px; font-weight: 800; text-align: center; margin-bottom: 10px; }
        .tap-label { text-align: center; font-size: 14px; color: var(--inactive-text); margin-bottom: 20px; }
        
        .tap-zone { position: relative; width: 140px; height: 140px; border-radius: 50%; background: var(--purple); margin: 0 auto; display: flex; justify-content: center; align-items: center; touch-action: none; cursor: pointer; }
        .tap-zone::before { content: 'üï∏Ô∏è'; font-size: 80px; position: absolute; } /* √ñr√ºmcek emojisi */
        .web-effect { position: absolute; width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 70%); animation: webPulse 0.4s ease-out; opacity: 0; }
        @keyframes webPulse { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(1.2); opacity: 0; } }

        .energy-section { margin-top: auto; padding-top: 20px; border-top: 1px solid #333; }
        .energy-label { font-size: 12px; color: var(--inactive-text); display: flex; justify-content: space-between; margin-bottom: 5px; }
        .energy-bar-bg { background: #333; height: 8px; border-radius: 4px; overflow: hidden; }
        #energy-fill { background: linear-gradient(90deg, #6366f1, var(--purple)); height: 100%; width: 100%; transition: width 0.3s ease-out; }

        /* G√∂rev Kartƒ± */
        #p-tasks-card { grid-column: 2 / span 1; }
        .task-title { font-size: 16px; font-weight: 600; margin-bottom: 10px; }
        .task-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .task-btn { background: var(--purple); color: var(--text); padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; border: none; cursor: pointer; }
        .task-btn.done { background: #555; color: #bbb; cursor: default; }

        /* Sƒ±ralama Kartƒ± (G√∂rselde "Siranisleri" olarak ge√ßiyor) */
        #p-rank-card { grid-column: 2 / span 1; }
        .rank-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .rank-item-me { border: 1px solid var(--purple); padding: 8px; border-radius: 8px; background: rgba(168, 85, 247, 0.1); }
        .rank-title { font-size: 16px; font-weight: 600; margin-bottom: 10px; }

        /* Dost Kartƒ± (G√∂rselde "p-Leagus" olarak ge√ßiyor) */
        #p-friends-card { grid-column: 1 / span 1; }
        .invite-btn { background: var(--purple); color: var(--text); padding: 10px 15px; border-radius: 8px; font-size: 14px; font-weight: 600; border: none; width: 100%; margin-top: 15px; cursor: pointer; }

        /* C√ºzdan Kartƒ± */
        #p-wallet-card { grid-column: 2 / span 1; }
        .wallet-balance { font-size: 32px; font-weight: 800; margin-top: 5px; }
        .wallet-spyder { font-size: 14px; color: var(--inactive-text); margin-top: 5px; }

        /* Alt Navigasyon */
        .nav-bar { display: flex; justify-content: space-around; background: var(--card-bg); border-top: 1px solid #333; padding: 10px 0; position: fixed; bottom: 0; left: 0; right: 0; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 12px; color: var(--inactive-text); cursor: pointer; padding: 5px 0; }
        .nav-item.active { color: var(--purple); }
        .nav-item span { margin-top: 4px; }
    </style>
</head>
<body>

    <div class="header">
        <span class="header-title">SpyderCoin - Web Edition</span>
        <button id="admin-toggle" style="background: none; border: none; color: var(--purple); font-size: 14px; cursor: pointer; display: none;">‚öôÔ∏è</button>
    </div>

    <div class="main-content">
        <div id="p-play" class="card">
            <div class="balance-display" id="ui-bal">0</div>
            <div class="tap-label">Tap Zone</div>
            
            <div class="tap-zone" id="tap-target">
                <div class="web-effect"></div>
            </div>

            <div class="energy-section">
                <div class="energy-label">
                    <span>‚ö° Enerji:</span>
                    <span id="ui-nrg-val">100</span>/<span id="ui-nrg-max">100</span>
                </div>
                <div class="energy-bar-bg">
                    <div id="energy-fill"></div>
                </div>
            </div>
        </div>

        <div id="p-tasks-card" class="card">
            <div class="task-title">Telegram Kanal</div>
            <small style="color:var(--purple);">+555 SPYDER</small>
            <button id="tg-task-btn" class="task-btn" style="margin-top:10px;" onclick="doTelegramTask()">Katƒ±l</button>
        </div>

        <div id="p-rank-card" class="card">
            <div class="rank-title">Sƒ±ralama</div>
            <div class="rank-list" id="rank-container">
                <p style="text-align:center; color:#666;">Y√ºkleniyor...</p>
            </div>
        </div>

        <div id="p-friends-card" class="card">
            <p style="font-size:16px; font-weight:600;">Arkada≈ü Davet Et</p>
            <small style="color:var(--inactive-text);">Arkada≈ülarƒ±nƒ± davet et, bonus kazan!</small>
            <button class="invite-btn">Davet Et</button>
        </div>

        <div id="p-wallet-card" class="card">
            <p style="font-size:14px; color:var(--inactive-text);">Bakiyen</p>
            <div class="wallet-balance" id="w-usd">$0.00</div>
            <div class="wallet-spyder"><span id="w-coin">0</span> SPYDER</div>
        </div>
    </div>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="nav('p-play', this)">
            <span>üéÆ</span><span>Oyna</span>
        </div>
        <div class="nav-item" onclick="nav('p-tasks-card', this)">
            <span>üìã</span><span>G√∂rev</span>
        </div>
        <div class="nav-item" onclick="nav('p-friends-card', this)">
            <span>üë•</span><span>Dost</span>
        </div>
        <div class="nav-item" onclick="nav('p-rank-card', this)">
            <span>üèÜ</span><span>Lig</span>
        </div>
        <div class="nav-item" onclick="nav('p-wallet-card', this)">
            <span>üí∞</span><span>C√ºzdan</span>
        </div>
    </nav>

    <div id="admin-panel" style="position: fixed; inset: 0; background: #1a1a1a; z-index: 9999; display: none; flex-direction: column; align-items: center; padding: 30px;">
        <h1 style="color:var(--purple);">KONTROL MERKEZƒ∞</h1>
        <div class="card" style="width:100%; margin-top:20px;">
            <p>Admin: <b id="adm-name"></b></p>
            <p>Kullanƒ±cƒ± Adƒ±: <b id="adm-user"></b></p>
            <p>Bakiye: <b id="adm-bal">0</b></p>
        </div>
        <button style="background: #ff3b30; color: white; padding: 15px; border-radius: 12px; border:none; width:100%; margin-top: auto;" onclick="toggleAdmin(false)">Kapat</button>
    </div>

    <script>
        // üõ†Ô∏è FIREBASE CONFIG - BURAYA KENDƒ∞ Bƒ∞LGƒ∞LERƒ∞Nƒ∞ Gƒ∞R KRAL
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const tg = window.Telegram.WebApp;
        const MY_ADMIN_ID = "8392479231"; // Senin Telegram ID'n
        const user = tg.initDataUnsafe?.user || { id: "test_user_123", first_name: "Misafir", username: "testuser" };

        let balance = 0;
        let energy = 100;
        const maxEnergy = 100;
        const energyRechargeRate = 1; // saniyede 1 enerji
        let lastTapTime = 0;
        let isTelegramTaskDone = localStorage.getItem(`tg_task_${user.id}`) === 'true';

        async function init() {
            tg.ready();
            tg.expand();

            const userRef = db.collection('users').doc(String(user.id));
            const doc = await userRef.get();

            if (!doc.exists) {
                await userRef.set({ name: user.first_name, username: user.username || "", balance: 0, lastEnergyRecharge: Date.now() });
            } else {
                const data = doc.data();
                balance = data.balance;
                
                // Enerji geri y√ºkleme hesaplamasƒ±
                const now = Date.now();
                const lastRecharge = data.lastEnergyRecharge || now;
                const timePassed = Math.floor((now - lastRecharge) / 1000);
                energy = Math.min(maxEnergy, (data.energy || maxEnergy) + timePassed * energyRechargeRate);
                await userRef.update({ energy: energy, lastEnergyRecharge: now });
            }

            updateUI();
            
            if (String(user.id) === MY_ADMIN_ID) {
                document.getElementById('admin-toggle').style.display = 'block';
                document.getElementById('adm-name').innerText = user.first_name;
                document.getElementById('adm-user').innerText = "@" + (user.username || "yok");
            }
            if (isTelegramTaskDone) {
                document.getElementById('tg-task-btn').innerText = "Tamamlandƒ±";
                document.getElementById('tg-task-btn').classList.add('done');
                document.getElementById('tg-task-btn').onclick = null;
            }
            setInterval(rechargeEnergy, 1000); // Her saniye enerji doldur
        }

        async function updateUI() {
            document.getElementById('ui-bal').innerText = balance.toLocaleString();
            document.getElementById('ui-nrg-val').innerText = energy;
            document.getElementById('energy-fill').style.width = (energy / maxEnergy * 100) + "%";
            
            document.getElementById('adm-bal').innerText = balance.toLocaleString(); // Admin paneli
            
            document.getElementById('w-coin').innerText = balance.toLocaleString();
            // Basit bir USD deƒüeri ill√ºzyonu
            document.getElementById('w-usd').innerText = `$${(balance * 0.000001).toFixed(6)}`; 
        }

        async function rechargeEnergy() {
            if (energy < maxEnergy) {
                energy = Math.min(maxEnergy, energy + energyRechargeRate);
                updateUI();
                await db.collection('users').doc(String(user.id)).update({ energy: energy, lastEnergyRecharge: Date.now() });
            }
        }

        // üï∏Ô∏è √ñR√úMCEK AƒûI ANƒ∞MASYONU
        function playWebAnimation(e) {
            const tapZone = document.getElementById('tap-target');
            const webEffect = tapZone.querySelector('.web-effect');
            
            // Mevcut animasyonu sƒ±fƒ±rla ve yeniden ba≈ülat
            webEffect.style.animation = 'none';
            void webEffect.offsetWidth; // DOM'u yeniden √ßizmeye zorla
            webEffect.style.animation = null;
            webEffect.style.animation = 'webPulse 0.4s ease-out forwards';
        }

        // Tƒ±klama Fonksiyonu
        async function handleTap(e) {
            if (energy <= 0) {
                tg.showAlert('Enerjin bitti! Bekle ve yeniden doldur.');
                return;
            }

            // Tƒ±klama hƒ±zƒ± sƒ±nƒ±rlamasƒ±
            const now = Date.now();
            if (now - lastTapTime < 50) return; // 50ms (saniyede 20 tƒ±klama)
            lastTapTime = now;

            balance += 1; // Tƒ±k ba≈üƒ±na 1 puan
            energy--;
            updateUI();
            playWebAnimation(); // Aƒü animasyonunu oynat

            // Firebase'e sadece belli aralƒ±klarla veya uygulama kapanƒ±rken yaz (optimizasyon i√ßin)
            // ≈ûimdilik her tƒ±klamada yazƒ±yoruz, Firebase kurallarƒ± spamƒ± engelleyecek
            await db.collection('users').doc(String(user.id)).update({ balance: balance, energy: energy, lastEnergyRecharge: Date.now() });
        }

        // G√∂rev: Telegram Kanalƒ±
        async function doTelegramTask() {
            if (isTelegramTaskDone) {
                tg.showAlert('Bu g√∂revi zaten tamamladƒ±n!');
                return;
            }

            const btn = document.getElementById('tg-task-btn');
            btn.innerText = "Kontrol Ediliyor...";
            btn.classList.remove('active');
            btn.classList.add('done'); // G√∂rsel olarak disabled gibi yap
            btn.onclick = null; // Tƒ±klamayƒ± engelle

            tg.openTelegramLink("https://t.me/SpyderCommunity");

            // 3 saniye sonra √∂d√ºl ver (ill√ºzyon)
            setTimeout(async () => {
                balance += 555;
                isTelegramTaskDone = true;
                localStorage.setItem(`tg_task_${user.id}`, 'true');

                await db.collection('users').doc(String(user.id)).update({ balance: balance });
                updateUI();
                tg.showNotification({
                    type: 'success',
                    text: 'Tebrikler! +555 SPYDER kazandƒ±n.'
                });
                btn.innerText = "Tamamlandƒ±";
            }, 3000);
        }

        // Sƒ±ralama Listesini Getir
        async function fetchRankings() {
            const container = document.getElementById('rank-container');
            container.innerHTML = "<p style='text-align:center; color:#666;'>Y√ºkleniyor...</p>";

            // En y√ºksek 10 kullanƒ±cƒ±yƒ± √ßek
            const snapshot = await db.collection('users').orderBy('balance', 'desc').limit(10).get();
            
            container.innerHTML = "";
            let rank = 1;
            snapshot.forEach(doc => {
                const data = doc.data();
                const isMe = doc.id === String(user.id);
                container.innerHTML += `
                    <div class="rank-item ${isMe ? 'rank-item-me' : ''}">
                        <span>${rank}. ${data.name}</span>
                        <b>${data.balance.toLocaleString()}</b>
                    </div>
                `;
                rank++;
            });
        }

        // Admin Panelini A√ß/Kapat
        function toggleAdmin(show) {
            document.getElementById('admin-panel').style.display = show ? 'flex' : 'none';
        }

        // Navigasyon Fonksiyonu (G√∂rseldeki gibi sekmeler arasƒ± ge√ßi≈ü)
        function nav(targetId, navItem) {
            // T√ºm kartlarƒ± gizle
            document.querySelectorAll('.main-content > .card').forEach(card => card.style.display = 'none');
            // Hedef kartƒ± g√∂ster
            const targetCard = document.getElementById(targetId);
            if (targetCard) {
                targetCard.style.display = 'flex';
            }

            // Navigasyon itemlerini g√ºncelle
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            navItem.classList.add('active');

            // Eƒüer "Lig" sekmesine tƒ±klanƒ±rsa sƒ±ralamayƒ± yenile
            if (targetId === 'p-rank-card') {
                fetchRankings();
            }
        }

        // Event Listener'lar
        document.getElementById('tap-target').addEventListener('touchstart', (e) => { e.preventDefault(); handleTap(e); });
        document.getElementById('tap-target').addEventListener('mousedown', handleTap);
        document.getElementById('admin-toggle').addEventListener('click', () => toggleAdmin(true));

        // Ba≈ülangƒ±√ßta sadece p-play ve ilk nav-item aktif olsun
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.main-content > .card').forEach(card => card.style.display = 'none');
            document.getElementById('p-play').style.display = 'flex';
            document.querySelector('.nav-item.active').classList.remove('active');
            document.querySelector('.nav-bar .nav-item:nth-child(1)').classList.add('active');
        });

        init();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SpyderCoin - Task Edition</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://adexora.com/cdn/ads.js?id=1545"></script>

    <style>
        :root {
            --primary: #ffeb3b;
            --secondary: #9c27b0;
            --bg-dark: #0a0014;
            --card-bg: #1a002e;
            --success: #00e676;
            --blue: #0088cc;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body {
            background: radial-gradient(circle at center, #1a002e 0%, #000 100%);
            color: white; font-family: 'Segoe UI', sans-serif; margin: 0; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
        }

        header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255, 235, 59, 0.1); }
        .balance-container { font-size: 42px; font-weight: 900; color: var(--primary); text-shadow: 0 0 15px rgba(255, 235, 59, 0.5); }
        
        main { flex-grow: 1; overflow-y: auto; padding-bottom: 90px; }
        .tab-content { display: none; padding: 20px; animation: fadeIn 0.3s ease; width: 100%; }
        .tab-content.active { display: flex; flex-direction: column; align-items: center; }

        /* Oyun Alanƒ± */
        .game-card { position: relative; width: 260px; height: 260px; background: rgba(156, 39, 176, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 25px 0; border: 2px solid rgba(156, 39, 176, 0.3); }
        #spider-main { font-size: 130px; cursor: pointer; transition: transform 0.05s; z-index: 10; }
        #spider-main:active { transform: scale(0.85); }
        .floating-text { position: absolute; color: var(--primary); font-weight: bold; pointer-events: none; animation: floatUp 0.8s forwards; }

        /* Enerji Barƒ± */
        .energy-section { width: 90%; max-width: 350px; margin-bottom: 15px; }
        .energy-bar-bg { width: 100%; height: 14px; background: #222; border-radius: 10px; border: 1px solid var(--primary); overflow: hidden; }
        #energy-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #ffd600, #ffeb3b); transition: width 0.2s; }

        /* G√∂rev Kartƒ± */
        .task-card {
            background: var(--card-bg); border-radius: 20px; padding: 25px; width: 100%; max-width: 400px;
            display: flex; flex-direction: column; align-items: center; text-align: center;
            border: 2px solid var(--blue); box-shadow: 0 0 20px rgba(0, 136, 204, 0.2);
        }
        .task-info h4 { margin: 0; font-size: 18px; color: white; }
        .task-info p { margin: 10px 0; font-size: 24px; color: var(--success); font-weight: bold; }
        
        /* Butonlar */
        .btn-action { background: var(--primary); color: black; border: none; padding: 15px; border-radius: 12px; font-weight: 800; width: 100%; cursor: pointer; transition: 0.2s; }
        .task-btn { background: var(--blue); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; font-size: 16px; }
        .task-btn.done { background: #333; color: #777; cursor: default; }

        /* Admin Alanƒ± */
        .admin-item { background: #111; padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid var(--secondary); font-size: 12px; text-align: left; width: 100%; }

        /* Navigasyon */
        .nav-bar { position: fixed; bottom: 0; width: 100%; height: 75px; background: #050505; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid rgba(255,255,255,0.1); }
        .nav-link { display: flex; flex-direction: column; align-items: center; color: #555; text-decoration: none; font-size: 11px; cursor: pointer; }
        .nav-link.active { color: var(--primary); }

        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-100px); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <header>
        <div class="balance-container">$<span id="main-balance">0.00000</span></div>
        <div id="display-name" style="font-size: 12px; color: #888;">Y√ºkleniyor...</div>
    </header>

    <main>
        <div id="tab-game" class="tab-content active">
            <div class="energy-section">
                <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px;">
                    <span>‚ö° ENERJƒ∞</span><span id="energy-val">1000/1000</span>
                </div>
                <div class="energy-bar-bg"><div id="energy-fill"></div></div>
            </div>
            
            <div class="game-card"><div id="spider-main" onclick="processTap(event)">üï∑Ô∏è</div></div>
            
            <div style="width:90%; max-width:300px; text-align:center;">
                <div style="margin-bottom:10px; font-size:14px; color:var(--primary);">Puan: <span id="ads-count-display">0</span></div>
                <button class="btn-action" onclick="handleAdRefill()">‚ö° ENERJƒ∞ FULLLE (REKLAM)</button>
            </div>
        </div>

        <div id="tab-tasks" class="tab-content">
            <h3 style="color: var(--primary); margin-bottom: 20px;">√ñzel G√∂revler</h3>
            <div class="task-card">
                <div class="task-info">
                    <div style="font-size: 40px; margin-bottom: 10px;">üì¢</div>
                    <h4>Telegram Kanalƒ±na Katƒ±l</h4>
                    <p>+1000 Puan</p>
                </div>
                <button class="task-btn" id="task-tg" onclick="completeTask('tg', 'https://t.me/SpyderCommunity', 1000)">KANALA Gƒ∞T</button>
            </div>
        </div>

        <div id="tab-admin" class="tab-content">
            <div style="width:100%; max-width:400px; background:#000; border:1px solid var(--secondary); padding:15px; border-radius:15px;">
                <h3 style="margin:0; color:var(--secondary);">üõ°Ô∏è Admin Paneli</h3>
                <div id="adm-player-list" style="margin-top:15px; max-height:450px; overflow-y:auto;"></div>
            </div>
        </div>
    </main>

    <nav class="nav-bar">
        <div class="nav-link active" onclick="showTab('game', this)"><span>üéÆ</span><span>OYUN</span></div>
        <div class="nav-link" onclick="showTab('tasks', this)"><span>üìã</span><span>G√ñREVLER</span></div>
        <div id="admin-nav-link" class="nav-link" style="display:none;" onclick="showTab('admin', this)"><span>üõ°Ô∏è</span><span>ADMƒ∞N</span></div>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        const firebaseConfig = {
            apiKey: "AIzaSyDfy6QdIZ0BthEHTmxkw-NAja3B9bFFd8U",
            authDomain: "spydercoin-94f7b.firebaseapp.com",
            projectId: "spydercoin-94f7b",
            storageBucket: "spydercoin-94f7b.firebasestorage.app",
            messagingSenderId: "218267568158",
            appId: "1:218267568158:web:832728845ba0f42202060f"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const adminId = "8392479231";
        const u = tg.initDataUnsafe.user || { id: "dev_test", first_name: "Geli≈ütirici", username: "dev" };
        const UID = u.id.toString();

        let localData = { money: 0, energy: 1000, adsWatched: 0, completedTasks: [] };
        let tapCount = 0;

        document.getElementById('display-name').innerText = `${u.first_name} (@${u.username || 'yok'})`;
        if(UID === adminId) document.getElementById('admin-nav-link').style.display = 'flex';

        db.collection("players").doc(UID).onSnapshot(doc => {
            if(doc.exists) { localData = doc.data(); renderUI(); }
            else { save(); }
        });

        if(UID === adminId) {
            db.collection("players").onSnapshot(snap => {
                const list = document.getElementById('adm-player-list');
                list.innerHTML = "";
                snap.forEach(d => {
                    const p = d.data();
                    list.innerHTML += `<div class="admin-item"><b>${p.first_name}</b> (@${p.username})<br>Para: $${(p.money || 0).toFixed(4)} | Puan: ${p.adsWatched || 0}</div>`;
                });
            });
        }

        function processTap(e) {
            if(localData.energy <= 0) return;
            tg.HapticFeedback.impactOccurred('light');
            createFloatingText(e);

            localData.money += 0.0001;
            localData.energy -= 1;
            tapCount++;

            if(tapCount >= 10) {
                tapCount = 0;
                localData.adsWatched += 1;
                if(window.showAdexora) window.showAdexora().catch(e=>{});
            }
            renderUI(); save();
        }

        function createFloatingText(e) {
            const f = document.createElement('div');
            f.className = 'floating-text'; f.innerText = '+0.0001';
            f.style.left = e.clientX + 'px'; f.style.top = e.clientY + 'px';
            document.body.appendChild(f); setTimeout(() => f.remove(), 800);
        }

        function completeTask(taskId, link, reward) {
            if(localData.completedTasks && localData.completedTasks.includes(taskId)) return;
            tg.openLink(link);
            setTimeout(() => {
                if(!localData.completedTasks) localData.completedTasks = [];
                localData.completedTasks.push(taskId);
                localData.adsWatched += reward; // G√∂rev √∂d√ºl√º puan olarak eklenir
                save();
                tg.showAlert(`Tebrikler! ${reward} Puan hesabƒ±na eklendi.`);
            }, 6000);
        }

        function handleAdRefill() {
            window.open("https://adexora.my.id/dl/QFm5mnRYbJV", "_blank");
            localData.energy = 1000; localData.adsWatched += 1;
            save(); tg.showAlert("Enerji dolduruldu! +1 Puan kazandƒ±n.");
        }

        function renderUI() {
            document.getElementById('main-balance').innerText = localData.money.toFixed(5);
            document.getElementById('energy-val').innerText = localData.energy + "/1000";
            document.getElementById('energy-fill').style.width = (localData.energy / 10) + "%";
            document.getElementById('ads-count-display').innerText = localData.adsWatched;
            
            if(localData.completedTasks && localData.completedTasks.includes('tg')) {
                const btn = document.getElementById('task-tg');
                if(btn) { btn.innerText = "TAMAMLANDI ‚úÖ"; btn.classList.add('done'); btn.onclick = null; }
            }
        }

        function save() { 
            db.collection("players").doc(UID).set({
                ...localData, first_name: u.first_name, username: u.username || "yok"
            }, {merge: true}); 
        }

        function showTab(tabId, el) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            el.classList.add('active');
        }
    </script>
</body>
</html>

/* ========================================================
   MODÃœL: GELÄ°ÅMÄ°Å CÃœZDAN & Ã–DEME SÄ°STEMÄ° (800-1000 SATIR PLANI)
   ======================================================== */

// 1. CÃœZDAN GÃ–RÃœNÃœMÃœ GÃœNCELLEMESÄ° (HTML kÄ±smÄ± iÃ§in fikir verir)
// Bu bÃ¶lÃ¼m 'v-wallet' sekmesinin iÃ§ine gelecek ÅŸekilde tasarlanmÄ±ÅŸtÄ±r.

const WalletSystem = {
    // Dinamik Hesaplama: Her 0.01$ iÃ§in 17 reklam kuralÄ±
    calculateRequiredAds: (usdtAmount) => {
        const factor = 17 / 0.01; 
        return Math.ceil(usdtAmount * factor);
    },

    // Ã–deme Talebi BaÅŸlatma
    requestWithdraw: async () => {
        const amount = parseFloat(prompt("Ã‡ekmek istediÄŸiniz USDT miktarÄ±nÄ± girin (Ã–rn: 0.10):"));
        
        if (!amount || amount <= 0) {
            return tg.showAlert("GeÃ§ersiz miktar girdiniz.");
        }

        if (user.usdt < amount) {
            return tg.showAlert("Yetersiz bakiye! Mevcut: $" + user.usdt.toFixed(2));
        }

        const requiredAds = WalletSystem.calculateRequiredAds(amount);
        const currentAds = user.ads || 0;

        // REKLAM KONTROLÃœ
        if (currentAds < requiredAds) {
            const missing = requiredAds - currentAds;
            return tg.showAlert(`âŒ Ã–deme AlamazsÄ±nÄ±z!\n\nBu miktar iÃ§in toplam ${requiredAds} reklam izlemiÅŸ olmanÄ±z gerekiyor.\n\nEksik reklam: ${missing}\nLÃ¼tfen GÃ–REV sekmesinden reklam izleyin.`);
        }

        // ADRES VE TALEBÄ° ALMA
        const address = prompt("LÃ¼tfen USDT (TRC-20 veya TON) adresinizi girin:");
        
        if (!address || address.length < 10) {
            return tg.showAlert("GeÃ§ersiz cÃ¼zdan adresi!");
        }

        // VERÄ°TABANINA Ã–DEME TALEBÄ° OLARAK KAYDETME
        try {
            await db.collection("withdrawals").add({
                uid: uid,
                username: uname,
                amount: amount,
                address: address,
                adCountAtTime: currentAds,
                status: "PENDING",
                timestamp: Date.now()
            });

            // KullanÄ±cÄ± bakiyesini dÃ¼ÅŸ (Opsiyonel: OnaylanÄ±nca da dÃ¼ÅŸebilirsin)
            user.usdt -= amount;
            Core.save();
            Core.ui();

            tg.showAlert("âœ… Ã–deme talebiniz alÄ±ndÄ±!\nAdmin incelemesinden sonra cÃ¼zdanÄ±nÄ±za gÃ¶nderilecektir.");
        } catch (e) {
            console.error("Ã–deme hatasÄ±:", e);
            tg.showAlert("Bir hata oluÅŸtu, lÃ¼tfen tekrar deneyin.");
        }
    }
};

/* ========================================================
   ADMIN PANELÄ° - Ã–DEME ANALÄ°ZÄ° EKLEMESÄ°
   ======================================================== */
// Admin.open fonksiyonunun iÃ§ine aÅŸaÄŸÄ±daki analiz satÄ±rlarÄ±nÄ± ekle:

const updateAdminDetails = (selectedUser) => {
    const reqForFullBalance = WalletSystem.calculateRequiredAds(selectedUser.usdt || 0);
    const adStatus = (selectedUser.ads || 0) >= reqForFullBalance ? "âœ… Ã–DEMEYE UYGUN" : "âŒ REKLAM YETERSÄ°Z";

    document.getElementById('det-tasks').innerHTML += `
        <div class="ana-info" style="border-left-color: ${adStatus.includes('âœ…') ? 'var(--success)' : 'var(--error)'}">
            <h4>ğŸ’° Ã–DEME ANALÄ°ZÄ°</h4>
            <p>Mevcut Reklam: ${selectedUser.ads || 0}</p>
            <p>TÃ¼m Bakiyeyi Ã‡ekmek Ä°Ã§in Gereken: ${reqForFullBalance}</p>
            <b style="color:${adStatus.includes('âœ…') ? 'var(--success)' : 'var(--error)'}">${adStatus}</b>
        </div>
    `;
};

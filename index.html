<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CW Flappy Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background-color: #4eb5d3; font-family: 'Inter', sans-serif; margin: 0; overflow: hidden; user-select: none; }
        .page { display: none; height: calc(100vh - 75px); position: relative; }
        .page.active { display: block; }
        
        /* Geli≈ümi≈ü Skor Ekranƒ± (Modal) */
        #death-screen { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); 
            display: none; flex-direction: column; justify-content: center; 
            align-items: center; z-index: 2000; backdrop-filter: blur(10px);
        }

        #game-canvas { display: none; position: absolute; inset: 0; z-index: 100; }
        .score-hud { position: absolute; top: 50px; width: 100%; text-align: center; font-size: 60px; color: white; font-weight: 900; z-index: 110; pointer-events: none; text-shadow: 4px 4px 0 #000; }
        
        .bird-body { width: 50px; height: 36px; background: #9c5c3c; border: 3px solid #000; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 900; }
        .ground { position: absolute; bottom: 75px; width: 100%; height: 35px; background: #8bc34a; border-top: 4px solid #558b2f; z-index: 5; }
    </style>
</head>
<body>

<div id="death-screen">
    <div class="bg-white rounded-[40px] p-10 text-center shadow-2xl scale-110">
        <h2 class="text-gray-400 font-bold uppercase text-xs mb-2">Oyun Bitti</h2>
        <h1 id="final-score" class="text-7xl font-black text-blue-600 mb-6">0</h1>
        <div class="flex gap-4 mb-8">
            <div class="bg-blue-50 p-4 rounded-2xl">
                <p class="text-[10px] text-blue-400 font-bold">G√úNL√úK</p>
                <p id="modal-daily" class="font-black text-gray-700">0</p>
            </div>
            <div class="bg-blue-50 p-4 rounded-2xl">
                <p class="text-[10px] text-blue-400 font-bold">REKOR</p>
                <p id="modal-record" class="font-black text-gray-700">0</p>
            </div>
        </div>
        <button onclick="closeDeathScreen()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black shadow-lg active:scale-95 transition">ANA MEN√ú</button>
    </div>
</div>

<div class="max-w-md mx-auto h-screen flex flex-col relative bg-[#4eb5d3] overflow-hidden">
    
    <div id="game-ui" style="display:none;">
        <div class="score-hud" id="live-score">0</div>
        <canvas id="game-canvas"></canvas>
    </div>

    <div id="flappy-page" class="page active px-4 pt-4">
        <div class="flex gap-3">
            <div class="bg-white rounded-2xl p-4 flex-1 shadow-xl">
                <span class="text-[10px] font-bold text-red-500 uppercase">HAKLAR</span>
                <div class="text-3xl font-black text-gray-800" id="heart-val">10</div>
            </div>
            <div class="bg-white rounded-2xl p-4 flex-1 shadow-xl text-[10px] font-bold space-y-1">
                <div class="flex justify-between"><span>BUG√úN</span> <span id="daily-ui" class="text-blue-500">0</span></div>
                <div class="flex justify-between"><span>REKOR</span> <span id="record-ui" class="text-blue-500">0</span></div>
            </div>
        </div>

        <div class="flex flex-col items-center justify-center mt-32">
            <div class="bird-body animate-bounce">CW</div>
            <button id="play-btn" class="mt-16 bg-white p-8 rounded-[40px] shadow-2xl active:scale-90 transition-all border-b-8 border-gray-200">
                <div class="w-0 h-0 border-t-[15px] border-t-transparent border-l-[30px] border-l-green-600 border-b-[15px] border-b-transparent ml-2"></div>
            </button>
        </div>
    </div>

    <div class="ground"></div>

    <div class="h-[75px] bg-white flex justify-around items-center z-[100] border-t">
        <div class="text-blue-500 text-center"><p class="text-2xl">üéÆ</p><p class="text-[9px] font-bold">FLAPPY</p></div>
        <div class="text-gray-300 text-center"><p class="text-2xl">üèÜ</p><p class="text-[9px] font-bold">RATING</p></div>
        <div class="text-gray-300 text-center"><p class="text-2xl">üí∞</p><p class="text-[9px] font-bold">WALLET</p></div>
    </div>
</div>

<script>
    let hearts = 10;
    let dailyBest = 0;
    let allTimeBest = 0;
    let gameActive = false;
    let score = 0;
    let pipes = [];
    let animationId;

    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth > 450 ? 450 : window.innerWidth;
    canvas.height = window.innerHeight - 75;

    const bird = { x: 60, y: 300, w: 34, h: 26, v: 0, g: 0.25, j: 5 };

    function gameLoop() {
        if (!gameActive) return; // D√∂ng√ºy√º burada kesin olarak durduruyoruz

        ctx.fillStyle = "#70c5ce";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        bird.v += bird.g;
        bird.y += bird.v;

        // Karakter √áizimi
        ctx.fillStyle = "#9c5c3c";
        ctx.fillRect(bird.x, bird.y, bird.w, bird.h);
        ctx.strokeRect(bird.x, bird.y, bird.w, bird.h);

        // Boru √úretimi
        if (pipes.length === 0 || pipes[pipes.length - 1].x < canvas.width - 200) {
            pipes.push({ x: canvas.width, y: Math.random() * (canvas.height - 300) + 100, gap: 150, passed: false });
        }

        pipes.forEach(p => {
            p.x -= 3.5;
            ctx.fillStyle = "#2ecc71";
            ctx.fillRect(p.x, 0, 60, p.y);
            ctx.fillRect(p.x, p.y + p.gap, 60, canvas.height);

            // √áarpƒ±≈üma Kontrol√º (Hata burada d√ºzeltildi: gameActive anƒ±nda false yapƒ±lƒ±yor)
            if (bird.x + bird.w > p.x && bird.x < p.x + 60 && (bird.y < p.y || bird.y + bird.h > p.y + p.gap)) {
                triggerGameOver();
            }

            if (!p.passed && p.x < bird.x) {
                p.passed = true;
                score++;
                document.getElementById('live-score').innerText = score;
            }
        });

        if (bird.y + bird.h > canvas.height || bird.y < 0) triggerGameOver();

        pipes = pipes.filter(p => p.x > -100);
        animationId = requestAnimationFrame(gameLoop);
    }

    function triggerGameOver() {
        if (!gameActive) return; // Zaten bittiyse tekrar √ßalƒ±≈üma (Sonsuz loop engeli)
        gameActive = false;
        cancelAnimationFrame(animationId);

        hearts--;
        if (score > dailyBest) dailyBest = score;
        if (score > allTimeBest) allTimeBest = score;

        // UI G√ºncelleme
        document.getElementById('heart-val').innerText = hearts;
        document.getElementById('daily-ui').innerText = dailyBest;
        document.getElementById('record-ui').innerText = allTimeBest;
        
        // Modal G√ºncelleme
        document.getElementById('final-score').innerText = score;
        document.getElementById('modal-daily').innerText = dailyBest;
        document.getElementById('modal-record').innerText = allTimeBest;
        
        document.getElementById('death-screen').style.display = 'flex';
    }

    function closeDeathScreen() {
        document.getElementById('death-screen').style.display = 'none';
        document.getElementById('game-ui').style.display = 'none';
        gameActive = false;
    }

    document.getElementById('play-btn').addEventListener('click', () => {
        if (hearts <= 0) { alert("Hakkƒ±n bitti!"); return; }
        
        // Reset
        score = 0;
        pipes = [];
        bird.y = 300;
        bird.v = 0;
        gameActive = true;
        
        document.getElementById('live-score').innerText = "0";
        document.getElementById('game-ui').style.display = 'block';
        document.getElementById('game-canvas').style.display = 'block';
        
        gameLoop();
    });

    window.addEventListener('touchstart', (e) => {
        if (gameActive) {
            e.preventDefault();
            bird.v = -bird.j;
        }
    });
</script>
</body>
</html>

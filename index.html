<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SpyderCoin - Elite Edition V9</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://adexora.com/cdn/ads.js?id=1545"></script>

    <style>
        /* --- CSS VARIABLES & THEME --- */
        :root {
            --p-purple: #a855f7;
            --p-dark: #7e22ce;
            --bg: #000000;
            --card: #0f0f12;
            --card-brd: #1a1a1f;
            --text: #ffffff;
            --dim: #71717a;
            --green: #10b981;
            --red: #ef4444;
            --gold: #fbbf24;
            --safe-top: env(safe-area-inset-top);
        }

        /* --- BASE STYLES --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* --- LOADING SCREEN --- */
        #loader { 
            position: fixed; inset: 0; background: #000; z-index: 99999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #222; border-top-color: var(--p-purple); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- LAYOUT --- */
        main { flex: 1; overflow-y: auto; padding-bottom: 100px; position: relative; }
        .view { display: none; padding: 20px; flex-direction: column; animation: slideUp 0.3s ease-out; }
        .view.active { display: flex; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- UI COMPONENTS --- */
        .card { 
            background: var(--card); border: 1px solid var(--card-brd); 
            border-radius: 20px; padding: 18px; margin-bottom: 15px; 
            transition: transform 0.2s; 
        }
        .card:active { transform: scale(0.98); }

        .bal-txt { font-size: 54px; font-weight: 900; color: var(--p-purple); text-align: center; margin: 20px 0; text-shadow: 0 0 20px rgba(168, 85, 247, 0.2); }
        
        /* --- MAIN SPYDER BUTTON --- */
        .click-area { position: relative; display: flex; justify-content: center; margin: 30px 0; }
        .spyder-btn { 
            width: 220px; height: 220px; background: radial-gradient(circle, #c084fc, #a855f7); 
            border-radius: 50%; display: flex; justify-content: center; align-items: center; 
            box-shadow: 0 0 40px rgba(168, 85, 247, 0.4); cursor: pointer; border: 8px solid rgba(255,255,255,0.15); 
            transition: 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .spyder-btn:active { transform: scale(0.90) rotate(5deg); }
        .spyder-btn span { font-size: 100px; pointer-events: none; user-select: none; }

        /* --- PROGRESS BARS --- */
        .prog-bg { height: 10px; background: #1a1a1f; border-radius: 5px; overflow: hidden; margin-top: 10px; }
        .prog-fill { height: 100%; background: var(--p-purple); width: 0%; transition: width 0.3s; }

        /* --- BUTTONS & INPUTS --- */
        .btn-main { 
            width: 100%; padding: 16px; border-radius: 14px; border: none; 
            background: linear-gradient(90deg, var(--p-purple), var(--p-dark)); 
            color: #fff; font-weight: 700; font-size: 15px; cursor: pointer; 
        }
        .btn-main:disabled { background: #27272a; color: #52525b; cursor: not-allowed; }
        
        input { 
            width: 100%; padding: 15px; background: #050505; border: 1px solid var(--card-brd); 
            color: #fff; border-radius: 12px; margin: 10px 0; text-align: center; font-size: 16px;
        }

        /* --- ADMIN SPECIFIC --- */
        .admin-stat-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .user-node { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px; background: #111114; border-bottom: 1px solid #1a1a1f; 
        }
        
        /* --- MODAL --- */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); 
            backdrop-filter: blur(5px); z-index: 10000; display: none; 
            align-items: center; justify-content: center; padding: 20px; 
        }
        .modal-box { 
            background: var(--card); border: 1px solid var(--p-purple); 
            width: 100%; max-width: 400px; border-radius: 24px; padding: 25px; 
        }

        /* --- NAVBAR --- */
        nav { 
            position: fixed; bottom: 0; width: 100%; height: 85px; 
            background: rgba(5, 5, 5, 0.95); backdrop-filter: blur(10px);
            display: flex; border-top: 1px solid var(--card-brd); z-index: 5000; 
        }
        .nav-link { 
            flex: 1; display: flex; flex-direction: column; align-items: center; 
            justify-content: center; color: var(--dim); transition: 0.3s;
        }
        .nav-link.active { color: var(--p-purple); }
        .nav-link i { font-size: 22px; margin-bottom: 4px; font-style: normal; }
        .nav-link span { font-size: 11px; font-weight: 600; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top:15px; color:var(--dim); font-size:12px; letter-spacing:1px;">SPYDER NETWORK LOAD...</p>
    </div>

    <div class="modal-overlay" id="user-modal">
        <div class="modal-box">
            <h3 id="mdl-title" style="margin-bottom:15px;">Kullanƒ±cƒ± Profili</h3>
            <div id="mdl-body"></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">
                <button class="btn-main" style="background:var(--red);" onclick="Admin.action('ban')">BAN</button>
                <button class="btn-main" style="background:var(--dim);" onclick="Admin.close()">KAPAT</button>
            </div>
        </div>
    </div>

    <main>
        <section id="v-play" class="view active">
            <div class="bal-txt" id="ui-bal">0</div>
            <div class="click-area">
                <div class="spyder-btn" onclick="Game.tap(event)"><span>üï∑Ô∏è</span></div>
            </div>
            <div class="card" style="margin-top:auto;">
                <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--dim)">
                    <span>ENERJƒ∞ G√úC√ú</span>
                    <span id="ui-nrg-text">1000 / 1000</span>
                </div>
                <div class="prog-bg"><div id="ui-nrg-bar" class="prog-fill" style="width:100%"></div></div>
            </div>
        </section>

        <section id="v-tasks" class="view">
            <h2 style="margin-bottom:20px;">Sosyal G√∂revler</h2>
            <div id="task-list">
                </div>
        </section>

        <section id="v-vault" class="view">
            <h2 style="margin-bottom:10px;">Spyder Vault</h2>
            <p style="color:var(--dim); font-size:13px; margin-bottom:20px;">Spyder birimlerinizi USDT'ye d√∂n√º≈üt√ºr√ºn.</p>
            <div class="card">
                <label style="font-size:11px; color:var(--p-purple)">D√ñN√ú≈ûT√úR√úLECEK Mƒ∞KTAR</label>
                <input type="number" id="swap-in" value="10000" oninput="Finance.preview()">
                <div style="text-align:center; padding:10px;">‚¨áÔ∏è</div>
                <div class="card" style="background:#000; text-align:center; border:1px dashed #333;">
                    <small style="color:var(--dim)">ALACAƒûINIZ TUTAR</small>
                    <div style="font-size:24px; color:var(--green); font-weight:bold;">$<span id="swap-out">0.10</span></div>
                </div>
                <button class="btn-main" onclick="Finance.executeSwap()">ONAYLA VE D√ñN√ú≈ûT√úR</button>
            </div>
        </section>

        <section id="v-wallet" class="view">
            <h2 style="margin-bottom:20px;">C√ºzdanƒ±m</h2>
            <div class="card" style="text-align:center; background: linear-gradient(145deg, #0f0f12, #1a1a1f);">
                <small style="color:var(--dim)">√áEKƒ∞LEBƒ∞Lƒ∞R BAKƒ∞YE</small>
                <h1 style="font-size:40px; color:var(--green);">$<span id="ui-usdt">0.000</span></h1>
            </div>
            <div class="card">
                <input type="number" id="withdraw-amt" value="0.10" step="0.01" oninput="UI.update()">
                <div style="display:flex; justify-content:space-between; margin:10px 0; font-size:12px;">
                    <span color="var(--dim)">Reklam Durumu:</span>
                    <b id="ui-ad-count" style="color:var(--gold)">0 / 15</b>
                </div>
                <input type="text" id="withdraw-addr" placeholder="BEP20 (BSC) Adresi">
                <button id="btn-withdraw" class="btn-main" onclick="Finance.requestWithdraw()">√ñDEME TALEBƒ∞ G√ñNDER</button>
            </div>
        </section>

        <section id="v-admin" class="view">
            <h2 style="color:var(--p-purple); margin-bottom:20px;">Sistem Y√∂netimi</h2>
            <div class="admin-stat-row">
                <div class="stat-box card" style="margin:0">
                    <small>TOPLAM √úYE</small>
                    <div id="adm-total-u" style="font-size:20px; font-weight:bold;">0</div>
                </div>
                <div class="stat-box card" style="margin:0">
                    <small>TOPLAM REKLAM</small>
                    <div id="adm-total-a" style="font-size:20px; font-weight:bold;">0</div>
                </div>
            </div>
            
            <h4 style="margin-bottom:10px; color:var(--gold)">üí∞ Bekleyen √ñdemeler</h4>
            <div id="adm-requests" style="margin-bottom:20px;"></div>

            <h4 style="margin-bottom:10px;">üë• Kullanƒ±cƒ±lar (Detay i√ßin tƒ±kla)</h4>
            <div id="adm-users" class="card" style="padding:0; overflow:hidden;"></div>
        </section>
    </main>

    <nav id="nav-bar">
        <div class="nav-link active" onclick="UI.nav('v-play', this)"><i>üéÆ</i><span>Oyna</span></div>
        <div class="nav-link" onclick="UI.nav('v-tasks', this)"><i>üì¢</i><span>G√∂rev</span></div>
        <div class="nav-link" onclick="UI.nav('v-vault', this)"><i>üèõÔ∏è</i><span>Vault</span></div>
        <div class="nav-link" onclick="UI.nav('v-wallet', this)"><i>üí∞</i><span>C√ºzdan</span></div>
    </nav>

    <script>
        /* --- CORE CONFIGURATION --- */
        const ADMIN_ID = "8392479231";
        const FB_CONFIG = { 
            apiKey: "AIzaSyC18uinYQT9vOC-nhxv3x1WIhO_we3CRMY", 
            authDomain: "pdfkaynak-51615.firebaseapp.com", 
            projectId: "pdfkaynak-51615", 
            appId: "1:228512804576:web:a0bba02ca83b4fa7adea85" 
        };

        firebase.initializeApp(FB_CONFIG);
        const db = firebase.firestore();
        const tg = window.Telegram.WebApp;
        tg.expand();

        /* --- STATE MANAGEMENT --- */
        let state = {
            user: {
                bal: 0, nrg: 1000, usdt: 0, ads: 0, totalAds: 0,
                tasks: [], isBanned: false, paymentNotif: false,
                name: "User", username: "unknown"
            },
            uid: "dev",
            selectedUser: null,
            lastSave: 0
        };

        /* --- INITIALIZATION --- */
        const App = {
            init: async () => {
                state.uid = tg.initDataUnsafe?.user?.id?.toString() || "dev";
                state.user.name = tg.initDataUnsafe?.user?.first_name || "Spyder";
                state.user.username = tg.initDataUnsafe?.user?.username || "user";

                try {
                    const doc = await db.collection("users").doc(state.uid).get();
                    if(doc.exists) {
                        state.user = { ...state.user, ...doc.data() };
                        
                        // √ñdeme Bildirimi Kontrol√º
                        if(state.user.paymentNotif) {
                            tg.showAlert("üåü M√ºjde! √ñdemeniz ba≈üarƒ±yla tamamlandƒ±. C√ºzdanƒ±nƒ±zƒ± kontrol edin.");
                            await db.collection("users").doc(state.uid).update({ paymentNotif: false });
                        }
                    } else {
                        await App.save(true);
                    }

                    if(state.uid === ADMIN_ID) {
                        const adminBtn = `<div class="nav-link" onclick="UI.nav('v-admin', this); Admin.init();"><i>üîë</i><span>Admin</span></div>`;
                        document.getElementById('nav-bar').innerHTML += adminBtn;
                    }

                    document.getElementById('loader').style.display = 'none';
                    UI.init();
                    Game.loop();
                } catch (err) {
                    console.error("Init error:", err);
                }
            },

            save: async (force = false) => {
                const now = Date.now();
                if(!force && now - state.lastSave < 5000) return; 
                state.lastSave = now;
                await db.collection("users").doc(state.uid).set(state.user, { merge: true });
            }
        };

        /* --- GAME LOGIC --- */
        const Game = {
            tap: (e) => {
                if(state.user.isBanned) return tg.showAlert("Hesabƒ±nƒ±z kƒ±sƒ±tlanmƒ±≈ütƒ±r.");
                if(state.user.nrg <= 0) return tg.HapticFeedback.notificationOccurred('error');

                state.user.bal += 1;
                state.user.nrg -= 1;
                
                // Visual Effect
                const x = e.clientX || e.touches[0].clientX;
                const y = e.clientY || e.touches[0].clientY;
                UI.createPop(x, y);

                // Ad Logic
                if(state.user.bal % 30 === 0) Game.checkAd();
                
                UI.update();
            },

            checkAd: () => {
                if(window.showAdexora) {
                    window.showAdexora().then(() => {
                        state.user.ads++;
                        state.user.totalAds++;
                        App.save(true);
                        UI.update();
                    });
                }
            },

            loop: () => {
                setInterval(() => {
                    if(state.user.nrg < 1000) {
                        state.user.nrg = Math.min(1000, state.user.nrg + 3);
                        UI.update();
                    }
                }, 3000);
            }
        };

        /* --- FINANCE & SWAP --- */
        const Finance = {
            preview: () => {
                const val = document.getElementById('swap-in').value || 0;
                document.getElementById('swap-out').innerText = (val * 0.00001).toFixed(2);
            },

            executeSwap: async () => {
                const amt = parseInt(document.getElementById('swap-in').value);
                if(state.user.bal < amt) return tg.showAlert("Yetersiz Spyder bakiyesi!");
                
                state.user.bal -= amt;
                state.user.usdt += (amt * 0.00001);
                
                tg.HapticFeedback.impactOccurred('medium');
                await App.save(true);
                UI.update();
                tg.showAlert("D√∂n√º≈ü√ºm ba≈üarƒ±yla tamamlandƒ±!");
            },

            requestWithdraw: async () => {
                const amt = parseFloat(document.getElementById('withdraw-amt').value);
                const adr = document.getElementById('withdraw-addr').value;
                const reqAds = Math.max(15, Math.ceil(amt / 0.01) * 15);

                if(state.user.usdt < amt) return tg.showAlert("Bakiye yetersiz!");
                if(state.user.ads < reqAds) return tg.showAlert(`Bu √ßekim i√ßin en az ${reqAds} reklam izlemelisiniz.`);
                if(adr.length < 10) return tg.showAlert("Ge√ßerli bir BEP20 adresi girin!");

                await db.collection("withdrawals").add({
                    uid: state.uid,
                    name: state.user.name,
                    username: state.user.username,
                    amount: amt,
                    address: adr,
                    status: "pending",
                    date: new Date().toISOString()
                });

                state.user.usdt -= amt;
                state.user.ads = 0; // RESET FOR USER
                await App.save(true);
                UI.update();
                tg.showAlert("Talebiniz iletildi. Sayacƒ±nƒ±z yeni √ßekim i√ßin sƒ±fƒ±rlandƒ±!");
            }
        };

        /* --- ADMIN CONTROLS --- */
        const Admin = {
            init: async () => {
                const snap = await db.collection("users").get();
                let tAds = 0;
                const userList = document.getElementById('adm-users');
                userList.innerHTML = "";

                snap.forEach(doc => {
                    const d = doc.data();
                    tAds += (d.totalAds || 0);
                    
                    const el = document.createElement('div');
                    el.className = 'user-node';
                    el.innerHTML = `<span>${d.name}</span> <small style="color:var(--dim)">@${d.username}</small>`;
                    el.onclick = () => Admin.showUser(doc.id, d);
                    userList.appendChild(el);
                });

                document.getElementById('adm-total-u').innerText = snap.size;
                document.getElementById('adm-total-a').innerText = tAds.toLocaleString();
                Admin.loadRequests();
            },

            loadRequests: async () => {
                const snap = await db.collection("withdrawals").where("status","==","pending").get();
                const div = document.getElementById('adm-requests');
                div.innerHTML = snap.empty ? '<p style="font-size:12px; color:var(--dim)">Bekleyen talep yok.</p>' : "";
                
                snap.forEach(doc => {
                    const r = doc.data();
                    div.innerHTML += `
                        <div class="card" style="font-size:13px">
                            <b>${r.name}</b>: <span style="color:var(--green)">$${r.amount}</span><br>
                            <small>${r.address}</small><br>
                            <button class="btn-main" style="margin-top:10px; padding:8px; font-size:12px;" onclick="Admin.pay('${doc.id}','${r.uid}')">√ñDENDƒ∞ ƒ∞≈ûARETLE</button>
                        </div>`;
                });
            },

            showUser: (id, d) => {
                state.selectedUser = { id, ...d };
                document.getElementById('mdl-title').innerText = d.name;
                document.getElementById('mdl-body').innerHTML = `
                    <div style="font-size:13px; line-height:2">
                        Bakiye: <b>${d.bal}</b><br>
                        USDT: <b>$${d.usdt.toFixed(2)}</b><br>
                        Toplam Reklam: <b>${d.totalAds || 0}</b><br>
                        Ban Durumu: <b>${d.isBanned ? 'BANLI' : 'TEMƒ∞Z'}</b>
                    </div>`;
                document.getElementById('user-modal').style.display = 'flex';
            },

            action: async (type) => {
                if(type === 'ban') {
                    const n = !state.selectedUser.isBanned;
                    await db.collection("users").doc(state.selectedUser.id).update({ isBanned: n });
                    tg.showAlert(n ? "Banlandƒ±" : "Ban Kaldƒ±rƒ±ldƒ±");
                    Admin.close();
                    Admin.init();
                }
            },

            pay: async (docId, uId) => {
                await db.collection("withdrawals").doc(docId).update({ status: "completed" });
                await db.collection("users").doc(uId).update({ paymentNotif: true });
                tg.showAlert("Onaylandƒ±!");
                Admin.init();
            },

            close: () => { document.getElementById('user-modal').style.display = 'none'; }
        };

        /* --- UI UTILS --- */
        const UI = {
            init: () => {
                Finance.preview();
                UI.update();
            },

            update: () => {
                document.getElementById('ui-bal').innerText = Math.floor(state.user.bal).toLocaleString();
                document.getElementById('ui-nrg-text').innerText = `${state.user.nrg} / 1000`;
                document.getElementById('ui-nrg-bar').style.width = (state.user.nrg / 10) + "%";
                document.getElementById('ui-usdt').innerText = state.user.usdt.toFixed(3);
                
                const wAmt = parseFloat(document.getElementById('withdraw-amt').value) || 0;
                const req = Math.max(15, Math.ceil(wAmt / 0.01) * 15);
                document.getElementById('ui-ad-count').innerText = `${state.user.ads} / ${req}`;
                document.getElementById('btn-withdraw').disabled = (state.user.ads < req || state.user.usdt < wAmt);
            },

            nav: (id, el) => {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                el.classList.add('active');
            },

            createPop: (x, y) => {
                const p = document.createElement('div');
                p.innerText = "+1";
                p.style.cssText = `position:fixed; left:${x}px; top:${y}px; color:var(--p-purple); font-weight:bold; pointer-events:none; z-index:9999; animation: fly 0.6s forwards;`;
                document.body.appendChild(p);
                setTimeout(() => p.remove(), 600);
            }
        };

        /* CSS for dynamic elements */
        const style = document.createElement('style');
        style.innerHTML = `@keyframes fly { to { transform: translateY(-50px); opacity: 0; } }`;
        document.head.appendChild(style);

        App.init();
    </script>
</body>
</html>

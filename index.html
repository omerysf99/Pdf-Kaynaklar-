<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoTube Pro - IndexedDB & Shorts</title>
    <style>
        :root { --yt-red: #ff0000; --yt-bg: #fff; --yt-text: #0f0f0f; --yt-secondary: #606060; --yt-hover: #f2f2f2; }
        body { font-family: "Roboto", sans-serif; margin: 0; background: var(--yt-bg); color: var(--yt-text); overflow-x: hidden; }
        
        /* Layout */
        header { position: fixed; top: 0; width: 100%; height: 56px; background: white; display: flex; justify-content: space-between; align-items: center; padding: 0 16px; z-index: 2000; border-bottom: 1px solid #eee; }
        nav { position: fixed; top: 56px; left: 0; width: 240px; height: calc(100vh - 56px); background: white; padding-top: 12px; z-index: 1000; border-right: 1px solid #eee; }
        main { margin-top: 56px; margin-left: 240px; padding: 24px; }
        
        .nav-item { padding: 10px 24px; display: flex; align-items: center; gap: 24px; cursor: pointer; font-size: 14px; }
        .nav-item:hover { background: var(--yt-hover); }
        .nav-item.active { background: var(--yt-hover); font-weight: bold; }

        /* Sections */
        section { margin-bottom: 40px; }
        h2 { font-size: 20px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }

        /* Grid System */
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px; }
        .shorts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; }

        /* Cards */
        .video-card { cursor: pointer; }
        .thumb-box { width: 100%; aspect-ratio: 16/9; background: #eee; border-radius: 12px; overflow: hidden; }
        .shorts-card { cursor: pointer; }
        .shorts-thumb { width: 100%; aspect-ratio: 9/16; background: #ddd; border-radius: 12px; overflow: hidden; position: relative; }
        img { width: 100%; height: 100%; object-fit: cover; }

        /* Upload Area */
        .upload-zone { background: #f9f9f9; border: 2px dashed #ddd; border-radius: 12px; padding: 20px; text-align: center; margin-bottom: 30px; }
        .btn-upload { background: #0f0f0f; color: white; border: none; padding: 10px 24px; border-radius: 20px; cursor: pointer; font-weight: 500; }

        /* Player Overlay */
        #playerOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 3000; display: none; overflow-y: auto; }
        .player-content { max-width: 1000px; margin: 40px auto; padding: 20px; position: relative; }
        .close-btn { position: absolute; top: 0; right: 0; font-size: 30px; cursor: pointer; }
        video { width: 100%; border-radius: 12px; background: #000; }
        
        .is-shorts-player { max-width: 400px !important; } /* Shorts i√ßin dikey oynatƒ±cƒ± */

        @media (max-width: 800px) { nav { display: none; } main { margin-left: 0; } }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:15px;">
        <div style="cursor:pointer">‚ò∞</div>
        <a href="#" style="color:var(--yt-red); font-weight:bold; text-decoration:none; font-size:20px;">VideoTube</a>
    </div>
    <div style="font-size: 12px; color: var(--yt-secondary)">Admin ID: 8392479231</div>
</header>

<nav>
    <div class="nav-item active">üè† Ana Sayfa</div>
    <div class="nav-item">ü©≥ Shorts</div>
    <div class="nav-item">üì∫ Abonelikler</div>
</nav>

<main>
    <div class="upload-zone">
        <h3>Video Y√ºkle</h3>
        <p style="font-size:13px; color:#606060">&lt; 60s videolar otomatik Shorts kategorisine girer.</p>
        <input type="file" id="vInput" accept="video/*" style="display:none">
        <button class="btn-upload" onclick="document.getElementById('vInput').click()">DOSYA SE√á</button>
        <div id="upStatus" style="margin-top:10px; font-size:12px; color:blue"></div>
    </div>

    <section>
        <h2>üì∫ Uzun Videolar</h2>
        <div id="longVideosGrid" class="video-grid"></div>
    </section>

    <section>
        <h2>ü©≥ Shorts</h2>
        <div id="shortsGrid" class="shorts-grid"></div>
    </section>
</main>

<div id="playerOverlay">
    <div class="player-content" id="pContent">
        <span class="close-btn" onclick="closePlayer()">√ó</span>
        <video id="vPlayer" controls autoplay></video>
        <h2 id="pTitle" style="margin-top:15px;"></h2>
    </div>
</div>

<script>
    const DB_NAME = 'VideoPlatformDB';
    const STORE_NAME = 'videos';
    let db;

    // 1. INDEXEDDB BAƒûLANTISI (Tek Kaynak)
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = (e) => {
        db = e.target.result;
        if(!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: 'id' });
        }
    };
    req.onsuccess = (e) => {
        db = e.target.result;
        refreshUI();
    };

    // 2. Vƒ∞DEO Y√úKLEME VE S√úRE ANALƒ∞Zƒ∞
    document.getElementById('vInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(!file) return;

        const status = document.getElementById('upStatus');
        status.textContent = "Analiz ediliyor ve kaydediliyor...";

        // Video s√ºresini al
        const duration = await getVideoDuration(file);
        const isShorts = duration < 60;

        // Thumbnail olu≈ütur
        const thumb = await createThumbnail(file, isShorts);

        const videoEntry = {
            id: crypto.randomUUID(),
            title: file.name.split('.')[0],
            data: file, // BLOB
            thumb: thumb, // BLOB
            isShorts: isShorts,
            duration: duration,
            timestamp: Date.now()
        };

        const tx = db.transaction(STORE_NAME, 'readwrite');
        tx.objectStore(STORE_NAME).add(videoEntry);
        tx.oncomplete = () => {
            status.textContent = "‚úÖ " + (isShorts ? "Shorts" : "Video") + " olarak kaydedildi.";
            refreshUI();
        };
    });

    function getVideoDuration(file) {
        return new Promise(resolve => {
            const v = document.createElement('video');
            v.preload = 'metadata';
            v.src = URL.createObjectURL(file);
            v.onloadedmetadata = () => {
                URL.revokeObjectURL(v.src);
                resolve(v.duration);
            };
        });
    }

    async function createThumbnail(file, isShorts) {
        return new Promise(resolve => {
            const v = document.createElement('video');
            v.src = URL.createObjectURL(file);
            v.onloadeddata = () => v.currentTime = 0.5;
            v.onseeked = () => {
                const c = document.createElement('canvas');
                // Shorts i√ßin 9:16, Uzun i√ßin 16:9 oranƒ±nda crop
                if(isShorts) { c.width = 360; c.height = 640; } 
                else { c.width = 640; c.height = 360; }
                c.getContext('2d').drawImage(v, 0, 0, c.width, c.height);
                c.toBlob(b => { URL.revokeObjectURL(v.src); resolve(b); }, 'image/jpeg');
            };
        });
    }

    // 3. ARAY√úZ√ú YENƒ∞LEME (Kalƒ±cƒ± Veriden √áekme)
    let blobURLs = [];
    function refreshUI() {
        const longGrid = document.getElementById('longVideosGrid');
        const shortsGrid = document.getElementById('shortsGrid');
        
        longGrid.innerHTML = '';
        shortsGrid.innerHTML = '';
        blobURLs.forEach(u => URL.revokeObjectURL(u));
        blobURLs = [];

        const tx = db.transaction(STORE_NAME, 'readonly');
        tx.objectStore(STORE_NAME).getAll().onsuccess = (e) => {
            const allVideos = e.target.result.sort((a,b) => b.timestamp - a.timestamp);

            allVideos.forEach(vid => {
                const tUrl = URL.createObjectURL(vid.thumb);
                const vUrl = URL.createObjectURL(vid.data);
                blobURLs.push(tUrl, vUrl);

                if(vid.isShorts) {
                    const card = document.createElement('div');
                    card.className = 'shorts-card';
                    card.innerHTML = `<div class="shorts-thumb"><img src="${tUrl}"></div><p style="font-size:14px;font-weight:bold;margin-top:8px">${vid.title}</p>`;
                    card.onclick = () => openPlayer(vUrl, vid.title, true);
                    shortsGrid.appendChild(card);
                } else {
                    const card = document.createElement('div');
                    card.className = 'video-card';
                    card.innerHTML = `<div class="thumb-box"><img src="${tUrl}"></div><h3 style="font-size:15px;margin:10px 0 5px">${vid.title}</h3><p style="color:#606060;font-size:12px">Admin ID: 8392479231</p>`;
                    card.onclick = () => openPlayer(vUrl, vid.title, false);
                    longGrid.appendChild(card);
                }
            });
        };
    }

    // 4. OYNATICI KONTROL√ú
    function openPlayer(url, title, isShorts) {
        const overlay = document.getElementById('playerOverlay');
        const content = document.getElementById('pContent');
        const player = document.getElementById('vPlayer');
        
        if(isShorts) {
            content.classList.add('is-shorts-player');
            player.style.aspectRatio = "9/16";
        } else {
            content.classList.remove('is-shorts-player');
            player.style.aspectRatio = "16/9";
        }

        document.getElementById('pTitle').textContent = title;
        player.src = url;
        overlay.style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function closePlayer() {
        const player = document.getElementById('vPlayer');
        player.pause();
        player.src = "";
        document.getElementById('playerOverlay').style.display = 'none';
        document.body.style.overflow = 'auto';
    }
</script>

</body>
</html>
